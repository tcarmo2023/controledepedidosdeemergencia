<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>üìÑ Controle de Pedidos de Emerg√™ncia - NORMAQ JCB</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --gray-color: #95a5a6;
            --sidebar-width: 250px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding-bottom: 140px;
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('./Nova pasta/JCB Maq.jpg');
            background-size: cover;
            background-position: center;
        }
        
        .login-box {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 400px;
            padding: 30px;
            text-align: center;
        }
        
        .logo {
            max-width: 200px;
            margin-bottom: 20px;
        }
        
        .login-title {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--secondary-color);
            outline: none;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-info {
            background-color: var(--gray-color);
            color: white;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-info:hover {
            background-color: #7f8c8d;
        }
        
        .support-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .status-pendente { color: #c0392b; font-weight: 700; }
        @keyframes bellBlink { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.35; transform: scale(1.06); } 100% { opacity: 1; transform: scale(1); } }
        #delete-notify.bell-blink { animation: bellBlink 1s infinite; }
        #requester-notify.bell-blink { animation: bellBlink 1s infinite; }
        .toast-notice { position: absolute; right: 0; top: calc(100% + 6px); z-index: 1100; background: #fff8e6; border: 1px solid #f1c40f; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); padding: 12px 14px; min-width: 280px; }
        .toast-notice h4 { margin: 0 0 6px 0; color: #8a6d3b; font-size: 16px; }
        .toast-notice p { margin: 0 0 10px 0; color: #7f8c8d; }
        .toast-actions { display: flex; gap: 8px; justify-content: flex-end; }
        
        .support-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .support-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .support-info {
            margin-bottom: 20px;
        }
        
        .support-info p {
            margin-bottom: 10px;
        }
        
        .support-info strong {
            color: var(--secondary-color);
        }
        
        .close-btn {
            background-color: var(--gray-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }
        
        /* Main Dashboard */
        .dashboard-container {
            display: none;
            background-color: var(--primary-color);
        }
        
        .header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
        
        .header-logo {
            max-width: 150px;
            margin-right: 20px;
        }
        
        .header-title {
            color: var(--primary-color);
            font-size: 22px;
            font-weight: 600;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            position: relative;
        }

        .dash-filters { margin: 16px 0; }
        .dash-cards { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin: 16px 0; }
        .dash-card { background: #fff; border-left: 6px solid var(--primary-color); border-radius: 8px; padding: 14px 14px 14px 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform .2s ease, box-shadow .2s ease; }
        .dash-card:hover { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0,0,0,0.15); }
        .dash-card-header { display:flex; align-items:center; gap:10px; }
        .dash-card-title { font-size: 14px; font-weight: 600; color: #333; }
        .dash-card-icon { width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:16px; animation: dashPulse 1.8s ease-in-out infinite; }
        .dash-card-icon.total { background: linear-gradient(135deg, #4aa3ff, #1f7ae0); }
        .dash-card-icon.valor { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .dash-card-icon.custo { background: linear-gradient(135deg, #f1c40f, #f39c12); }
        .dash-card-icon.atendimento { background: linear-gradient(135deg, #8e44ad, #6c3483); }
        .dash-card-icon.emergencia { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        @keyframes dashPulse { 0% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(1.08); filter: brightness(1.1); } 100% { transform: scale(1); filter: brightness(1); } }
        .dash-card-value { font-size: 22px; font-weight: 700; color: var(--primary-color); margin-top: 6px; }
        .dash-card-delta { font-size: 12px; margin-top: 6px; }
        .delta-positive { color: #0b7c2d; font-weight: 600; }
        .delta-negative { color: #b00020; font-weight: 600; }
        .delta-muted { color: #666; }
        .dash-section { margin-top: 18px; }
        .chart-container { background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .bar-row { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
        .bar-label { width: 120px; font-size: 13px; color: #333; }
        .bar { height: 16px; background: var(--secondary-color); border-radius: 4px; position: relative; color: #fff; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; font-size: 12px; }
        .bar-value { width: 80px; text-align: right; font-size: 12px; color: #333; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .user-info {
            margin-right: 20px;
            color: var(--dark-color);
        }
        
        .logout-btn {
            background-color: var(--danger-color);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .main-content {
            display: flex;
            min-height: calc(100vh - 80px);
            background-color: var(--primary-color);
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .menu-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
        }
        
        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .menu-item.active {
            background-color: var(--secondary-color);
        }
        
        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background-color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 24px;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }
        .sign-positive { color: var(--success-color); font-weight: 600; }
        .sign-negative { color: var(--danger-color); font-weight: 600; }
        
        /* Filters */
        .filters {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .filter-select, .filter-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .filter-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Data Table */
        .data-table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 8px 10px;
            text-align: center;
            vertical-align: middle;
            font-weight: 600;
        }
        #orders-table thead th, #consultant-table thead th, #arrival-table thead th { position: sticky; top: 0; z-index: 2; }
        #arrival-table th, #arrival-table td { text-align: center; }
        
        .data-table td {
            padding: 6px 10px;
            border-bottom: 1px solid #eee;
            text-align: center;
            vertical-align: middle;
        }
        .bo-inline { white-space: nowrap; }
        .nowrap-cell { white-space: nowrap; }
        .table-compact .data-table td { padding: 4px 8px; }
        .table-expanded .data-table td { padding: 14px 20px; }
        
        .data-table tr:hover {
            background-color: #f9f9f9;
        }
        
        /* Form Styles */
        .form-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-field {
            flex: 1;
            min-width: 200px;
        }
        
        .form-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .auto-calc {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Footer */
        .footer {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: 0;
        }
        .footer-fixed { position: fixed; left: 0; right: 0; bottom: 0; width: 100vw; z-index: 10; }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
        }

        /* Avoid overlap with fixed footer */
        .content-area { padding-bottom: 20px; }
        
        .footer-links a {
            color: white;
            text-decoration: none;
        }
        
        .footer-links a:hover {
            text-decoration: underline;
        }
        
        .footer-copyright {
            font-size: 14px;
            margin-top: 10px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
        }

        #admin-tab #admin-submenu { display:flex; gap:8px; margin:12px 0; flex-wrap:wrap; }
        #admin-tab #admin-submenu .btn { width:auto; padding:6px 12px; border-radius:8px; font-weight:600; font-size:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); transition:transform .16s ease, box-shadow .16s ease; }
        #admin-tab #admin-submenu .btn:hover { transform:translateY(-1px); box-shadow:0 2px 6px rgba(0,0,0,.12); }
        #admin-tab .admin-sub-content { display:none; opacity:0; transform:translateY(6px); transition:opacity .18s ease, transform .18s ease; }
        #admin-tab .admin-sub-content.show { display:block; opacity:1; transform:translateY(0); }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <img src="./Nova pasta/Imagem5.png" alt="NORMAQ JCB Logo" class="logo">
            <h1 class="login-title">Controle de Pedidos de Emerg√™ncia</h1>
            
            <div class="form-group">
                <label for="username">Usu√°rio</label>
                <input type="text" id="username" class="form-control" placeholder="Digite seu usu√°rio">
            </div>
            
            <div class="form-group">
                <label for="password">Senha</label>
                <input type="password" id="password" class="form-control" placeholder="Digite sua senha">
            </div>
            
            <button class="btn btn-primary" id="loginBtn" type="button" onclick="try{window.performLogin()}catch(e){alert('Erro ao entrar: '+e)}">Entrar</button>
            <button class="btn btn-info" id="infoBtn">Informa√ß√µes</button>
        </div>
    </div>
    <script>
        window.performLogin = async function() {
            try {
                const username = document.getElementById('username')?.value || '';
                const password = document.getElementById('password')?.value || '';
                if (!username || !password) { alert('Por favor, preencha usu√°rio e senha.'); return; }
                const loginScreen = document.getElementById('loginScreen');
                const dashboard = document.getElementById('dashboard');
                const userInfo = document.getElementById('userInfo');
                const loginFooter = document.getElementById('login-footer');
                const offlineUser = { id: 'local', username, is_admin: true };
                window.currentUser = offlineUser;
                localStorage.setItem('currentUser', JSON.stringify(offlineUser));
                if (userInfo) userInfo.textContent = `Usu√°rio: ${offlineUser.username}`;
                if (loginScreen) loginScreen.style.display = 'none';
                if (dashboard) dashboard.style.display = 'block';
                if (loginFooter) loginFooter.style.display = 'none';
                if (typeof applyPermissions === 'function') applyPermissions();
                if (typeof loadOrders === 'function') loadOrders();
                if (typeof loadConsultantData === 'function') loadConsultantData();
                if (typeof loadDashboard === 'function') loadDashboard();
                if (typeof loadUsersForAdmin === 'function') loadUsersForAdmin();
                return;
            } catch (e) { alert('Erro ao fazer login.'); }
        };
    </script>
    <div class="support-modal" id="editModal">
        <div class="support-content" style="max-width:900px; width: 90%;">
            <h2 class="support-title">Editar Pedido</h2>
            <div class="form-container">
                <div class="form-row">
                    <div class="form-field"><label for="edit_revenda">Revenda</label><input id="edit_revenda" class="form-control" type="text"></div>
                    <div class="form-field"><label for="edit_numero_pedido">N¬∫ Pedido</label><input id="edit_numero_pedido" class="form-control" type="text"></div>
                    <div class="form-field"><label for="edit_fornecedor">Fornecedor</label><input id="edit_fornecedor" class="form-control" type="text"></div>
                </div>

                

                
                <div class="form-row">
                    <div class="form-field"><label for="edit_data_pedido">Data</label><input id="edit_data_pedido" class="form-control" type="date"></div>
                    <div class="form-field"><label for="edit_cliente">Cliente</label><input id="edit_cliente" class="form-control" type="text"></div>
                    <div class="form-field"><label for="edit_ctt_orc">CTT/ORC</label><input id="edit_ctt_orc" class="form-control" type="number"></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label for="edit_part_number">Part Number</label><input id="edit_part_number" class="form-control" type="text"></div>
                    <div class="form-field"><label for="edit_descricao">Descri√ß√£o</label><input id="edit_descricao" class="form-control" type="text"></div>
                    <div class="form-field"><label for="edit_qtde">Qtde</label><input id="edit_qtde" class="form-control" type="number"></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label for="edit_atd">Atd</label><input id="edit_atd" class="form-control" type="number"></div>
                    <div class="form-field"><label for="edit_bo">B.O</label><input id="edit_bo" class="form-control" type="number" readonly></div>
                    <div class="form-field"><label for="edit_faturado">Faturado</label><input id="edit_faturado" class="form-control" type="date"></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label for="edit_prev_fat">Prev. Fat.</label><input id="edit_prev_fat" class="form-control" type="number" readonly></div>
                    <div class="form-field"><label for="edit_nf">NF</label><input id="edit_nf" class="form-control" type="text"></div>
                    <div class="form-field"><label for="edit_custo_und">Custo UND</label><input id="edit_custo_und" class="form-control" type="number" step="0.01"></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label for="edit_custo_total">Custo Total</label><input id="edit_custo_total" class="form-control" type="number" step="0.01" readonly></div>
                    <div class="form-field"><label for="edit_transportadora">Transportadora</label><input id="edit_transportadora" class="form-control" type="text"></div>
                    <div class="form-field"><label for="edit_previsao">Previs√£o</label><input id="edit_previsao" class="form-control" type="date"></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label for="edit_chegada">Chegada</label><input id="edit_chegada" class="form-control" type="date"></div>
                    <div class="form-field"><label for="edit_atraso">Atraso</label><input id="edit_atraso" class="form-control" type="number"></div>
                    <div class="form-field"><label for="edit_lead_time">Lead Time</label><input id="edit_lead_time" class="form-control" type="number"></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label for="edit_consultor">Consultor</label><input id="edit_consultor" class="form-control" type="text"></div>
                    <div class="form-field"><label for="edit_obs">OBS</label><input id="edit_obs" class="form-control" type="text"></div>
                    <div class="form-field"><label for="edit_tw_inicial">TW Inicial</label><input id="edit_tw_inicial" class="form-control" type="number"></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label for="edit_prev_atd">Prev. Atd.</label><input id="edit_prev_atd" class="form-control" type="date"></div>
                    <div class="form-field"><label for="edit_tw_nova">TW Nova</label><input id="edit_tw_nova" class="form-control" type="number"></div>
                    <div class="form-field"><label for="edit_nova_prev_atd">Nova Prev. Atd.</label><input id="edit_nova_prev_atd" class="form-control" type="date"></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label for="edit_status">Status</label>
                        <select id="edit_status" class="form-control">
                            <option value="">Selecione</option>
                            <option value="Estoque">Estoque</option>
                            <option value="Emerg√™ncia">Emerg√™ncia</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-actions" style="text-align:right; margin-top:12px;">
                <button class="btn btn-primary" id="saveEditBtn">Salvar Altera√ß√µes</button>
                <button class="btn btn-info" id="closeEditModal" style="margin-left:8px;">Fechar</button>
            </div>
        </div>
    </div>
    <div class="support-modal" id="bulkModal">
        <div class="support-content" style="max-width:1000px; width:95%;">
            <h2 class="support-title">Incluir Pedidos em Lote</h2>
            <div class="form-container">
                <p style="text-align:center; font-weight:600;">Usa os dados do formul√°rio atual como base. Preencha abaixo os itens que variam.</p>
                <div class="table-responsive">
                    <table class="data-table" id="bulk-table">
                        <thead>
                            <tr>
                                <th>Revenda</th>
                                <th>N¬∫ Pedido</th>
                                <th>Fornecedor</th>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>CTT/ORC</th>
                                <th>Part Number</th>
                                <th>Descri√ß√£o</th>
                                <th>Qtde</th>
                                <th>Atd</th>
                                <th>B.O</th>
                                <th>Faturado</th>
                                <th>Chegada</th>
                                <th>NF</th>
                                <th>Custo UND</th>
                                <th>Transportadora</th>
                                <th>Previs√£o</th>
                                <th>Atraso</th>
                                <th>Lead Time</th>
                                <th>Consultor</th>
                                <th>OBS</th>
                                <th>TW Inicial</th>
                                <th>Prev. Atd.</th>
                                <th>TW Nova</th>
                                <th>Nova Prev. Atd.</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="form-actions" style="text-align:right; margin-top:12px;">
                    <button class="btn btnInfo" id="bulk-add-row">Adicionar Linha</button>
                    <button class="btn btn-info" id="bulk-download-template" style="margin-left:8px;">Baixar Modelo CSV</button>
                    <label class="btn btn-info" style="margin-left:8px; cursor:pointer;">
                        Importar CSV
                        <input type="file" id="bulk-file-input" accept=".csv,.tsv,text/csv,text/tab-separated-values" style="display:none;" />
                    </label>
                    <button class="btn btn-info" id="bulk-paste-import" style="margin-left:8px;">Importar por Colar</button>
                    <button class="btn btn-primary" id="bulk-save" style="margin-left:8px;">Salvar Itens</button>
                    <button class="btn btn-info" id="bulk-close" style="margin-left:8px;">Fechar</button>
                </div>
                <div id="bulk-paste-wrapper" style="display:none; margin-top:10px;">
                    <textarea id="bulk-paste-area" class="form-control" rows="6" placeholder="Cole aqui linhas da planilha (inclua a primeira linha com os nomes das colunas)"></textarea>
                    <div class="form-actions" style="text-align:right; margin-top:8px;">
                        <button class="btn btn-primary" id="bulk-paste-apply">Aplicar Linhas</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="footer footer-fixed" id="login-footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="tel:+5581995143900">(81) 99514-3900</a>
                <a href="mailto:thiago.carmo@normaq.com.br">thiago.carmo@normaq.com.br</a>
                <a href="#" id="login-footer-whatsapp">WhatsApp</a>
            </div>
            <div class="footer-copyright">
                ¬© 2025 NORMAQ JCB - Todos os direitos reservados - Vers√£o 1.0<br>
                Desenvolvido por Thiago Carmo ‚Äî Especialista em Dados e Desenvolvedor
            </div>
        </div>
    </div>
    
    <!-- Support Modal -->
    <div class="support-modal" id="supportModal">
        <div class="support-content">
            <h2 class="support-title">Suporte & Informa√ß√µes</h2>
            <div class="support-info">
                <p>Para problemas de acesso:</p>
                <p>Entre em contato com o administrador do sistema:</p>
                <p><strong>Thiago Carmo</strong> ‚Äì Especialista em Dados e Desenvolvedor</p>
                <p>üìç (81) 99514-3900</p>
                <p><a href="#" id="whatsappLink">Abrir WhatsApp</a></p>
                <p><strong>Hor√°rio de atendimento:</strong></p>
                <p>- Segunda a sexta: 8h √†s 18h</p>
                <p>- S√°bado: 8h √†s 12h</p>
            </div>
            <button class="close-btn" id="closeSupport">Fechar</button>
        </div>
    </div>

    <!-- Modal de Notifica√ß√µes de Exclus√£o -->
    <div class="support-modal" id="deleteNotifModal">
        <div class="support-content">
            <h2 class="support-title">Solicita√ß√µes de Exclus√£o</h2>
            <div id="deleteNotifBody" class="support-info"></div>
            <div class="form-actions" style="text-align:right; margin-top:12px;">
                <button class="btn btn-danger" id="goToDeleteArea">Ir para Exclus√£o de Pedidos</button>
                <button class="close-btn" id="closeDeleteNotif">Fechar</button>
            </div>
        </div>
    </div>

    <div class="toast-notice" id="deleteToast" style="display:none;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <h4>Exclus√£o Pendente</h4>
            <span id="closeDeleteToast" style="cursor:pointer; color:#8a6d3b;">√ó</span>
        </div>
        <p id="deleteToastMsg">Voc√™ tem pedidos pendentes para exclus√£o.</p>
        <div class="toast-actions">
            <button class="btn btn-danger" id="toastGoDelete">Abrir Exclus√£o</button>
        </div>
    </div>

    <div class="toast-notice" id="deleteDoneToast" style="display:none;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <h4 id="deleteDoneToastTitle">Pedidos de Exclus√£o realizados</h4>
            <span id="closeDeleteDoneToast" style="cursor:pointer; color:#8a6d3b;">√ó</span>
        </div>
        <p id="deleteDoneToastMsg">Pedidos de Exclus√£o realizados.</p>
        <div class="toast-actions">
            <button class="btn btn-primary" id="toastDoneOk">OK</button>
        </div>
    </div>

    <div class="toast-notice" id="requesterPendingToast" style="display:none;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <h4>Solicita√ß√µes Pendentes</h4>
            <span id="closeRequesterPendingToast" style="cursor:pointer; color:#8a6d3b;">√ó</span>
        </div>
        <p id="requesterPendingToastMsg">Voc√™ possui solicita√ß√µes de exclus√£o ainda pendentes.</p>
        <div class="toast-actions">
            <button class="btn btn-info" id="toastPendingOk">OK</button>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div class="dashboard-container" id="dashboard">
        <div class="header">
            <div class="header-left">
                <img src="./Nova pasta/Imagem5.png" alt="NORMAQ JCB Logo" class="header-logo">
                <h1 class="header-title">Controle de Pedidos de Emerg√™ncia</h1>
            </div>
            <div class="header-right">
                <div class="user-info" id="userInfo">Usu√°rio: thiago.carmo</div>
                <div id="delete-notify" style="margin-left:12px; background:#ffefef; color:#c0392b; border:1px solid #e74c3c; border-radius:16px; padding:4px 10px; font-size:13px; display:none; cursor:pointer;">Exclus√µes pendentes</div>
                <div id="requester-notify" style="margin-left:12px; background:#eef9ff; color:#1f618d; border:1px solid #5dade2; border-radius:16px; padding:4px 10px; font-size:13px; display:none; cursor:pointer;">Minhas solicita√ß√µes</div>
                <button class="logout-btn" id="logoutBtn">Sair</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <ul class="sidebar-menu">
                    <li class="menu-item active" data-tab="dashboard-tab">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </li>
                    <li class="menu-item" data-tab="orders-tab" data-permission-key="orders">
                        <i class="fas fa-clipboard-list"></i>
                        <span>Pedidos</span>
                    </li>
                    <li class="menu-item" data-tab="consultant-tab" data-permission-key="consultant">
                        <i class="fas fa-user-tie"></i>
                        <span>√Årea do Consultor</span>
                    </li>
                    <li class="menu-item" data-tab="arrival-tab" data-permission-key="arrival">
                        <i class="fas fa-box-open"></i>
                        <span>Chegada de Pe√ßas</span>
                    </li>
                    <li class="menu-item" data-tab="new-order-tab" data-permission-key="new_order">
                        <i class="fas fa-plus-circle"></i>
                        <span>Incluir novos Pedidos</span>
                    </li>
                    <li class="menu-item" data-tab="delete-order-tab" data-permission-key="delete_order">
                        <i class="fas fa-trash-alt"></i>
                        <span>Exclus√£o de Pedidos</span>
                    </li>
                    <li class="menu-item" data-tab="request-delete-tab" data-permission-key="request_delete">
                        <i class="fas fa-envelope"></i>
                        <span>Solicita√ß√£o de Exclus√£o</span>
                    </li>
                    <li class="menu-item" data-tab="admin-tab" data-permission-key="admin">
                        <i class="fas fa-cogs"></i>
                        <span>Administrador</span>
                    </li>
                </ul>
            </div>
            
            <div class="content-area">
                <!-- Dashboard Tab -->
                <div class="tab-content active" id="dashboard-tab">
                    <h2 class="section-title">Dashboard</h2>
                    <div class="filters dash-filters">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="dash-year-filter">Ano</label>
                                <select id="dash-year-filter" class="filter-select">
                                    <option value="">Todos</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="dash-month-filter">M√™s</label>
                                <select id="dash-month-filter" class="filter-select">
                                    <option value="">Todos</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Mar√ßo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="dash-revenda-filter">Revenda</label>
                                <select id="dash-revenda-filter" class="filter-select">
                                    <option value="">Todas</option>
                                    <option value="Recife">Recife</option>
                                    <option value="Natal">Natal</option>
                                    <option value="Fortaleza">Fortaleza</option>
                                    <option value="Petrolina">Petrolina</option>
                                    <option value="Para√≠ba">Para√≠ba</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="dash-status-filter">Status</label>
                                <select id="dash-status-filter" class="filter-select">
                                    <option value="">Todos</option>
                                    <option value="Estoque">Estoque</option>
                                    <option value="Emerg√™ncia">Emerg√™ncia</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="dash-shipping-filter">Transportadora</label>
                                <select id="dash-shipping-filter" class="filter-select">
                                    <option value="">Todas</option>
                                    <option value="Rodovi√°rio">Rodovi√°rio</option>
                                    <option value="A√©reo">A√©reo</option>
                                    <option value="Transfer√™ncia">Transfer√™ncia</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="dash-client-filter">Cliente</label>
                                <input type="text" id="dash-client-filter" class="filter-input" placeholder="Cliente">
                            </div>
                        </div>
                    </div>

                    <div class="dash-cards">
                        <div class="dash-card">
                            <div class="dash-card-header"><span class="dash-card-icon total"><i class="fas fa-clipboard-list"></i></span><div class="dash-card-title">Total de Pedidos</div></div>
                            <div class="dash-card-value" id="dash-total-pedidos">0</div>
                            <div class="dash-card-delta" id="dash-total-pedidos-delta"></div>
                        </div>
                        <div class="dash-card">
                            <div class="dash-card-header"><span class="dash-card-icon valor"><i class="fas fa-money-bill-wave"></i></span><div class="dash-card-title">Valor Total dos Pedidos</div></div>
                            <div class="dash-card-value" id="dash-valor-total">R$ 0,00</div>
                            <div class="dash-card-delta" id="dash-valor-total-delta"></div>
                        </div>
                        <div class="dash-card">
                            <div class="dash-card-header"><span class="dash-card-icon custo"><i class="fas fa-coins"></i></span><div class="dash-card-title">Custo UND Total</div></div>
                            <div class="dash-card-value" id="dash-custo-und-total">R$ 0,00</div>
                            <div class="dash-card-delta" id="dash-custo-und-total-delta"></div>
                        </div>
                        <div class="dash-card">
                            <div class="dash-card-header"><span class="dash-card-icon atendimento"><i class="fas fa-check-circle"></i></span><div class="dash-card-title">% Atendimento</div></div>
                            <div class="dash-card-value" id="dash-percent-atendimento">0%</div>
                            <div class="dash-card-delta" id="dash-percent-atendimento-delta"></div>
                        </div>
                        <div class="dash-card">
                            <div class="dash-card-header"><span class="dash-card-icon emergencia"><i class="fas fa-exclamation-triangle"></i></span><div class="dash-card-title">% Emerg√™ncia</div></div>
                            <div class="dash-card-value" id="dash-percent-emergencia">0%</div>
                            <div class="dash-card-delta" id="dash-percent-emergencia-delta"></div>
                        </div>
                    </div>

                    <div class="dash-section">
                        <h3 class="section-title">Top 20 Itens</h3>
                        <div class="data-table-container">
                            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="data-table" id="dashboard-top20-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Descri√ß√£o</th>
                                            <th>Custo Total</th>
                                            <th>Qtde</th>
                                            <th>Revenda</th>
                                            <th>Cliente</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="dash-section">
                        <div class="grid-2">
                            <div class="chart-container">
                                <h3 class="section-title">Custo Total por Revenda</h3>
                                <div id="dash-chart-revenda"></div>
                            </div>
                            <div class="chart-container">
                                <h3 class="section-title">Custo Total Estoque por Filial</h3>
                                <div id="dash-chart-estoque"></div>
                            </div>
                        </div>
                        <div class="chart-container" style="margin-top:12px;">
                            <h3 class="section-title">Custo Total Emerg√™ncia por Filial</h3>
                            <div id="dash-chart-emergencia"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Orders Tab -->
                <div class="tab-content" id="orders-tab">
                    <h2 class="section-title">Pedidos</h2>
                    
                    <div class="filters">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="year-filter">Ano</label>
                                <select id="year-filter" class="filter-select">
                                    <option value="">Todos</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="month-filter">M√™s</label>
                                <select id="month-filter" class="filter-select">
                                    <option value="">Todos</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Mar√ßo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="order-number-filter">N¬∫ Pedido</label>
                                <input type="text" id="order-number-filter" class="filter-input" placeholder="N¬∫ Pedido">
                            </div>
                            <div class="filter-group">
                                <label for="part-number-filter">Part Number</label>
                                <input type="text" id="part-number-filter" class="filter-input" placeholder="Part Number">
                            </div>
                            <div class="filter-group">
                                <label for="date-filter">Data Pedido</label>
                                <input type="date" id="date-filter" class="filter-input">
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="tw-filter">N¬∫ TW</label>
                                <input type="text" id="tw-filter" class="filter-input" placeholder="N¬∫ TW">
                            </div>
                            <div class="filter-group">
                                <label for="consultant-filter">Consultor</label>
                                <input type="text" id="consultant-filter" class="filter-input" placeholder="Consultor">
                            </div>
                            <div class="filter-group">
                                <label for="client-filter">Cliente</label>
                                <input type="text" id="client-filter" class="filter-input" placeholder="Cliente">
                            </div>
                            <div class="filter-group">
                                <label for="supplier-filter">Fornecedor</label>
                                <input type="text" id="supplier-filter" class="filter-input" placeholder="Fornecedor">
                            </div>
                            <div class="filter-group">
                                <label for="nf-filter">N√∫mero da Nota</label>
                                <input type="text" id="nf-filter" class="filter-input" placeholder="N√∫mero da Nota">
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="shipping-filter">Transportadora</label>
                                <select id="shipping-filter" class="filter-select">
                                    <option value="">Todas</option>
                                    <option value="Rodovi√°rio">Rodovi√°rio</option>
                                    <option value="A√©reo">A√©reo</option>
                                    <option value="Transfer√™ncia">Transfer√™ncia</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="revenda-filter">Revenda</label>
                                <select id="revenda-filter" class="filter-select">
                                    <option value="">Todas</option>
                                    <option value="Recife">Recife</option>
                                    <option value="Natal">Natal</option>
                                    <option value="Fortaleza">Fortaleza</option>
                                    <option value="Petrolina">Petrolina</option>
                                    <option value="Para√≠ba">Para√≠ba</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="status-filter">Status</label>
                                <select id="status-filter" class="filter-select">
                                    <option value="">Todos</option>
                                    <option value="Estoque">Estoque</option>
                                    <option value="Emerg√™ncia">Emerg√™ncia</option>
                                </select>
                            </div>
                            <div class="filter-group"></div>
                        </div>
                        
                        <div class="filter-actions">
                            <button class="btn btn-info" id="clear-filters">Limpar Filtros</button>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="table-responsive" style="max-height: 360px; overflow-y: auto;">
                            <table class="data-table" id="orders-table">
                                <thead>
                                    <tr>
                                        <th>A√ß√µes</th>
                                        <th>Revenda</th>
                                        <th>N¬∫ Pedido</th>
                                        <th>Fornecedor</th>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>CTT/ORC</th>
                                        <th>Part Number</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Qtde</th>
                                        <th>Atd</th>
                                        <th>B.O</th>
                                        <th>Faturado</th>
                                        <th>Prev. Fat.</th>
                                        <th>NF</th>
                                        <th>Custo UND</th>
                                        <th>Custo Total</th>
                                        <th>Transportadora</th>
                                        <th>Previs√£o</th>
                                        <th>Chegada</th>
                                        <th>Atraso</th>
                                        <th>Lead Time</th>
                                        <th>Consultor</th>
                                        <th>OBS</th>
                                        <th>TW Inicial</th>
                                        <th>Prev. Atd.</th>
                                        <th>TW Nova</th>
                                        <th>Nova Prev. Atd.</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Arrival Parts Tab -->
                <div class="tab-content" id="arrival-tab">
                    <h2 class="section-title">Chegada de Pe√ßas</h2>
                    <div class="filters">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="arrival-year-filter">Ano</label>
                                <select id="arrival-year-filter" class="filter-select">
                                    <option value="">Todos</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="arrival-month-filter">M√™s</label>
                                <select id="arrival-month-filter" class="filter-select">
                                    <option value="">Todos</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Mar√ßo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="arrival-order-number-filter">N¬∫ Pedido</label>
                                <input type="text" id="arrival-order-number-filter" class="filter-input" placeholder="N¬∫ Pedido">
                            </div>
                            <div class="filter-group">
                                <label for="arrival-part-number-filter">Part Number</label>
                                <input type="text" id="arrival-part-number-filter" class="filter-input" placeholder="Part Number">
                            </div>
                            <div class="filter-group">
                                <label for="arrival-date-filter">Data Pedido</label>
                                <input type="date" id="arrival-date-filter" class="filter-input">
                            </div>
                        </div>

                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="arrival-consultant-filter">Consultor</label>
                                <input type="text" id="arrival-consultant-filter" class="filter-input" placeholder="Consultor">
                            </div>
                            <div class="filter-group">
                                <label for="arrival-client-filter">Cliente</label>
                                <input type="text" id="arrival-client-filter" class="filter-input" placeholder="Cliente">
                            </div>
                            <div class="filter-group">
                                <label for="arrival-supplier-filter">Fornecedor</label>
                                <input type="text" id="arrival-supplier-filter" class="filter-input" placeholder="Fornecedor">
                            </div>
                            <div class="filter-group">
                                <label for="arrival-nf-filter">N√∫mero da Nota</label>
                                <input type="text" id="arrival-nf-filter" class="filter-input" placeholder="N√∫mero da Nota">
                            </div>
                            <div class="filter-group">
                                <label for="arrival-revenda-filter">Revenda</label>
                                <select id="arrival-revenda-filter" class="filter-select">
                                    <option value="">Todas</option>
                                    <option value="Recife">Recife</option>
                                    <option value="Natal">Natal</option>
                                    <option value="Fortaleza">Fortaleza</option>
                                    <option value="Petrolina">Petrolina</option>
                                    <option value="Para√≠ba">Para√≠ba</option>
                                </select>
                            </div>
                        </div>

                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="arrival-status-filter">Status</label>
                                <select id="arrival-status-filter" class="filter-select">
                                    <option value="">Todos</option>
                                    <option value="Estoque" selected>Estoque</option>
                                    <option value="Emerg√™ncia">Emerg√™ncia</option>
                                </select>
                            </div>
                            <div class="filter-group" style="flex:2;">
                                <label for="arrival-email-input">E-mails para envio</label>
                                <input id="arrival-email-input" class="filter-select" type="text" placeholder="email1@dominio.com; email2@dominio.com">
                            </div>
                        </div>

                        <div class="filter-actions">
                            <button class="btn btn-info" id="arrival-clear-filters">Limpar Filtros</button>
                            <button class="btn btn-secondary" id="arrival-select-all">Selecionar Todos</button>
                            <button class="btn btn-primary" id="arrival-send-email">Enviar por E-mail</button>
                        </div>
                    </div>

                    <div class="data-table-container">
                        <div class="table-responsive" style="max-height: 360px; overflow-y: auto;">
                            <table class="data-table" id="arrival-table">
                                <thead>
                                    <tr>
                                        <th>Selecionar</th>
                                        <th>Pedido</th>
                                        <th>Fornecedor</th>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>CTT/ORC</th>
                                        <th>Part Number</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Qtde</th>
                                        <th>NF</th>
                                        <th>Custo UND</th>
                                        <th>Previs√£o</th>
                                        <th>Chegada</th>
                                        <th>Atraso</th>
                                        <th>Consultor</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Consultant Area Tab -->
                <div class="tab-content" id="consultant-tab">
                    <h2 class="section-title">√Årea do Consultor</h2>
                    
                    <div class="filters">
                        <!-- Same filters as orders tab -->
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="consultant-year-filter">Ano</label>
                                <select id="consultant-year-filter" class="filter-select">
                                    <option value="">Todos</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="consultant-month-filter">M√™s</label>
                                <select id="consultant-month-filter" class="filter-select">
                                    <option value="">Todos</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Mar√ßo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="consultant-order-number-filter">N¬∫ Pedido</label>
                                <input type="text" id="consultant-order-number-filter" class="filter-input" placeholder="N¬∫ Pedido">
                            </div>
                            <div class="filter-group">
                                <label for="consultant-part-number-filter">Part Number</label>
                                <input type="text" id="consultant-part-number-filter" class="filter-input" placeholder="Part Number">
                            </div>
                            <div class="filter-group">
                                <label for="consultant-date-filter">Data Pedido</label>
                                <input type="date" id="consultant-date-filter" class="filter-input">
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="consultant-tw-filter">N¬∫ TW</label>
                                <input type="text" id="consultant-tw-filter" class="filter-input" placeholder="N¬∫ TW">
                            </div>
                            <div class="filter-group">
                                <label for="consultant-consultant-filter">Consultor</label>
                                <input type="text" id="consultant-consultant-filter" class="filter-input" placeholder="Consultor">
                            </div>
                            <div class="filter-group">
                                <label for="consultant-client-filter">Cliente</label>
                                <input type="text" id="consultant-client-filter" class="filter-input" placeholder="Cliente">
                            </div>
                            <div class="filter-group">
                                <label for="consultant-supplier-filter">Fornecedor</label>
                                <input type="text" id="consultant-supplier-filter" class="filter-input" placeholder="Fornecedor">
                            </div>
                            <div class="filter-group">
                                <label for="consultant-nf-filter">N√∫mero da Nota</label>
                                <input type="text" id="consultant-nf-filter" class="filter-input" placeholder="N√∫mero da Nota">
                            </div>
                            <div class="filter-group">
                                <label for="consultant-revenda-filter">Revenda</label>
                                <select id="consultant-revenda-filter" class="filter-select">
                                    <option value="">Todas</option>
                                    <option value="Recife">Recife</option>
                                    <option value="Natal">Natal</option>
                                    <option value="Fortaleza">Fortaleza</option>
                                    <option value="Petrolina">Petrolina</option>
                                    <option value="Para√≠ba">Para√≠ba</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="consultant-status-filter">Status</label>
                                <select id="consultant-status-filter" class="filter-select">
                                    <option value="">Todos</option>
                                    <option value="Estoque">Estoque</option>
                                    <option value="Emerg√™ncia">Emerg√™ncia</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="filter-actions">
                            <button class="btn btn-info" id="consultant-clear-filters">Limpar Filtros</button>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="table-responsive" style="max-height: 800px; overflow-y: auto;">
                            <table class="data-table" id="consultant-table">
                                <thead>
                                    <tr>
                                        <th>Revenda</th>
                                        <th>N¬∫ Pedido</th>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>CTT/ORC</th>
                                        <th>Part Number</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Qtde</th>
                                        <th>Atd</th>
                                        <th>B.O</th>
                                        <th>Faturado</th>
                                        <th>Prev. Fat.</th>
                                        <th>NF</th>
                                        <th>Previs√£o</th>
                                        <th>Chegada</th>
                                        <th>Consultor</th>
                                        <th>TW Inicial</th>
                                        <th>Prev. Atd.</th>
                                        <th>TW Nova</th>
                                        <th>Nova Prev. Atd.</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- New Order Tab -->
                <div class="tab-content" id="new-order-tab">
                    <h2 class="section-title">Incluir Novo Pedido</h2>
                    
                    <div class="form-container">
                        <form id="new-order-form">
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="revenda">Revenda</label>
                                    <select id="revenda" class="form-control" required>
                                        <option value="">Selecione</option>
                                        <option value="Recife">Recife</option>
                                        <option value="Natal">Natal</option>
                                        <option value="Fortaleza">Fortaleza</option>
                                        <option value="Petrolina">Petrolina</option>
                                        <option value="Para√≠ba">Para√≠ba</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label for="numero_pedido">N¬∫ Pedido</label>
                                    <input type="text" id="numero_pedido" class="form-control" required>
                                </div>
                                <div class="form-field">
                                    <label for="fornecedor">Fornecedor</label>
                                    <input type="text" id="fornecedor" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="data_pedido">Data</label>
                                    <input type="date" id="data_pedido" class="form-control" required>
                                </div>
                                <div class="form-field">
                                    <label for="cliente">Cliente</label>
                                    <input type="text" id="cliente" class="form-control" required>
                                </div>
                                <div class="form-field">
                                    <label for="ctt_orc">CTT / ORC</label>
                                    <input type="number" id="ctt_orc" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="part_number">Part Number</label>
                                    <input type="text" id="part_number" class="form-control" required>
                                </div>
                                <div class="form-field">
                                    <label for="descricao">Descri√ß√£o</label>
                                    <input type="text" id="descricao" class="form-control" required>
                                </div>
                                <div class="form-field">
                                    <label for="qtde">Qtde</label>
                                    <input type="number" id="qtde" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="atd">Atd</label>
                                    <input type="number" id="atd" class="form-control" required>
                                </div>
                                <div class="form-field">
                                    <label for="bo">B.O</label>
                                    <input type="number" id="bo" class="form-control auto-calc" readonly>
                                </div>
                                <div class="form-field">
                                    <label for="faturado">Faturado</label>
                                    <input type="date" id="faturado" class="form-control">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="prev_fat">Prev. Fat.</label>
                                    <input type="number" id="prev_fat" class="form-control auto-calc" readonly>
                                </div>
                                <div class="form-field">
                                    <label for="nf">NF</label>
                                    <input type="number" id="nf" class="form-control">
                                </div>
                                <div class="form-field">
                                    <label for="custo_und">Custo UND</label>
                                    <input type="number" step="0.01" id="custo_und" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="custo_total">Custo Total</label>
                                    <input type="number" step="0.01" id="custo_total" class="form-control auto-calc" readonly>
                                </div>
                                <div class="form-field">
                                    <label for="transportadora">Transportadora</label>
                                    <select id="transportadora" class="form-control" required>
                                        <option value="">Selecione</option>
                                        <option value="Rodovi√°rio">Rodovi√°rio</option>
                                        <option value="A√©reo">A√©reo</option>
                                        <option value="Transfer√™ncia">Transfer√™ncia</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label for="previsao">Previs√£o</label>
                                    <input type="date" id="previsao" class="form-control auto-calc" readonly>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="chegada">Chegada</label>
                                    <input type="date" id="chegada" class="form-control">
                                </div>
                                <div class="form-field">
                                    <label for="atraso">Atraso</label>
                                    <input type="number" id="atraso" class="form-control auto-calc" readonly>
                                </div>
                                <div class="form-field">
                                    <label for="lead_time">Lead Time</label>
                                    <input type="number" id="lead_time" class="form-control auto-calc" readonly>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="consultor">Consultor</label>
                                    <input type="text" id="consultor" class="form-control" required>
                                </div>
                                <div class="form-field">
                                    <label for="obs">OBS</label>
                                    <input type="text" id="obs" class="form-control">
                                </div>
                                <div class="form-field">
                                    <label for="status">Status</label>
                                    <select id="status" class="form-control" required>
                                        <option value="Estoque">Estoque</option>
                                        <option value="Emerg√™ncia">Emerg√™ncia</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label for="tw_inicial">TW Inicial</label>
                                    <input type="number" id="tw_inicial" class="form-control">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="prev_atd">Prev. Atd.</label>
                                    <input type="date" id="prev_atd" class="form-control">
                                </div>
                                <div class="form-field">
                                    <label for="tw_nova">TW Nova</label>
                                    <input type="number" id="tw_nova" class="form-control">
                                </div>
                                <div class="form-field">
                                    <label for="nova_prev_atd">Nova Prev. Atd.</label>
                                    <input type="date" id="nova_prev_atd" class="form-control">
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="reset" class="btn btn-info">Limpar</button>
                                <button type="submit" class="btn btn-primary">Salvar Pedido</button>
                                <button type="button" class="btn btn-primary" id="open-bulk-modal" style="margin-left:8px;">Incluir em Lote</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Delete Order Tab -->
                <div class="tab-content" id="delete-order-tab">
                    <h2 class="section-title">Exclus√£o de Pedidos</h2>
                    
                    <div class="form-group" style="max-width: 300px; margin-bottom: 20px;">
                        <label for="delete-password">Senha de Acesso</label>
                        <input type="password" id="delete-password" class="form-control" placeholder="Digite a senha">
                    </div>
                    
                    <div id="delete-content" style="display: none;">
                        <div class="filters">
                            <!-- Same filters as orders tab -->
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="delete-year-filter">Ano</label>
                                    <select id="delete-year-filter" class="filter-select">
                                        <option value="">Todos</option>
                                        <option value="2025">2025</option>
                                        <option value="2024">2024</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="delete-month-filter">M√™s</label>
                                    <select id="delete-month-filter" class="filter-select">
                                        <option value="">Todos</option>
                                        <option value="1">Janeiro</option>
                                        <option value="2">Fevereiro</option>
                                        <option value="3">Mar√ßo</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Maio</option>
                                        <option value="6">Junho</option>
                                        <option value="7">Julho</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Setembro</option>
                                        <option value="10">Outubro</option>
                                        <option value="11">Novembro</option>
                                        <option value="12">Dezembro</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="delete-order-number-filter">N¬∫ Pedido</label>
                                    <input type="text" id="delete-order-number-filter" class="filter-input" placeholder="N¬∫ Pedido">
                                </div>
                                <div class="filter-group">
                                    <label for="delete-part-number-filter">Part Number</label>
                                    <input type="text" id="delete-part-number-filter" class="filter-input" placeholder="Part Number">
                                </div>
                                <div class="filter-group">
                                    <label for="delete-date-filter">Data Pedido</label>
                                    <input type="date" id="delete-date-filter" class="filter-input">
                                </div>
                                <div class="filter-group">
                                    <label for="delete-revenda-filter">Revenda</label>
                                    <select id="delete-revenda-filter" class="filter-select">
                                        <option value="">Todas</option>
                                        <option value="Recife">Recife</option>
                                        <option value="Natal">Natal</option>
                                        <option value="Fortaleza">Fortaleza</option>
                                        <option value="Petrolina">Petrolina</option>
                                        <option value="Para√≠ba">Para√≠ba</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="delete-nf-filter">N√∫mero da Nota</label>
                                    <input type="text" id="delete-nf-filter" class="filter-input" placeholder="N√∫mero da Nota">
                                </div>
                                <div class="filter-group">
                                    <label for="delete-status-filter">Status</label>
                                    <select id="delete-status-filter" class="filter-select">
                                        <option value="">Todos</option>
                                        <option value="Estoque">Estoque</option>
                                        <option value="Emerg√™ncia">Emerg√™ncia</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="filter-actions">
                                <button class="btn btn-info" id="delete-clear-filters">Limpar Filtros</button>
                            </div>
                        </div>
                        
                        <div class="data-table-container">
                            <div class="table-responsive" style="max-height: 800px; overflow-y: auto;">
                                <table class="data-table" id="delete-table">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="delete-select-all"></th>
                                            <th>Revenda</th>
                                            <th>N¬∫ Pedido</th>
                                            <th>Fornecedor</th>
                                            <th>Data</th>
                                            <th>Cliente</th>
                                            <th>CTT/ORC</th>
                                            <th>Part Number</th>
                                            <th>Descri√ß√£o</th>
                                            <th>Qtde</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="form-actions" style="text-align:right; margin-top:12px;">
                                <button class="btn btn-danger" id="delete-bulk-btn">Excluir Selecionados</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Request Delete Tab -->
                <div class="tab-content" id="request-delete-tab">
                    <h2 class="section-title">Solicita√ß√£o de Exclus√£o de Pedidos</h2>
                    <div class="filters">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="reqdel-year-filter">Ano</label>
                                <select id="reqdel-year-filter" class="filter-select">
                                    <option value="">Todos</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="reqdel-month-filter">M√™s</label>
                                <select id="reqdel-month-filter" class="filter-select">
                                    <option value="">Todos</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Mar√ßo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="reqdel-order-number-filter">N¬∫ Pedido</label>
                                <input type="text" id="reqdel-order-number-filter" class="filter-input" placeholder="N¬∫ Pedido">
                            </div>
                            <div class="filter-group">
                                <label for="reqdel-part-number-filter">Part Number</label>
                                <input type="text" id="reqdel-part-number-filter" class="filter-input" placeholder="Part Number">
                            </div>
                            <div class="filter-group">
                                <label for="reqdel-date-filter">Data Pedido</label>
                                <input type="date" id="reqdel-date-filter" class="filter-input">
                            </div>
                        </div>
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="reqdel-revenda-filter">Revenda</label>
                                <select id="reqdel-revenda-filter" class="filter-select">
                                    <option value="">Todas</option>
                                    <option value="Recife">Recife</option>
                                    <option value="Natal">Natal</option>
                                    <option value="Fortaleza">Fortaleza</option>
                                    <option value="Petrolina">Petrolina</option>
                                    <option value="Para√≠ba">Para√≠ba</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="reqdel-status-filter">Status</label>
                                <select id="reqdel-status-filter" class="filter-select">
                                    <option value="">Todos</option>
                                    <option value="Estoque">Estoque</option>
                                    <option value="Emerg√™ncia">Emerg√™ncia</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="reqdel-nf-filter">N√∫mero da Nota</label>
                                <input type="text" id="reqdel-nf-filter" class="filter-input" placeholder="N√∫mero da Nota">
                            </div>
                            <div class="filter-group" style="flex:2">
                                <label for="reqdel-email-select">Destinat√°rios</label>
                                <select id="reqdel-email-select" class="filter-select"></select>
                            </div>
                        </div>
                        <div class="filter-actions" style="display:flex; gap:8px; align-items:center;">
                            <button class="btn btn-info" id="reqdel-clear-filters">Limpar Filtros</button>
                            <button class="btn btn-warning" id="request-delete-send-btn">Enviar Solicita√ß√£o</button>
                        </div>
                    </div>
                    <div class="data-table-container">
                        <div class="table-responsive" style="max-height: 800px; overflow-y: auto;">
                            <table class="data-table" id="request-delete-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="reqdel-select-all"></th>
                                        <th>Revenda</th>
                                        <th>N¬∫ Pedido</th>
                                        <th>Cliente</th>
                                        <th>NF</th>
                                        <th>Fornecedor</th>
                                        <th>Data</th>
                                        <th>Part Number</th>
                                        <th>Descri√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        
                    </div>
                </div>

                <!-- Admin Tab -->
                <div class="tab-content" id="admin-tab">
                    <h2 class="section-title">Administrador</h2>
                    <div id="admin-submenu" style="display:flex; gap:8px; margin:12px 0;">
                        <button class="btn btn-primary" data-admin-subtab="admin-perms">Permiss√µes</button>
                        <button class="btn btn-secondary" data-admin-subtab="admin-supabase">Supabase</button>
                        <button class="btn btn-secondary" data-admin-subtab="admin-users">Usu√°rios</button>
                        <button class="btn btn-secondary" data-admin-subtab="admin-emaillist">Lista de E-mails</button>
                    </div>
                    <div class="admin-sub-content" id="admin-perms-panel" style="display:block;">
                    <div class="form-container">
                        <div class="form-group">
                            <label for="user-select">Selecionar Usu√°rio</label>
                            <select id="user-select" class="form-control">
                                <option value="">Selecione um usu√°rio</option>
                                <!-- Users will be populated by JavaScript -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Permiss√µes</label>
                            <div id="permissions-container"></div>
                        </div>
                        
                <div class="form-actions">
                    <button class="btn btn-primary" id="save-permissions">Salvar Permiss√µes</button>
                </div>
            </div>
            </div>

                <div class="admin-sub-content" id="admin-supabase-panel" style="display:none;">
                <div class="form-container" style="margin-top:20px;">
                <h3 class="section-title">Configura√ß√£o do Supabase</h3>
                <div class="form-row">
                    <div class="form-field">
                        <label for="supabase-url">URL</label>
                        <input id="supabase-url" class="form-control" type="text" placeholder="https://xxxxx.supabase.co">
                    </div>
                    <div class="form-field">
                        <label for="supabase-key">Anon Key</label>
                        <input id="supabase-key" class="form-control" type="text" placeholder="Chave an√¥nima">
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" id="save-supabase-config">Salvar Configura√ß√£o</button>
                </div>
            </div>
            </div>

            <div class="admin-sub-content" id="admin-users-panel" style="display:none;">
            <div class="form-container" style="margin-top:20px;">
                <h3 class="section-title">Cadastrar Novo Usu√°rio</h3>
                <div class="form-row">
                    <div class="form-field"><label for="admin_new_username">Usu√°rio</label><input id="admin_new_username" class="form-control" type="text" placeholder="ex: thiago.carmo"></div>
                    <div class="form-field"><label for="admin_new_email">Email</label><input id="admin_new_email" class="form-control" type="email" placeholder="email@dominio.com"></div>
                    <div class="form-field"><label for="admin_new_is_admin">Administrador</label>
                        <select id="admin_new_is_admin" class="form-control"><option value="false">N√£o</option><option value="true">Sim</option></select>
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-success" id="admin_create_user_btn">Cadastrar Usu√°rio</button>
                    <span style="margin-left:8px; color:#666;">Senha inicial: NMQ@123 ‚Äî solicitar troca no primeiro acesso</span>
                </div>
            </div>
            </div>

            <div class="admin-sub-content" id="admin-emaillist-panel" style="display:none;">
            <div class="form-container" style="margin-top:20px;">
                <h3 class="section-title">Lista de E-mails</h3>
                <div class="form-row" style="gap:12px; align-items:flex-end;">
                    <div class="form-field" style="flex:1;">
                        <label for="admin-email-add-input">Adicionar e-mail</label>
                        <input id="admin-email-add-input" class="form-control" type="email" placeholder="email@dominio.com">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-success" id="admin-email-add-btn">Adicionar</button>
                    </div>
                </div>
                <div class="form-row" style="margin-top:12px; align-items:flex-end; gap:12px;">
                    <div class="form-field" style="flex:1;">
                        <label for="admin-email-list-select">Lista atual</label>
                        <select id="admin-email-list-select" class="form-control"></select>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-danger" id="admin-email-remove-btn">Excluir Selecionado</button>
                    </div>
                </div>
            </div>
            </div>

            <div class="admin-sub-content" id="admin-users-table-panel" style="display:none;">
            <div class="data-table-container" style="margin-top:20px;">
                <div class="table-responsive">
                    <table class="data-table" id="users-permissions-table">
                        <thead>
                            <tr>
                                        <th>Usu√°rio</th>
                                        <th>Permiss√µes</th>
                                        <th>Admin</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Populado via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <div class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="tel:+5581995143900">(81) 99514-3900</a>
                <a href="mailto:thiago.carmo@normaq.com.br">thiago.carmo@normaq.com.br</a>
                <a href="#" id="footer-whatsapp">WhatsApp</a>
            </div>
            <div class="footer-copyright">
                ¬© 2025 NORMAQ JCB - Todos os direitos reservados - Vers√£o 1.0<br>
                Desenvolvido por Thiago Carmo ‚Äî Especialista em Dados e Desenvolvedor
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL_DEFAULT = 'https://wwerfiiqgjnhqxajssfo.supabase.co';
        const SUPABASE_ANON_KEY_DEFAULT = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3ZXJmaWlxZ2puaHF4YWpzc2ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNTk3NDUsImV4cCI6MjA3NDgzNTc0NX0.UEH6eCSs6p_mWcZLmuE4Ic5ScZWw3X267rOARKUbJ-o';
        function getSupabaseConfig() {
            const u = localStorage.getItem('supabase:url');
            const k = localStorage.getItem('supabase:key');
            return {
                url: (u && u.trim()) || SUPABASE_URL_DEFAULT,
                key: (k && k.trim()) || SUPABASE_ANON_KEY_DEFAULT
            };
        }
        let supabase = null;
        function initSupabase() {
            const cfg = getSupabaseConfig();
            supabase = (window.supabase && window.supabase.createClient) ? window.supabase.createClient(cfg.url, cfg.key) : null;
            const urlEl = document.getElementById('supabase-url');
            const keyEl = document.getElementById('supabase-key');
            if (urlEl) urlEl.value = cfg.url;
            if (keyEl) keyEl.value = cfg.key;
        }
        initSupabase();
        
        // Global login function for inline onclick fallback
        window.performLogin = async function() {
            const username = document.getElementById('username')?.value || '';
            const password = document.getElementById('password')?.value || '';
            const loginScreen = document.getElementById('loginScreen');
            const dashboard = document.getElementById('dashboard');
            const userInfo = document.getElementById('userInfo');
            const loginFooter = document.getElementById('login-footer');
            if (!username || !password) { alert('Por favor, preencha usu√°rio e senha.'); return; }
            try {
                if (!supabase || !supabase.from) {
                    const offlineUser = { id: 'local', username, is_admin: true };
                    window.currentUser = offlineUser;
                    localStorage.setItem('currentUser', JSON.stringify(offlineUser));
                    if (userInfo) userInfo.textContent = `Usu√°rio: ${offlineUser.username}`;
                    if (loginScreen) loginScreen.style.display = 'none';
                    if (dashboard) dashboard.style.display = 'block';
                    if (loginFooter) loginFooter.style.display = 'none';
                    if (typeof applyPermissions === 'function') applyPermissions();
                    if (typeof loadOrders === 'function') loadOrders();
                    if (typeof loadConsultantData === 'function') loadConsultantData();
                    if (typeof loadDashboard === 'function') loadDashboard();
                    if (typeof loadUsersForAdmin === 'function') loadUsersForAdmin();
                    if (typeof loadReqDelEmailListUI === 'function') loadReqDelEmailListUI();
                    if (typeof loadArrivalEmailListUI === 'function') loadArrivalEmailListUI();
                    if (typeof loadAdminEmailSelect === 'function') loadAdminEmailSelect();
                    if (typeof initAdminSubTabs === 'function') initAdminSubTabs();
                    return;
                }
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('username', username)
                    .single();
                if (error || !data) { alert('Usu√°rio ou senha incorretos.'); return; }
                const storedPassword = data.password ?? data.senha ?? null;
                if (storedPassword !== null && storedPassword !== password) { alert('Usu√°rio ou senha incorretos.'); return; }
                window.currentUser = data;
                localStorage.setItem('currentUser', JSON.stringify(data));
                if (userInfo) userInfo.textContent = `Usu√°rio: ${data.username}`;
                if (loginScreen) loginScreen.style.display = 'none';
                if (dashboard) dashboard.style.display = 'block';
                if (loginFooter) loginFooter.style.display = 'none';
                if (typeof applyPermissions === 'function') applyPermissions();
                if (typeof loadOrders === 'function') loadOrders();
                if (typeof loadConsultantData === 'function') loadConsultantData();
                if (typeof loadDashboard === 'function') loadDashboard();
                if (typeof loadUsersForAdmin === 'function') loadUsersForAdmin();
            } catch (e) {
                console.error('Erro no login:', e);
                alert('Erro ao fazer login. Tente novamente.');
            }
        };
        
        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const dashboard = document.getElementById('dashboard');
        const supportModal = document.getElementById('supportModal');
        const loginBtn = document.getElementById('loginBtn');
        const infoBtn = document.getElementById('infoBtn');
        const closeSupport = document.getElementById('closeSupport');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfo = document.getElementById('userInfo');
        const menuItems = document.querySelectorAll('.menu-item');
        const tabContents = document.querySelectorAll('.tab-content');
        const newOrderForm = document.getElementById('new-order-form');
        const deletePassword = document.getElementById('delete-password');
        const deleteContent = document.getElementById('delete-content');
        const whatsappLink = document.getElementById('whatsappLink');
        const footerWhatsapp = document.getElementById('footer-whatsapp');
        const loginFooter = document.getElementById('login-footer');
        const loginFooterWhatsapp = document.getElementById('login-footer-whatsapp');
        const editModal = document.getElementById('editModal');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const closeEditModal = document.getElementById('closeEditModal');
        
        const bulkDownloadTemplateBtn = document.getElementById('bulk-download-template');
        const bulkFileInput = document.getElementById('bulk-file-input');
        const bulkPasteImportBtn = document.getElementById('bulk-paste-import');
        const bulkPasteWrapper = document.getElementById('bulk-paste-wrapper');
        const bulkPasteArea = document.getElementById('bulk-paste-area');
        const bulkPasteApplyBtn = document.getElementById('bulk-paste-apply');
        const bulkModal = document.getElementById('bulkModal');
        const openBulkModalBtn = document.getElementById('open-bulk-modal');
        const bulkAddRowBtn = document.getElementById('bulk-add-row');
        const bulkSaveBtn = document.getElementById('bulk-save');
        const bulkCloseBtn = document.getElementById('bulk-close');
        const bulkTableBody = document.querySelector('#bulk-table tbody');
        
        
        // Current User
        let currentUser = null;
        const getUserKey = (u) => (u && (u.id || u.username || u.email || u.user || u.name)) || '';
        const getLocalPerm = (id) => { try { return JSON.parse(localStorage.getItem('perm:'+id) || '{}'); } catch { return {}; } };
        const setLocalPerm = (id, p) => localStorage.setItem('perm:'+id, JSON.stringify(p));
        const removeLocalPerm = (id) => localStorage.removeItem('perm:'+id);
        const getLocalOrders = () => { try { return JSON.parse(localStorage.getItem('orders:pending') || '[]'); } catch { return []; } };
        const setLocalOrders = (arr) => localStorage.setItem('orders:pending', JSON.stringify(arr));
        const addLocalOrder = (obj) => { const arr = getLocalOrders(); const id = 'local-'+Date.now(); arr.push({ ...obj, id }); setLocalOrders(arr); return id; };
        const updateLocalOrder = (id, obj) => { const arr = getLocalOrders(); const i = arr.findIndex(o => o.id === id); if (i >= 0) { arr[i] = { ...arr[i], ...obj, id }; setLocalOrders(arr); } };
        const removeLocalOrder = (id) => { const arr = getLocalOrders(); const next = arr.filter(o => o.id !== id); setLocalOrders(next); };
        const addLocalOrders = (list) => {
            const arr = getLocalOrders();
            const withIds = list.map(o => ({ ...o, id: 'local-'+(Date.now()+Math.floor(Math.random()*1000)) }));
            setLocalOrders(arr.concat(withIds));
            return withIds.map(x => x.id);
        };
        const normalizeOrderNum = (s) => String(s||'').trim().replace(/\s+/g,'');
        const normalizePartNumber = (s) => String(s||'').trim().toUpperCase();
        const normalizePartNumberStrict = (s) => String(s||'').toUpperCase().replace(/[^A-Z0-9]/g,'');
        const buildNotifKey = (num, pn) => `${normalizeOrderNum(num)}|${normalizePartNumber(pn)}`;
        const saveProfilePerms = async (uid, obj) => { try { await supabase.from('profiles').update({ permissions: obj, permissoes: JSON.stringify(obj) }).eq('id', uid); } catch {} };
        const existsOrderPair = async (num, pn) => {
            try {
                const n = normalizeOrderNum(num);
                const p = normalizePartNumberStrict(pn);
                if (!n || !p) return false;
                const { data } = await supabase.from('controle_pedidos').select('numero_pedido,part_number').eq('numero_pedido', n);
                const rows = data || [];
                return rows.some(r => normalizePartNumberStrict(r.part_number||'') === p);
            } catch { return false; }
        };
        const existsPartNumberExactStrict = async (pn) => {
            try {
                const p = normalizePartNumberStrict(pn);
                if (!p) return false;
                const { data } = await supabase.from('controle_pedidos').select('id').eq('part_number', p);
                return !!(data && data.length);
            } catch { return false; }
        };
        const existsOrderPairExact = async (num, pn) => {
            try {
                const n = normalizeOrderNum(num);
                const p = normalizePartNumber(pn);
                if (!n || !p) return false;
                const { data } = await supabase.from('controle_pedidos').select('id').eq('numero_pedido', n).eq('part_number', p);
                return !!(data && data.length);
            } catch { return false; }
        };
        const existsPartNumberAny = async (pn) => {
            try {
                const pRaw = String(pn||'');
                const p1 = normalizePartNumber(pRaw);
                const p2 = normalizePartNumberStrict(pRaw);
                if (!p1 && !p2) return false;
                const alt = Array.from(new Set([p1, p2, pRaw.toUpperCase(), pRaw.replace(/\//g,'-').toUpperCase(), pRaw.replace(/[\/-]/g,'').toUpperCase()])).filter(Boolean);
                const orStr = alt.map(v => `part_number.eq.${v}`).join(',');
                const { data } = await supabase.from('controle_pedidos').select('id').or(orStr);
                if (data && data.length) return true;
                const { data: likeRows } = await supabase.from('controle_pedidos').select('id').ilike('part_number', `%${p2}%`);
                return !!(likeRows && likeRows.length);
            } catch { return false; }
        };
        const DEFAULT_REQDEL_TARGETS = ['thiago.carmo@normaq.com.br','carlos.vinicius@normaq.com.br','raony.lins@normaq.com.br','alison.ferreira@normaq.com.br'];
        async function getReqDelTargets() {
            try {
                const s = localStorage.getItem('reqdel:targets');
                if (s) { const arr = JSON.parse(s); if (Array.isArray(arr) && arr.length) return arr; }
            } catch {}
            try {
                const { data } = await supabase.from('profiles').select('*').or('username.eq.thiago.carmo,username.eq.carlos.vinicius').limit(1);
                const row = (data && data[0]) || null;
                let p = row && (row.permissions ?? row.permissoes) || null;
                if (typeof p === 'string') { try { p = JSON.parse(p); } catch { p = null; } }
                const arr = (p && Array.isArray(p.request_delete_targets)) ? p.request_delete_targets : [];
                if (arr.length) return arr;
            } catch {}
            return DEFAULT_REQDEL_TARGETS;
        }
        async function saveReqDelTargets(arr) {
            try { localStorage.setItem('reqdel:targets', JSON.stringify(arr || [])); } catch {}
            try {
                if (!currentUser || !currentUser.id) return;
                const { data: row } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
                let p = row && (row.permissions ?? row.permissoes) || {};
                if (typeof p === 'string') { try { p = JSON.parse(p); } catch { p = {}; } }
                if (!p || typeof p !== 'object') p = {};
                p.request_delete_targets = arr || [];
                await supabase.from('profiles').update({ permissions: p, permissoes: JSON.stringify(p) }).eq('id', currentUser.id);
            } catch {}
        }
        async function loadReqDelEmailListUI() {
            try {
                const sel = document.getElementById('reqdel-email-select');
                if (!sel) return;
                const arr = await getReqDelTargets();
                const seen = new Set();
                const uniq = [];
                (arr||[]).forEach(function(em){ const e = String(em||'').trim().toLowerCase(); if (e && !seen.has(e)) { seen.add(e); uniq.push(e); } });
                if (!seen.has('carlos.vinicius@normaq.com.br')) { uniq.unshift('carlos.vinicius@normaq.com.br'); seen.add('carlos.vinicius@normaq.com.br'); }
                sel.innerHTML = uniq.map(function(em){ const fixed = (em==='carlos.vinicius@normaq.com.br'); return `<option value="${em}" ${fixed?'selected':''}>${em}</option>`; }).join('');
            } catch {}
        }

        async function loadArrivalEmailListUI() {
            try {
                const sel = document.getElementById('arrival-email-select');
                if (!sel) return;
                const arr = await getReqDelTargets();
                const seen = new Set();
                const uniq = [];
                (arr||[]).forEach(function(em){ const e = String(em||'').trim().toLowerCase(); if (e && !seen.has(e)) { seen.add(e); uniq.push(e); } });
                if (!seen.has('carlos.vinicius@normaq.com.br')) { uniq.unshift('carlos.vinicius@normaq.com.br'); seen.add('carlos.vinicius@normaq.com.br'); }
                sel.innerHTML = uniq.map(function(em){ const fixed = (em==='carlos.vinicius@normaq.com.br'); return `<option value="${em}" ${fixed?'selected':''}>${em}</option>`; }).join('');
            } catch {}
        }

        async function loadAdminEmailSelect() {
            try {
                const sel = document.getElementById('admin-email-list-select');
                if (!sel) return;
                const arr = await getReqDelTargets();
                const seen = new Set(); const uniq = [];
                (arr||[]).forEach(function(em){ const e = String(em||'').trim().toLowerCase(); if (e && !seen.has(e)) { seen.add(e); uniq.push(e); } });
                if (!seen.has('carlos.vinicius@normaq.com.br')) { uniq.unshift('carlos.vinicius@normaq.com.br'); seen.add('carlos.vinicius@normaq.com.br'); }
                sel.innerHTML = uniq.map(function(em){ return `<option value="${em}">${em}</option>`; }).join('');
            } catch {}
        }

        function initAdminSubTabs() {
            try {
                const container = document.getElementById('admin-tab');
                if (!container) return;
                const btns = Array.from(container.querySelectorAll('#admin-submenu [data-admin-subtab]'));
                const showFor = function(key){
                    Array.from(container.querySelectorAll('.admin-sub-content')).forEach(function(el){ el.classList.remove('show'); el.style.display = 'none'; });
                    const ids = (key === 'admin-perms') ? ['admin-perms-panel'] : (key === 'admin-supabase') ? ['admin-supabase-panel'] : (key === 'admin-users') ? ['admin-users-panel','admin-users-table-panel'] : (key === 'admin-emaillist') ? ['admin-emaillist-panel'] : [];
                    ids.forEach(function(id){ const el = container.querySelector('#'+id); if (el) { el.style.display = ''; el.classList.add('show'); } });
                    btns.forEach(function(b){ b.className = 'btn btn-secondary'; });
                    const active = btns.find(function(b){ return b.getAttribute('data-admin-subtab') === key; });
                    if (active) active.className = 'btn btn-primary';
                };
                btns.forEach(function(b){ b.addEventListener('click', function(){ const key = b.getAttribute('data-admin-subtab'); showFor(key); }); });
                showFor('admin-perms');
            } catch {}
        }
        const getLocalNotifs = (uid) => {
            try {
                const byId = JSON.parse(localStorage.getItem('notif:'+uid) || '[]');
                const uname = (currentUser && (currentUser.username||'')).toLowerCase();
                const byUser = JSON.parse(localStorage.getItem('notif:'+uname) || '[]');
                const map = new Map();
                [...byId, ...byUser].forEach(x => { const k = String(x && x.numero_pedido || ''); if (k) map.set(k, x); });
                return Array.from(map.values());
            } catch { return []; }
        };
        const setLocalNotifs = (uid, arr) => {
            try {
                localStorage.setItem('notif:'+uid, JSON.stringify(arr));
                const uname = (currentUser && (currentUser.username||'')).toLowerCase();
                if (uname) localStorage.setItem('notif:'+uname, JSON.stringify(arr));
            } catch {}
        };
        let deleteNotifyTimer = null;
        let requesterNotifyTimer = null;
        async function hashPassword(str) {
            const enc = new TextEncoder();
            const data = enc.encode(str);
            const digest = await crypto.subtle.digest('SHA-256', data);
            const bytes = Array.from(new Uint8Array(digest));
            return bytes.map(b => b.toString(16).padStart(2,'0')).join('');
        }
        (function(){
            const savedUserStr = localStorage.getItem('currentUser');
            if (savedUserStr) {
                try {
                    const savedUser = JSON.parse(savedUserStr);
                    currentUser = savedUser;
                    userInfo.textContent = `Usu√°rio: ${savedUser.username || savedUser.user || savedUser.name || ''}`;
                    loginScreen.style.display = 'none';
                    dashboard.style.display = 'block';
                    if (loginFooter) loginFooter.style.display = 'none';
                    applyPermissions();
                    loadOrders();
                    loadConsultantData();
                    loadDashboard();
                    loadOrdersForDeleteRequest();
                    loadUsersForAdmin();
                    refreshRequesterDoneToast();
                    refreshRequesterPendingToast();
                    refreshRequesterPendingBadge();
                    loadReqDelEmailListUI();
                    loadArrivalEmailListUI();
                    loadAdminEmailSelect();
                    initAdminSubTabs();
                } catch {}
            }
        })();
        (function(){
            const btn = document.getElementById('save-supabase-config');
            if (btn) {
                btn.addEventListener('click', function(){
                    const url = document.getElementById('supabase-url').value || '';
                    const key = document.getElementById('supabase-key').value || '';
                    localStorage.setItem('supabase:url', url);
                    localStorage.setItem('supabase:key', key);
                    initSupabase();
                    alert('Configura√ß√£o do Supabase salva.');
                });
            }
        })();
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Set defaults
            const currentDate = new Date();
            document.getElementById('month-filter').value = '';
            document.getElementById('consultant-month-filter').value = '';
            document.getElementById('delete-month-filter').value = '';
            document.getElementById('year-filter').value = '';
            document.getElementById('consultant-year-filter').value = '';
            document.getElementById('delete-year-filter').value = '';
            
            // Set current date in date fields
            const today = currentDate.toISOString().split('T')[0];
            document.getElementById('data_pedido').value = today;
            
            // Setup WhatsApp links
            const whatsappNumber = "5581995143900";
            const whatsappMessage = "Ol√°, preciso de suporte com o sistema de Controle de Pedidos de Emerg√™ncia.";
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(whatsappMessage)}`;
            
            whatsappLink.href = whatsappUrl;
            footerWhatsapp.href = whatsappUrl;
            if (loginFooterWhatsapp) loginFooterWhatsapp.href = whatsappUrl;
            
            // Auto-calculation setup for new order form
            setupAutoCalculations();

            const savedUserStr = localStorage.getItem('currentUser');
            if (savedUserStr) {
                const savedUser = JSON.parse(savedUserStr);
                currentUser = savedUser;
                userInfo.textContent = `Usu√°rio: ${savedUser.username}`;
                loginScreen.style.display = 'none';
                dashboard.style.display = 'block';
                if (loginFooter) loginFooter.style.display = 'none';
                applyPermissions();
                loadOrders();
                loadConsultantData();
                loadDashboard();
                loadUsersForAdmin();
                loadReqDelEmailListUI();
                loadArrivalEmailListUI();
                loadAdminEmailSelect();
                initAdminSubTabs();
            }
        });

        document.getElementById('admin_create_user_btn')?.addEventListener('click', async function(){
            const username = document.getElementById('admin_new_username')?.value || '';
            const email = document.getElementById('admin_new_email')?.value || '';
            const isAdmin = (document.getElementById('admin_new_is_admin')?.value === 'true');
            if (!username || !email) { alert('Informe usu√°rio e e-mail'); return; }
            if (!supabase || !supabase.from) { alert('Supabase n√£o configurado'); return; }
            const { data: signData, error: signErr } = await supabase.auth.signUp({ email, password: 'NMQ@123' });
            if (signErr) { alert('Erro ao cadastrar: '+(signErr.message||'')); return; }
            const uid = signData?.user?.id;
            if (!uid) { alert('Erro ao cadastrar: usu√°rio sem id'); return; }
            const payload = { id: uid, username, email };
            const { data: inserted, error } = await supabase.from('profiles').insert([payload]).select('*');
            if (error) { alert('Erro ao cadastrar: '+ (error.message||'')); return; }
            const newUser = (inserted && inserted[0]) || { id: uid, username, email };
            const key = (newUser && (newUser.id || newUser.username || newUser.email)) || username || email;
            const perms = isAdmin ? { orders: true, new_order: true, delete_order: true, admin: true, request_delete: true } : { orders: true };
            const permPayload = { ...perms, must_change_password: true };
            // try update JSON column 'permissions', fallback to 'permissoes' as string
            let updated = false; let lastErr = null;
            const tryUpdate = async (obj) => { const { error: e } = await supabase.from('profiles').update(obj).eq('id', newUser?.id); if (!e) updated = true; else lastErr = e; };
            await tryUpdate({ permissions: permPayload });
            if (!updated) await tryUpdate({ permissoes: JSON.stringify(permPayload) });
            if (!updated && key) setLocalPerm(key, permPayload);
            alert('Usu√°rio cadastrado');
            loadUsersForAdmin();
        });

        document.getElementById('admin-email-add-btn')?.addEventListener('click', async function(){
            const el = document.getElementById('admin-email-add-input');
            const v = (el && el.value || '').trim().toLowerCase();
            if (!v) { alert('Informe um e-mail'); return; }
            const arr = await getReqDelTargets();
            const set = new Set((arr||[]).map(function(x){ return String(x||'').trim().toLowerCase(); }));
            set.add(v);
            set.add('carlos.vinicius@normaq.com.br');
            const out = Array.from(set.values());
            await saveReqDelTargets(out);
            el.value = '';
            await loadReqDelEmailListUI();
            await loadArrivalEmailListUI();
            await loadAdminEmailSelect();
        });

        document.getElementById('admin-email-remove-btn')?.addEventListener('click', async function(){
            const sel = document.getElementById('admin-email-list-select');
            const v = String(sel && sel.value || '').trim().toLowerCase();
            if (!v) { alert('Selecione um e-mail para excluir'); return; }
            if (v === 'carlos.vinicius@normaq.com.br') { alert('Este e-mail √© fixo e n√£o pode ser removido'); return; }
            const arr = await getReqDelTargets();
            const out = (arr||[]).filter(function(x){ return String(x||'').trim().toLowerCase() !== v; });
            await saveReqDelTargets(out);
            await loadReqDelEmailListUI();
            await loadArrivalEmailListUI();
            await loadAdminEmailSelect();
        });

        // Login Functionality
        async function performLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                alert('Por favor, preencha usu√°rio e senha.');
                return;
            }
            
            try {
                if (!supabase || !supabase.from) {
                    const offlineUser = { id: 'local', username, is_admin: true };
                    currentUser = offlineUser;
                    localStorage.setItem('currentUser', JSON.stringify(offlineUser));
                    userInfo.textContent = `Usu√°rio: ${offlineUser.username}`;
                    loginScreen.style.display = 'none';
                    dashboard.style.display = 'block';
                    if (loginFooter) loginFooter.style.display = 'none';
                    applyPermissions();
                    loadOrders();
                    loadConsultantData();
                    loadDashboard();
                    loadUsersForAdmin();
                    loadReqDelEmailListUI();
                    loadArrivalEmailListUI();
                    loadAdminEmailSelect();
                    return;
                }
                const { data: profileRow } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('username', username)
                    .single();
                const loginEmail = profileRow?.email || (username.includes('@') ? username : '');
                if (!loginEmail) { alert('Usu√°rio n√£o encontrado.'); return; }
                const { data: authRes, error: authErr } = await supabase.auth.signInWithPassword({ email: loginEmail, password });
                if (authErr || !authRes?.user) { alert('Usu√°rio ou senha incorretos.'); return; }
                const uid = authRes.user.id;
                const { data: data } = await supabase.from('profiles').select('*').eq('id', uid).single();
                let pJson = data?.permissions ?? data?.permissoes ?? null; if (typeof pJson === 'string') { try { pJson = JSON.parse(pJson); } catch { pJson = null; } }
                const userKey = (uid || data?.id || data?.username || loginEmail);
                const localP = getLocalPerm(userKey);
                if ((data.username || '').toLowerCase() === 'thiago.carmo' || ((data.email||'').split('@')[0].toLowerCase() === 'thiago.carmo')) { data.is_admin = true; }
                currentUser = { ...data, email: loginEmail };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                userInfo.textContent = `Usu√°rio: ${currentUser.username}`;
                loginScreen.style.display = 'none';
                dashboard.style.display = 'block';
                if (loginFooter) loginFooter.style.display = 'none';
                applyPermissions();
                loadOrders();
                loadConsultantData();
                loadDashboard();
                loadOrdersForDeleteRequest();
                loadUsersForAdmin();
                await reconcileRequesterPendingWithDB();
                await refreshRequesterDoneToast();
                await refreshRequesterPendingToast();
                await refreshRequesterPendingBadge();
                refreshDeleteNotificationsIfCarlos();
                if (!deleteNotifyTimer) { deleteNotifyTimer = setInterval(refreshDeleteNotificationsIfCarlos, 30000); }
                if (!requesterNotifyTimer) { requesterNotifyTimer = setInterval(async () => { await reconcileRequesterPendingWithDB(); await refreshRequesterDoneToast(); await refreshRequesterPendingToast(); await refreshRequesterPendingBadge(); }, 30000); }
                const mustChange = ((pJson && pJson.must_change_password === true) || (localP && localP.must_change_password === true) || password === 'NMQ@123');
                if (mustChange) { openChangePasswordModal(); }
                
            } catch (error) {
                console.error('Erro no login:', error);
                alert('Erro ao fazer login. Tente novamente.');
            }
        }
        loginBtn.addEventListener('click', async function() { await performLogin(); });
        document.getElementById('password').addEventListener('keydown', function(e){ if (e.key === 'Enter') performLogin(); });
        document.getElementById('username').addEventListener('keydown', function(e){ if (e.key === 'Enter') performLogin(); });
        
        // Support Modal
        infoBtn.addEventListener('click', function() {
            supportModal.style.display = 'flex';
        });
        
        closeSupport.addEventListener('click', function() {
            supportModal.style.display = 'none';
        });
        
        // Logout
        logoutBtn.addEventListener('click', function() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            dashboard.style.display = 'none';
            loginScreen.style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            if (loginFooter) loginFooter.style.display = 'block';
        });
        
        // Tab Navigation
        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active menu item
                menuItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding tab content
                tabContents.forEach(tab => tab.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                
                // Special handling for delete order tab
                if (tabId === 'delete-order-tab') {
                    deleteContent.style.display = 'none';
                    deletePassword.value = '';
                }
                if (tabId === 'orders-tab') { loadOrders(); }
                if (tabId === 'consultant-tab') { loadConsultantData(); }
                if (tabId === 'dashboard-tab') { loadDashboard(); }
                if (tabId === 'request-delete-tab') { loadOrdersForDeleteRequest(); }
                if (tabId === 'arrival-tab') { loadArrivalParts(); }
            });
        });

        // Delete notifications modal events
        (function(){
            const closeBtn = document.getElementById('closeDeleteNotif');
            const goBtn = document.getElementById('goToDeleteArea');
            if (closeBtn) closeBtn.addEventListener('click', function(){ const m = document.getElementById('deleteNotifModal'); if (m) m.style.display='none'; });
            if (goBtn) goBtn.addEventListener('click', function(){ const m = document.getElementById('deleteNotifModal'); if (m) m.style.display='none'; const item = document.querySelector('.menu-item[data-tab="delete-order-tab"]'); if (item) item.click(); });
        })();

        // Delete Order Password Check
        deletePassword.addEventListener('input', function() {
            if (this.value === 'NMQ@2025') {
                deleteContent.style.display = 'block';
                loadOrdersForDeletion();
            } else {
                deleteContent.style.display = 'none';
            }
        });
        
        // Auto-calculation setup
        function setupAutoCalculations() {
            // B.O calculation (Atd - Qtde)
            const qtdeInput = document.getElementById('qtde');
            const atdInput = document.getElementById('atd');
            const boInput = document.getElementById('bo');
            
            function calculateBO() {
                const qtde = parseInt(qtdeInput.value) || 0;
                const atd = parseInt(atdInput.value) || 0;
                boInput.value = Math.max(0, qtde - atd);
            }
            
            qtdeInput.addEventListener('input', calculateBO);
            atdInput.addEventListener('input', calculateBO);
            
            // Custo Total calculation (Qtde * Custo UND)
            const custoUndInput = document.getElementById('custo_und');
            const custoTotalInput = document.getElementById('custo_total');
            
            function calculateCustoTotal() {
                const qtde = parseInt(qtdeInput.value) || 0;
                const custoUnd = parseFloat(custoUndInput.value) || 0;
                custoTotalInput.value = (qtde * custoUnd).toFixed(2);
            }
            
            qtdeInput.addEventListener('input', calculateCustoTotal);
            custoUndInput.addEventListener('input', calculateCustoTotal);
            
            // Previs√£o calculation based on transport and revenda
            const revendaSelect = document.getElementById('revenda');
            const transportadoraSelect = document.getElementById('transportadora');
            const faturadoInput = document.getElementById('faturado');
            const previsaoInput = document.getElementById('previsao');
            
            function calculatePrevisao() {
                const faturado = faturadoInput.value;
                const transportadora = transportadoraSelect.value;
                const revenda = revendaSelect.value;
                
                if (!faturado || !transportadora || !revenda) {
                    previsaoInput.value = '';
                    return;
                }
                
                const faturadoDate = new Date(faturado);
                let daysToAdd = 0;
                
                if (transportadora === 'Rodovi√°rio') {
                    daysToAdd = (revenda === 'Petrolina') ? 9 : 7;
                } else if (transportadora === 'A√©reo') {
                    daysToAdd = (revenda === 'Petrolina') ? 4 : 2;
                }
                
                const previsaoDate = new Date(faturadoDate);
                previsaoDate.setDate(previsaoDate.getDate() + daysToAdd);
                previsaoInput.value = previsaoDate.toISOString().split('T')[0];
            }
            
            revendaSelect.addEventListener('change', calculatePrevisao);
            transportadoraSelect.addEventListener('change', calculatePrevisao);
            faturadoInput.addEventListener('input', calculatePrevisao);
            
            // Atraso calculation (Previsao - Chegada)
            const chegadaInput = document.getElementById('chegada');
            const atrasoInput = document.getElementById('atraso');
            
            function calculateAtraso() {
                const previsao = previsaoInput.value;
                const chegada = chegadaInput.value;
                
                if (!previsao || !chegada) {
                    atrasoInput.value = '';
                    return;
                }
                
                const previsaoDate = new Date(previsao);
                const chegadaDate = new Date(chegada);
                const diffTime = Math.abs(chegadaDate - previsaoDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                atrasoInput.value = chegadaDate > previsaoDate ? diffDays : 0;
            }
            
            previsaoInput.addEventListener('input', calculateAtraso);
            chegadaInput.addEventListener('input', calculateAtraso);
            
            // Lead Time calculation (Chegada - Data)
            const dataPedidoInput = document.getElementById('data_pedido');
            const leadTimeInput = document.getElementById('lead_time');
            
            function calculateLeadTime() {
                const dataPedido = dataPedidoInput.value;
                const chegada = chegadaInput.value;
                
                if (!dataPedido || !chegada) {
                    leadTimeInput.value = '';
                    return;
                }
                
                const dataPedidoDate = new Date(dataPedido);
                const chegadaDate = new Date(chegada);
                const diffTime = Math.abs(chegadaDate - dataPedidoDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                leadTimeInput.value = diffDays;
            }
            
            dataPedidoInput.addEventListener('input', calculateLeadTime);
            chegadaInput.addEventListener('input', calculateLeadTime);
            
            // Prev. Fat. calculation (Faturado - Data)
            const prevFatInput = document.getElementById('prev_fat');
            
            function calculatePrevFat() {
                const dataPedido = dataPedidoInput.value;
                const faturado = faturadoInput.value;
                
                if (!dataPedido || !faturado) {
                    prevFatInput.value = '';
                    return;
                }
                
                const dataPedidoDate = new Date(dataPedido);
                const faturadoDate = new Date(faturado);
                const diffTime = Math.abs(faturadoDate - dataPedidoDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                prevFatInput.value = diffDays;
            }
            
            dataPedidoInput.addEventListener('input', calculatePrevFat);
            faturadoInput.addEventListener('input', calculatePrevFat);
        }
        
        // Helpers
        const toStr = (v) => v === '' ? null : v;
        const toInt = (v) => {
            if (v === '' || v == null) return null;
            const s = (''+v).replace(/[^0-9-]/g, '');
            if (s === '' || s === '-' ) return null;
            const n = parseInt(s, 10);
            return Number.isNaN(n) ? null : n;
        };
        const toFloat = (v) => parseFloatLocale(v);
        const cleanIntString = (s) => { if (s == null) return ''; return (''+s).replace(/[^0-9-]/g, ''); };
        const firstIntChunk = (s) => {
            const str = (s == null ? '' : (''+s));
            const m = str.match(/-?\d+/);
            return m ? m[0] : '';
        };
        const parseFloatLocale = (v) => {
            if (v === '' || v == null) return null;
            if (typeof v === 'number') return Number.isFinite(v) ? v : null;
            const s = (''+v).trim().replace(/\s+/g,'');
            const clean = s.replace(/[^0-9.,-]/g,'');
            const hasComma = clean.includes(',');
            const lastComma = clean.lastIndexOf(',');
            const lastDot = clean.lastIndexOf('.');
            if (hasComma && (lastComma > lastDot)) {
                const sv = clean.replace(/\./g,'').replace(/,/,'.');
                const n = parseFloat(sv);
                return Number.isNaN(n) ? null : n;
            }
            const n = parseFloat(clean);
            return Number.isNaN(n) ? null : n;
        };
        const cleanFloatString = (s) => {
            if (s == null) return '';
            const v = (''+s).trim().replace(/\s+/g,'');
            const only = v.replace(/[^0-9.,-]/g,'');
            const lastComma = only.lastIndexOf(',');
            const lastDot = only.lastIndexOf('.');
            if (lastComma > lastDot) return only.replace(/\./g,'').replace(/,/,'.');
            return only;
        };
        const formatDateDisplay = (s) => {
            if (!s) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
                const [y,m,d] = s.split('-');
                return `${d}/${m}/${y}`;
            }
            return s.replace(/\s+/g, ' ').trim();
        };
        const formatInlineText = (s) => (s || '').toString().replace(/\s+/g, ' ').trim();
        const dateColumns = ['data_pedido','faturado','previsao','chegada','prev_atd','nova_prev_atd'];
        const INT_KEYS = ['ctt_orc','qtde','atd','bo','prev_fat','nf','tw_inicial','tw_nova','atraso','lead_time'];
        function prepareForServerRow(row) {
            const out = { ...row };
            INT_KEYS.forEach(k => {
                const v = out[k];
                if (v == null || v === '') { out[k] = null; return; }
                const sv = (''+v).trim();
                if (/^-?\d+$/.test(sv)) { out[k] = parseInt(sv,10); return; }
                const chunk = firstIntChunk(sv);
                if (chunk !== '') { out[k] = parseInt(chunk,10); }
                else { out[k] = null; }
                out.obs = formatInlineText(((out.obs || '') + ' '+k+'='+sv).trim());
            });
            const floatKeys = ['custo_und','custo_total'];
            floatKeys.forEach(k => { out[k] = parseFloatLocale(out[k]); });
            const dateKeys = ['data_pedido','faturado','previsao','chegada','prev_atd','nova_prev_atd'];
            dateKeys.forEach(k => { out[k] = normalizeDateToISO?.(out[k]) || out[k] || null; });
            return out;
        }
        function extractBigintErrorValue(err) {
            const msg = (err && (err.message || err.toString())) || '';
            const m = msg.match(/invalid input syntax for type bigint:\s*"([^"]+)"/i);
            return m ? m[1] : null;
        }
        function sanitizeRowsForBigintError(rows, badVal) {
            return rows.map(r => {
                const out = { ...r };
                Object.keys(out).forEach(k => {
                    const val = out[k];
                    if (val === badVal) {
                        const hasNonDigit = /[^0-9-]/.test((''+badVal));
                        out[k] = hasNonDigit ? null : toInt(badVal);
                        out.obs = formatInlineText(((out.obs || '') + ' '+k+'='+badVal).trim());
                    } else if (INT_KEYS.includes(k) && typeof val === 'string' && /[^0-9-]/.test(val)) {
                        const chunk = firstIntChunk(val);
                        out[k] = chunk ? parseInt(chunk,10) : null;
                        out.obs = formatInlineText(((out.obs || '') + ' '+k+'='+val).trim());
                    }
                });
                return out;
            });
        }
        function fixMojibake(s) {
            if (!s || !/[√É√ÇÔøΩ]/.test(s)) return s;
            const bytes = new Uint8Array(Array.from(s, ch => ch.charCodeAt(0)));
            try { return new TextDecoder('utf-8').decode(bytes); } catch { return s; }
        }
        async function readCSVFile(file) {
            const buf = await file.arrayBuffer();
            const utf8 = new TextDecoder('utf-8').decode(buf);
            const cp1252 = new TextDecoder('windows-1252').decode(buf);
            const score = (t) => (t.match(/ÔøΩ/g)||[]).length + (t.match(/√É/g)||[]).length;
            let best = utf8;
            if (score(cp1252) < score(utf8)) best = cp1252;
            const fixed = fixMojibake(utf8);
            if (score(fixed) < score(best)) best = fixed;
            return best;
        }
        function normalizeDateToISO(s) {
            if (s == null) return null;
            const str = ('' + s).trim();
            if (str === '') return null;
            if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
            const m1 = str.match(/^([0-3]?\d)[\/\-.]([0-1]?\d)[\/\-.](\d{4})$/);
            if (m1) {
                const d = m1[1].padStart(2, '0');
                const m = m1[2].padStart(2, '0');
                const y = m1[3];
                const iso = `${y}-${m}-${d}`;
                const dt = new Date(iso);
                return Number.isNaN(dt.getTime()) ? null : iso;
            }
            const m2 = str.match(/^(\d{4})[\/\-.]([0-1]?\d)[\/\-.]([0-3]?\d)$/);
            if (m2) {
                const y = m2[1];
                const m = m2[2].padStart(2, '0');
                const d = m2[3].padStart(2, '0');
                const iso = `${y}-${m}-${d}`;
                const dt = new Date(iso);
                return Number.isNaN(dt.getTime()) ? null : iso;
            }
            const m3 = str.match(/^([0-3]?\d)[\/\-.]([0-1]?\d)[\/\-.](\d{2})$/);
            if (m3) {
                const d = m3[1].padStart(2, '0');
                const m = m3[2].padStart(2, '0');
                let y = parseInt(m3[3], 10);
                y = y + (y <= 68 ? 2000 : 1900);
                const iso = `${y}-${m}-${d}`;
                const dt = new Date(iso);
                return Number.isNaN(dt.getTime()) ? null : iso;
        }
            if (/^\d+(\.\d+)?$/.test(str)) {
                const num = Math.floor(parseFloat(str));
                const base = new Date(Date.UTC(1899, 11, 30));
                const ms = num * 24 * 60 * 60 * 1000;
                const dt = new Date(base.getTime() + ms);
                if (Number.isNaN(dt.getTime())) return '';
                const isoFull = dt.toISOString();
                return isoFull.split('T')[0];
            }
            const dt = new Date(str);
            if (Number.isNaN(dt.getTime())) return '';
            return dt.toISOString().split('T')[0];
        }
        const parseDate = (s) => {
            if (!s) return null;
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) {
                const [d, m, y] = s.split('/');
                const dstr = `${y}-${m}-${d}`;
                const dval = new Date(dstr);
                return isNaN(dval) ? null : dval;
            }
            const dval = new Date(s);
            return isNaN(dval) ? null : dval;
        };
        const daysBetween = (a, b) => {
            const da = parseDate(a);
            const db = parseDate(b);
            if (!da || !db) return null;
            const ms = db.getTime() - da.getTime();
            return Math.floor(ms / (1000*60*60*24));
        };
        const computeBO = (order) => {
            const atd = toInt(order.atd);
            const qtde = toInt(order.qtde);
            if (atd == null && qtde == null) return null;
            return (atd || 0) - (qtde || 0);
        };
        const computePrevFat = (order) => {
            const data = order.data_pedido || null;
            const fat = order.faturado || null;
            if (data && fat) return daysBetween(data, fat);
            if (data && !fat) {
                const today = new Date();
                const iso = today.toISOString().split('T')[0];
                const diff = daysBetween(data, iso);
                return diff == null ? null : -Math.abs(diff);
            }
            return null;
        };
        const setSignCell = (cell, value) => {
            cell.textContent = value == null ? '' : value;
            cell.classList.remove('sign-positive','sign-negative');
            if (value == null) return;
            if (Number(value) < 0) cell.classList.add('sign-negative'); else cell.classList.add('sign-positive');
        };
        const setSignValue = (el, value) => {
            if (!el) return;
            el.value = value == null ? '' : value;
            el.classList.remove('sign-positive','sign-negative');
            if (value == null || value === '') return;
            if (Number(value) < 0) el.classList.add('sign-negative'); else el.classList.add('sign-positive');
        };

        function updateBoPrevFatFromForm() {
            const qtdeEl = document.getElementById('qtde');
            const atdEl = document.getElementById('atd');
            const boEl = document.getElementById('bo');
            const dataEl = document.getElementById('data_pedido');
            const fatEl = document.getElementById('faturado');
            const prevFatEl = document.getElementById('prev_fat');
            const order = {
                qtde: qtdeEl?.value,
                atd: atdEl?.value,
                data_pedido: dataEl?.value,
                faturado: fatEl?.value
            };
            const boVal = computeBO(order);
            setSignValue(boEl, boVal);
            const pfVal = computePrevFat(order);
            setSignValue(prevFatEl, pfVal);
        }

        function addBulkRow(initial={}) {
            const tr = document.createElement('tr');
            const qtInit = cleanIntString(initial.qtde||'');
            const atdInit = cleanIntString(initial.atd||'');
            const boInit = cleanIntString(initial.bo||'');
            const cttInit = cleanIntString(initial.ctt_orc||'');
            const custoUndInit = cleanFloatString(initial.custo_und||'');
            tr.innerHTML = `
                <td><input type="text" data-name="revenda" class="form-control" value="${initial.revenda||''}"></td>
                <td><input type="text" data-name="numero_pedido" class="form-control" value="${initial.numero_pedido||''}"></td>
                <td><input type="text" data-name="fornecedor" class="form-control" value="${initial.fornecedor||''}"></td>
                <td><input type="date" data-name="data_pedido" class="form-control" value="${initial.data_pedido||''}"></td>
                <td><input type="text" data-name="cliente" class="form-control" value="${initial.cliente||''}"></td>
                <td><input type="number" data-name="ctt_orc" class="form-control" value="${cttInit}"></td>
                <td><input type="text" data-name="part_number" class="form-control" value="${(initial.part_number||'').replace(/,$/, '')}"></td>
                <td><input type="text" data-name="descricao" class="form-control" value="${initial.descricao||''}"></td>
                <td><input type="number" data-name="qtde" class="form-control" value="${qtInit}"></td>
                <td><input type="number" data-name="atd" class="form-control" value="${atdInit}"></td>
                <td><input type="number" data-name="bo" class="form-control" value="${boInit}" readonly></td>
                <td><input type="date" data-name="faturado" class="form-control" value="${initial.faturado||''}"></td>
                <td><input type="date" data-name="chegada" class="form-control" value="${initial.chegada||''}"></td>
                <td><input type="text" data-name="nf" class="form-control" value="${initial.nf||''}"></td>
                <td><input type="number" step="0.01" data-name="custo_und" class="form-control" value="${custoUndInit}"></td>
                <td><input type="text" data-name="transportadora" class="form-control" value="${initial.transportadora||''}"></td>
                <td><input type="date" data-name="previsao" class="form-control" value="${initial.previsao||''}"></td>
                <td><input type="number" data-name="atraso" class="form-control" value="${initial.atraso||''}"></td>
                <td><input type="number" data-name="lead_time" class="form-control" value="${initial.lead_time||''}" readonly></td>
                <td><input type="text" data-name="consultor" class="form-control" value="${initial.consultor||''}"></td>
                <td><input type="text" data-name="obs" class="form-control" value="${initial.obs||''}"></td>
                <td><input type="number" data-name="tw_inicial" class="form-control" value="${initial.tw_inicial||''}"></td>
                <td><input type="date" data-name="prev_atd" class="form-control" value="${initial.prev_atd||''}"></td>
                <td><input type="number" data-name="tw_nova" class="form-control" value="${initial.tw_nova||''}"></td>
                <td><input type="date" data-name="nova_prev_atd" class="form-control" value="${initial.nova_prev_atd||''}"></td>
                <td>
                    <select data-name="status" class="form-control">
                        <option value="Estoque" ${initial.status==='Estoque'?'selected':''}>Estoque</option>
                        <option value="Emerg√™ncia" ${initial.status==='Emerg√™ncia'?'selected':''}>Emerg√™ncia</option>
                    </select>
                </td>
                <td><button class="btn btn-danger" data-name="rm">Remover</button></td>
            `;
            const qtdeEl = tr.querySelector('input[data-name="qtde"]');
            const atdEl = tr.querySelector('input[data-name="atd"]');
            const boEl = tr.querySelector('input[data-name="bo"]');
            const custoUndEl = tr.querySelector('input[data-name="custo_und"]');
            const rmBtn = tr.querySelector('button[data-name="rm"]');
            const previsaoEl = tr.querySelector('input[data-name="previsao"]');
            const chegadaEl = tr.querySelector('input[data-name="chegada"]');
            const dataPedEl = tr.querySelector('input[data-name="data_pedido"]');
            const atrasoEl = tr.querySelector('input[data-name="atraso"]');
            const leadEl = tr.querySelector('input[data-name="lead_time"]');
            const recalc = () => {
                const boVal = computeBO({ qtde: qtdeEl.value, atd: atdEl.value });
                setSignValue(boEl, boVal);
                const prev = previsaoEl.value;
                const cheg = chegadaEl.value;
                if (prev && cheg) {
                    const pd = new Date(prev);
                    const cd = new Date(cheg);
                    const diff = Math.ceil(Math.abs(cd - pd) / (1000*60*60*24));
                    atrasoEl.value = cd > pd ? diff : 0;
                } else {
                    atrasoEl.value = '';
                }
                const dp = dataPedEl.value;
                if (dp && cheg) {
                    const dd = new Date(dp);
                    const cd = new Date(cheg);
                    const diff = Math.ceil(Math.abs(cd - dd) / (1000*60*60*24));
                    leadEl.value = diff;
                } else {
                    leadEl.value = '';
                }
            };
            qtdeEl.addEventListener('input', recalc);
            atdEl.addEventListener('input', recalc);
            custoUndEl.addEventListener('input', recalc);
            previsaoEl.addEventListener('input', recalc);
            chegadaEl.addEventListener('input', recalc);
            dataPedEl.addEventListener('input', recalc);
            rmBtn.addEventListener('click', () => tr.remove());
            bulkTableBody.appendChild(tr);
            recalc();
        }

        openBulkModalBtn?.addEventListener('click', () => { bulkTableBody.innerHTML=''; bulkModal.style.display='flex'; });
        bulkAddRowBtn?.addEventListener('click', () => addBulkRow());
        bulkCloseBtn?.addEventListener('click', () => { bulkModal.style.display='none'; });
        bulkSaveBtn?.addEventListener('click', async () => {
            const rows = Array.from(bulkTableBody.querySelectorAll('tr'));
            if (rows.length===0) { alert('Adicione ao menos uma linha.'); return; }
            const base = {
                revenda: toStr(document.getElementById('revenda').value),
                numero_pedido: toStr(document.getElementById('numero_pedido').value),
                fornecedor: toStr(document.getElementById('fornecedor').value),
                data_pedido: normalizeDateToISO(toStr(document.getElementById('data_pedido').value)),
                cliente: toStr(document.getElementById('cliente').value),
                ctt_orc: toInt(document.getElementById('ctt_orc').value),
                faturado: normalizeDateToISO(toStr(document.getElementById('faturado').value)),
                transportadora: toStr(document.getElementById('transportadora').value),
                previsao: normalizeDateToISO(toStr(document.getElementById('previsao').value)),
                chegada: normalizeDateToISO(toStr(document.getElementById('chegada').value)),
                atraso: toInt(document.getElementById('atraso').value),
                lead_time: toInt(document.getElementById('lead_time').value),
                consultor: toStr(document.getElementById('consultor').value),
                obs: toStr(document.getElementById('obs').value),
                status: toStr(document.getElementById('status').value),
                tw_inicial: toInt(document.getElementById('tw_inicial').value),
                prev_atd: normalizeDateToISO(toStr(document.getElementById('prev_atd').value)),
                tw_nova: toInt(document.getElementById('tw_nova').value),
                nova_prev_atd: normalizeDateToISO(toStr(document.getElementById('nova_prev_atd').value))
            };
            const batch = rows.map(tr => {
                const g = (name) => tr.querySelector(`input[data-name="${name}"]`) || { value: '' };
                const qtde = toInt(g('qtde').value);
                const atd = toInt(g('atd').value);
                const bo = (qtde!=null || atd!=null) ? ((atd||0)-(qtde||0)) : null;
                const custo_und = toFloat(g('custo_und').value);
                const custo_total = (custo_und!=null && qtde!=null) ? Number((custo_und*qtde).toFixed(2)) : null;
                const row = {
                    revenda: toStr(g('revenda').value) || base.revenda,
                    numero_pedido: toStr(g('numero_pedido').value) || base.numero_pedido,
                    fornecedor: toStr(g('fornecedor').value) || base.fornecedor,
                    data_pedido: normalizeDateToISO(toStr(g('data_pedido').value) || base.data_pedido),
                    cliente: toStr(g('cliente').value) || base.cliente,
                    ctt_orc: toInt(g('ctt_orc').value) ?? base.ctt_orc,
                    part_number: toStr(g('part_number').value),
                    descricao: toStr(g('descricao').value),
                    qtde, atd, bo,
                    faturado: normalizeDateToISO(toStr(g('faturado').value) || base.faturado),
                    chegada: normalizeDateToISO(toStr(g('chegada').value) || base.chegada),
                    nf: toInt(g('nf').value),
                    custo_und, custo_total,
                    transportadora: toStr(g('transportadora').value) || base.transportadora,
                    previsao: normalizeDateToISO(toStr(g('previsao').value) || base.previsao),
                    atraso: toInt(g('atraso').value) ?? base.atraso,
                    lead_time: toInt(g('lead_time').value) ?? base.lead_time,
                    consultor: toStr(g('consultor').value) || base.consultor,
                    obs: toStr(g('obs').value) || base.obs,
                    status: toStr(((tr.querySelector('select[data-name="status"]'))||{value:''}).value) || base.status,
                    tw_inicial: toInt(g('tw_inicial').value) ?? base.tw_inicial,
                    prev_atd: normalizeDateToISO(toStr(g('prev_atd').value) || base.prev_atd),
                    tw_nova: toInt(g('tw_nova').value) ?? base.tw_nova,
                    nova_prev_atd: normalizeDateToISO(toStr(g('nova_prev_atd').value) || base.nova_prev_atd)
                };
                if (row.previsao && row.chegada) {
                    const pd = new Date(row.previsao);
                    const cd = new Date(row.chegada);
                    const diff = Math.ceil(Math.abs(cd - pd) / (1000*60*60*24));
                    row.atraso = cd > pd ? diff : 0;
                }
                if (row.data_pedido && row.chegada) {
                    const dd = new Date(row.data_pedido);
                    const cd = new Date(row.chegada);
                    const diff = Math.ceil(Math.abs(cd - dd) / (1000*60*60*24));
                    row.lead_time = diff;
                }
                const pf = computePrevFat(row);
                row.prev_fat = pf==null? null : pf;
                return row;
            });
            try {
                const serverBatch = batch.map(r => prepareForServerRow(r));
                let { error } = await supabase.from('controle_pedidos').insert(serverBatch);
                if (error) {
                    const bad = extractBigintErrorValue(error);
                    if (bad) {
                        const rows2 = sanitizeRowsForBigintError(serverBatch, bad);
                        const res2 = await supabase.from('controle_pedidos').insert(rows2);
                        error = res2.error;
                    }
                }
                if (error) {
                    addLocalOrders(batch);
                    alert('Erro ao salvar no servidor: ' + (error.message || error.code || ''));
                } else {
                    alert('Itens salvos com sucesso!');
                }
                bulkModal.style.display='none';
                loadOrders();
                loadConsultantData();
            } catch(err) {
                addLocalOrders(batch);
                alert('Sem conex√£o com servidor. Itens salvos localmente.');
                bulkModal.style.display='none';
                loadOrders();
                loadConsultantData();
            }
        });

        function detectDelimiter(text) {
            const candidates = ['\t',';','|',','];
            const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
            const header = lines[0] || '';
            let best = ',';
            let bestCount = -1;
            for (const d of candidates) {
                const count = header.split(d).length;
                if (count > bestCount) { bestCount = count; best = d; }
            }
            return best;
        }
        function parseCSVText(text) {
            const delim = detectDelimiter(text);
            const clean = text.replace(/^\uFEFF/, '');
            const lines = clean.split(/\r?\n/).filter(l => l.trim() !== '');
            if (lines.length === 0) return [];
            const parseLine = (line) => {
                const out = [];
                let cur = '';
                let quoted = false;
                for (let i=0;i<line.length;i++) {
                    const ch = line[i];
                    if (ch === '"') {
                        if (quoted && line[i+1] === '"') { cur += '"'; i++; }
                        else { quoted = !quoted; }
                    } else if (ch === delim && !quoted) {
                        out.push(cur);
                        cur = '';
                    } else {
                        cur += ch;
                    }
                }
                out.push(cur);
                return out.map(v => v.trim().replace(/^"|"$/g, ''));
            };
            const normalizeHeader = (h) => {
                const s = fixMojibake(h).replace(/\u00A0/g, ' ').trim().toLowerCase();
                const noAcc = s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                return noAcc.replace(/[._]/g, ' ').replace(/\s+/g, ' ').trim();
            };
            const headersRaw = parseLine(lines[0]);
            const headers = headersRaw.map(normalizeHeader);
            const canonicalFull = [
                'Revenda','N¬∫ Pedido','Fornecedor','Data','Cliente','CTT/ORC','Part Number','Descri√ß√£o','Qtde','Atd','Faturado','Chegada','NF','Custo UND','Transportadora','Consultor','OBS','Status','TW Inicial','Prev. Atd.','TW Nova','Nova Prev. Atd.'
            ].map(normalizeHeader);
            const canonicalNoPrev = [
                'Revenda','N¬∫ Pedido','Fornecedor','Data','Cliente','CTT/ORC','Part Number','Descri√ß√£o','Qtde','Atd','Faturado','Chegada','NF','Custo UND','Transportadora','Consultor','OBS','Status','TW Inicial','TW Nova','Nova Prev. Atd.'
            ].map(normalizeHeader);
            const isCanonicalFull = headers.length >= canonicalFull.length && canonicalFull.every((h,i)=> headers[i]===h);
            const isCanonicalNoPrev = headers.length >= canonicalNoPrev.length && canonicalNoPrev.every((h,i)=> headers[i]===h);
            const idx = (names) => {
                for (const n of names) { const i = headers.indexOf(normalizeHeader(n)); if (i >= 0) return i; }
                return -1;
            };
            const map = isCanonicalFull ? {
                revenda: 0,
                numero_pedido: 1,
                fornecedor: 2,
                data_pedido: 3,
                cliente: 4,
                ctt_orc: 5,
                part_number: 6,
                descricao: 7,
                qtde: 8,
                atd: 9,
                faturado: 10,
                chegada: 11,
                nf: 12,
                custo_und: 13,
                transportadora: 14,
                consultor: 15,
                obs: 16,
                status: 17,
                tw_inicial: 18,
                prev_atd: 19,
                tw_nova: 20,
                nova_prev_atd: 21
            } : isCanonicalNoPrev ? {
                revenda: 0,
                numero_pedido: 1,
                fornecedor: 2,
                data_pedido: 3,
                cliente: 4,
                ctt_orc: 5,
                part_number: 6,
                descricao: 7,
                qtde: 8,
                atd: 9,
                faturado: 10,
                chegada: 11,
                nf: 12,
                custo_und: 13,
                transportadora: 14,
                consultor: 15,
                obs: 16,
                status: 17,
                tw_inicial: 18,
                tw_nova: 19,
                nova_prev_atd: 20
            } : {
                revenda: idx(['revenda']),
                numero_pedido: idx(['n¬∫ pedido','n¬∞ pedido','numero pedido','n√∫mero pedido','numero do pedido','n¬∫ do pedido','num pedido','numero_pedido','pedido']),
                fornecedor: idx(['fornecedor']),
                data_pedido: idx(['data','data pedido','data_pedido']),
                cliente: idx(['cliente']),
                ctt_orc: idx(['ctt/orc','ctt','orc','ctt_orc']),
                part_number: idx(['part number','part_number','pn','codigo','c√≥digo','cod']),
                descricao: idx(['descri√ß√£o','descricao','description','desc','descri√ß√£o do item','descricao do item','descri√ßao']),
                qtde: idx(['qtde','quantidade','qtd','quant','qt']),
                atd: idx(['atd','atendido','atendido qtd','atendido qtde']),
                faturado: idx(['faturado']),
                chegada: idx(['chegada']),
                nf: idx(['nf','n¬∫ nf','n¬∞ nf','num nf','numero nf','nota','n¬∫ nota','n¬∫ nota fiscal','nota fiscal','nota_fiscal','nota fiscal n¬∫','nota fiscal numero']),
                custo_und: idx(['custo und','custo_und','custo unit','custo unitario','custo unit√°rio','valor und','valor unit','preco','pre√ßo','preco unit','pre√ßo unit']),
                transportadora: idx(['transportadora']),
                previsao: idx(['previs√£o','previsao']),
                atraso: idx(['atraso']),
                lead_time: idx(['lead time','lead_time']),
                consultor: idx(['consultor']),
                obs: idx(['obs','observacao','observa√ß√£o','observacoes','observa√ß√µes']),
                status: idx(['status']),
                tw_inicial: idx(['tw inicial','tw_inicial','tw']),
                prev_atd: idx(['prev. atd.','prev atd','prev_atd']),
                tw_nova: idx(['tw nova','tw_nova']),
                nova_prev_atd: idx(['nova prev. atd.','nova prev atd','nova_prev_atd'])
            };
            const rows = [];
            for (let r = 1; r < lines.length; r++) {
                const cols = parseLine(lines[r]);
                const get = (k) => { const i = map[k]; return i >= 0 ? (cols[i] || '').trim() : ''; };
                const obj = {
                    revenda: get('revenda'),
                    numero_pedido: get('numero_pedido'),
                    fornecedor: get('fornecedor'),
                    data_pedido: normalizeDateToISO(get('data_pedido')),
                    cliente: get('cliente'),
                    ctt_orc: cleanIntString(get('ctt_orc')),
                    part_number: get('part_number').replace(/,$/, ''),
                    descricao: get('descricao'),
                    qtde: cleanIntString(get('qtde')),
                    atd: cleanIntString(get('atd')),
                    faturado: normalizeDateToISO(get('faturado')),
                    chegada: normalizeDateToISO(get('chegada')),
                    nf: cleanIntString(get('nf')),
                    custo_und: cleanFloatString(get('custo_und')),
                    transportadora: get('transportadora'),
                    status: get('status'),
                    previsao: normalizeDateToISO(get('previsao')),
                    atraso: get('atraso'),
                    lead_time: get('lead_time'),
                    consultor: get('consultor'),
                    obs: get('obs'),
                    tw_inicial: firstIntChunk(get('tw_inicial')),
                    prev_atd: normalizeDateToISO(get('prev_atd')),
                    tw_nova: firstIntChunk(get('tw_nova')),
                    nova_prev_atd: normalizeDateToISO(get('nova_prev_atd'))
                };
                const allEmpty = Object.values(obj).every(v => (v==null || v===''));
                if (!allEmpty) rows.push(obj);
            }
            return rows;
        }
        bulkDownloadTemplateBtn?.addEventListener('click', () => {
            const headers = [
                'Revenda','N¬∫ Pedido','Fornecedor','Data','Cliente','CTT/ORC',
                'Part Number','Descri√ß√£o','Qtde','Atd','Faturado','Chegada','NF','Custo UND',
                'Transportadora','Consultor','OBS','Status',
                'TW Inicial','Prev. Atd.','TW Nova','Nova Prev. Atd.'
            ];
            const csv = '\uFEFF' + headers.join(',') + '\r\n';
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'modelo_pedidos_completo.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        bulkFileInput?.addEventListener('change', async (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            const text = await readCSVFile(file);
            const items = parseCSVText(text);
            items.forEach(it => {
                it.faturado = normalizeDateToISO?.(it.faturado) || it.faturado;
                it.chegada = normalizeDateToISO?.(it.chegada) || it.chegada;
                addBulkRow(it);
            });
            e.target.value = '';
        });
        bulkPasteImportBtn?.addEventListener('click', () => { if (bulkPasteWrapper) bulkPasteWrapper.style.display = bulkPasteWrapper.style.display==='none' ? 'block' : 'none'; });
        bulkPasteApplyBtn?.addEventListener('click', () => {
            const text = (bulkPasteArea?.value || '').trim();
            if (!text) { alert('Cole o conte√∫do da planilha no campo.'); return; }
            const items = parseCSVText(text);
            items.forEach(it => {
                it.faturado = normalizeDateToISO?.(it.faturado) || it.faturado;
                it.chegada = normalizeDateToISO?.(it.chegada) || it.chegada;
                addBulkRow(it);
            });
            bulkPasteWrapper.style.display = 'none';
            bulkPasteArea.value = '';
        });

        // Load orders from Supabase
        async function loadOrders() {
            try {
                const revenda = document.getElementById('revenda-filter')?.value || '';
                let data = [];
                if (supabase && supabase.from) {
                    let query = supabase.from('controle_pedidos').select('*');
                    if (revenda) query = query.eq('revenda', revenda);
                    const res = await query;
                    if (res.error) { console.error('Erro ao carregar pedidos:', res.error); }
                    else { data = res.data || []; }
                }
                // Populate orders table
                const ordersTable = document.getElementById('orders-table').getElementsByTagName('tbody')[0];
                ordersTable.innerHTML = '';
                
                
                const merged = [...(data || []), ...getLocalOrders()];
                const filters = {
                    year: document.getElementById('year-filter')?.value || '',
                    month: document.getElementById('month-filter')?.value || '',
                    numero_pedido: document.getElementById('order-number-filter')?.value || '',
                    part_number: document.getElementById('part-number-filter')?.value || '',
                    nf: document.getElementById('nf-filter')?.value || '',
                    data_pedido: document.getElementById('date-filter')?.value || '',
                    tw: document.getElementById('tw-filter')?.value || '',
                    consultant: document.getElementById('consultant-filter')?.value || '',
                    cliente: document.getElementById('client-filter')?.value || '',
                    fornecedor: document.getElementById('supplier-filter')?.value || '',
                    transportadora: document.getElementById('shipping-filter')?.value || '',
                    revenda: revenda,
                    status: document.getElementById('status-filter')?.value || ''
                };

                const matchText = (a, b) => (a||'').toString().toLowerCase().includes((b||'').toString().toLowerCase());
                const matchEq = (a, b) => !b || (a||'') === b;
                const matchDateEq = (a, b) => !b || (normalizeDateToISO?.(a) || a || '') === b;
                const cleanDigits = (s) => (s??'').toString().replace(/\D+/g,'');
                const matchTW = (a, b) => { const A = cleanDigits(a), B = cleanDigits(b); if (!B) return true; return A === B || A.includes(B); };
                const matchYearMonth = (a, year, month) => {
                    const iso = normalizeDateToISO?.(a) || a || '';
                    if (!iso) return !(year || month);
                    const [Y,M] = iso.split('T')[0].split('-');
                    const okY = !year || year === Y;
                    const okM = !month || Number(M) === Number(month);
                    return okY && okM;
                };

                const filtered = merged.filter(order => {
                    const okRev = matchEq(order.revenda, filters.revenda);
                    const okYM = matchYearMonth(order.data_pedido, filters.year, filters.month);
                    const okNum = matchText(order.numero_pedido, filters.numero_pedido);
                    const okPn = matchText(order.part_number, filters.part_number);
                    const okNf = matchText(order.nf, filters.nf);
                    const okDate = matchDateEq(order.data_pedido, filters.data_pedido);
                    const okTW = matchTW(order.tw_inicial, filters.tw) || matchTW(order.tw_nova, filters.tw);
                    const okCons = matchText(order.consultor, filters.consultant);
                    const okCli = matchText(order.cliente, filters.cliente);
                    const okFor = matchText(order.fornecedor, filters.fornecedor);
                    const okShip = matchEq(order.transportadora, filters.transportadora);
                    const okStatus = matchEq(order.status, filters.status);
                    return okRev && okYM && okNum && okPn && okNf && okDate && okTW && okCons && okCli && okFor && okShip && okStatus;
                });

                filtered.forEach(order => {
                    const row = ordersTable.insertRow();

                    // First column: actions
                    const actionsCell = row.insertCell();
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Editar';
                    editBtn.className = 'btn btn-info';
                    editBtn.style.padding = '5px 10px';
                    editBtn.style.fontSize = '14px';
                    editBtn.addEventListener('click', function() { openEditModal(order); });
                    actionsCell.appendChild(editBtn);

                    // Add remaining data columns
                    const columns = [
                        'revenda', 'numero_pedido', 'fornecedor', 'data_pedido', 'cliente',
                        'ctt_orc', 'part_number', 'descricao', 'qtde', 'atd', 'bo',
                        'faturado', 'prev_fat', 'nf', 'custo_und', 'custo_total',
                        'transportadora', 'previsao', 'chegada', 'atraso', 'lead_time',
                        'consultor', 'obs', 'tw_inicial', 'prev_atd', 'tw_nova', 'nova_prev_atd', 'status'
                    ];

                    columns.forEach(column => {
                        const cell = row.insertCell();
                        if (column === 'bo') {
                            const val = computeBO(order);
                            const neg = (val != null && Number(val) < 0);
                            const icon = neg ? '‚ùå' : '‚úÖ';
                            const shown = val == null ? '' : (neg ? Math.abs(Number(val)) : Number(val));
                            cell.classList.add('bo-inline');
                            cell.classList.remove('sign-positive','sign-negative');
                            cell.innerHTML = val == null ? '' : `<span class="${neg ? 'sign-negative' : 'sign-positive'}">${icon}</span> <span class="${neg ? 'sign-negative' : 'sign-positive'}">${shown}</span>`;
                        } else if (column === 'prev_fat') {
                            const val = computePrevFat(order);
                            setSignCell(cell, val);
                        } else if (column === 'numero_pedido') {
                            cell.classList.add('nowrap-cell');
                            cell.textContent = formatInlineText(order[column] || '');
                        } else if (dateColumns.includes(column)) {
                            cell.classList.add('nowrap-cell');
                            cell.textContent = formatDateDisplay(order[column] || '');
                        } else {
                            cell.textContent = formatInlineText(order[column] || '');
                        }
                    });
                });
                
            } catch (error) {
                console.error('Erro ao carregar pedidos:', error);
            }
        }

        // Load consultant data from Supabase
        async function loadConsultantData() {
            try {
                const revenda = document.getElementById('consultant-revenda-filter')?.value || '';
                let data = [];
                if (supabase && supabase.from) {
                    let query = supabase.from('controle_pedidos').select('*');
                    if (revenda) query = query.eq('revenda', revenda);
                    const res = await query;
                    if (res.error) { console.error('Erro ao carregar dados do consultor:', res.error); }
                    else { data = res.data || []; }
                }
                // Populate consultant table
                const consultantTable = document.getElementById('consultant-table').getElementsByTagName('tbody')[0];
                consultantTable.innerHTML = '';
                
                
                const merged = [...(data || []), ...getLocalOrders()];
                const filters = {
                    year: document.getElementById('consultant-year-filter')?.value || '',
                    month: document.getElementById('consultant-month-filter')?.value || '',
                    numero_pedido: document.getElementById('consultant-order-number-filter')?.value || '',
                    part_number: document.getElementById('consultant-part-number-filter')?.value || '',
                    nf: document.getElementById('consultant-nf-filter')?.value || '',
                    data_pedido: document.getElementById('consultant-date-filter')?.value || '',
                    tw: document.getElementById('consultant-tw-filter')?.value || '',
                    consultant: document.getElementById('consultant-consultant-filter')?.value || '',
                    cliente: document.getElementById('consultant-client-filter')?.value || '',
                    fornecedor: document.getElementById('consultant-supplier-filter')?.value || '',
                    revenda: revenda,
                    status: document.getElementById('consultant-status-filter')?.value || ''
                };

                const matchText = (a, b) => (a||'').toString().toLowerCase().includes((b||'').toString().toLowerCase());
                const matchEq = (a, b) => !b || (a||'') === b;
                const matchDateEq = (a, b) => !b || (normalizeDateToISO?.(a) || a || '') === b;
                const cleanDigits = (s) => (s??'').toString().replace(/\D+/g,'');
                const matchTW = (a, b) => { const A = cleanDigits(a), B = cleanDigits(b); if (!B) return true; return A === B || A.includes(B); };
                const matchYearMonth = (a, year, month) => {
                    const iso = normalizeDateToISO?.(a) || a || '';
                    if (!iso) return !(year || month);
                    const [Y,M] = iso.split('T')[0].split('-');
                    const okY = !year || year === Y;
                    const okM = !month || Number(M) === Number(month);
                    return okY && okM;
                };

                const filtered = merged.filter(order => {
                    const okRev = matchEq(order.revenda, filters.revenda);
                    const okYM = matchYearMonth(order.data_pedido, filters.year, filters.month);
                    const okNum = matchText(order.numero_pedido, filters.numero_pedido);
                    const okPn = matchText(order.part_number, filters.part_number);
                    const okNf = matchText(order.nf, filters.nf);
                    const okDate = matchDateEq(order.data_pedido, filters.data_pedido);
                    const okTW = matchTW(order.tw_inicial, filters.tw) || matchTW(order.tw_nova, filters.tw);
                    const okCons = matchText(order.consultor, filters.consultant);
                    const okCli = matchText(order.cliente, filters.cliente);
                    const okFor = matchText(order.fornecedor, filters.fornecedor);
                    const okStatus = matchEq(order.status, filters.status);
                    return okRev && okYM && okNum && okPn && okNf && okDate && okTW && okCons && okCli && okFor && okStatus;
                });

                filtered.forEach(order => {
                    const row = consultantTable.insertRow();
                    
                    // Add cells for each column (limited set for consultant view)
                    const columns = [
                        'revenda', 'numero_pedido', 'data_pedido', 'cliente', 'ctt_orc', 
                        'part_number', 'descricao', 'qtde', 'atd', 'bo', 'faturado', 'prev_fat', 
                        'nf', 'previsao', 'chegada', 'consultor', 'tw_inicial', 'prev_atd', 
                        'tw_nova', 'nova_prev_atd', 'status'
                    ];
                    
                    columns.forEach(column => {
                        const cell = row.insertCell();
                        if (column === 'bo') {
                            const val = computeBO(order);
                            const neg = (val != null && Number(val) < 0);
                            const icon = neg ? '‚ùå' : '‚úÖ';
                            const shown = val == null ? '' : (neg ? Math.abs(Number(val)) : Number(val));
                            cell.classList.add('bo-inline');
                            cell.classList.remove('sign-positive','sign-negative');
                            cell.innerHTML = val == null ? '' : `<span class="${neg ? 'sign-negative' : 'sign-positive'}">${icon}</span> <span class="${neg ? 'sign-negative' : 'sign-positive'}">${shown}</span>`;
                        } else if (column === 'prev_fat') {
                            const val = computePrevFat(order);
                            setSignCell(cell, val);
                        } else if (column === 'numero_pedido') {
                            cell.classList.add('nowrap-cell');
                            cell.textContent = formatInlineText(order[column] || '');
                        } else if (dateColumns.includes(column)) {
                            cell.classList.add('nowrap-cell');
                            cell.textContent = formatDateDisplay(order[column] || '');
                        } else {
                            cell.textContent = formatInlineText(order[column] || '');
                        }
                    });
                });
                
            } catch (error) {
                console.error('Erro ao carregar dados do consultor:', error);
            }
        }

        // Load orders for deletion
        async function loadOrdersForDeletion() {
            try {
                const revenda = document.getElementById('delete-revenda-filter')?.value || '';
                let data = [];
                if (supabase && supabase.from) {
                    let query = supabase.from('controle_pedidos').select('*');
                    if (revenda) query = query.eq('revenda', revenda);
                    const res = await query;
                    if (res.error) { console.error('Erro ao carregar pedidos para exclus√£o:', res.error); }
                    else { data = res.data || []; }
                }
                // Populate delete table
                const deleteTable = document.getElementById('delete-table').getElementsByTagName('tbody')[0];
                deleteTable.innerHTML = '';
                
                
                const merged = [...(data || []), ...getLocalOrders()];
                const filters = {
                    year: document.getElementById('delete-year-filter')?.value || '',
                    month: document.getElementById('delete-month-filter')?.value || '',
                    numero_pedido: document.getElementById('delete-order-number-filter')?.value || '',
                    part_number: document.getElementById('delete-part-number-filter')?.value || '',
                    nf: document.getElementById('delete-nf-filter')?.value || '',
                    data_pedido: document.getElementById('delete-date-filter')?.value || '',
                    revenda: revenda,
                    status: document.getElementById('delete-status-filter')?.value || ''
                };

                const matchText = (a, b) => (a||'').toString().toLowerCase().includes((b||'').toString().toLowerCase());
                const matchEq = (a, b) => !b || (a||'') === b;
                const matchDateEq = (a, b) => !b || (normalizeDateToISO?.(a) || a || '') === b;
                const matchYearMonth = (a, year, month) => {
                    const iso = normalizeDateToISO?.(a) || a || '';
                    if (!iso) return !(year || month);
                    const [Y,M] = iso.split('T')[0].split('-');
                    const okY = !year || year === Y;
                    const okM = !month || Number(M) === Number(month);
                    return okY && okM;
                };

                const filtered = merged.filter(order => {
                    const okRev = matchEq(order.revenda, filters.revenda);
                    const okYM = matchYearMonth(order.data_pedido, filters.year, filters.month);
                    const okNum = matchText(order.numero_pedido, filters.numero_pedido);
                    const okPn = matchText(order.part_number, filters.part_number);
                    const okNf = matchText(order.nf, filters.nf);
                    const okDate = matchDateEq(order.data_pedido, filters.data_pedido);
                    const okStatus = matchEq(order.status, filters.status);
                    return okRev && okYM && okNum && okPn && okNf && okDate && okStatus;
                });

                filtered.forEach(order => {
                    const row = deleteTable.insertRow();
                    
                    // Add cells for basic info
                    const columns = [
                        'revenda', 'numero_pedido', 'fornecedor', 'data_pedido', 
                        'cliente', 'ctt_orc', 'part_number', 'descricao', 'qtde'
                    ];
                    const selectCell = row.insertCell();
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.className = 'delete-select';
                    cb.setAttribute('data-id', order.id);
                    selectCell.appendChild(cb);
                    
                    columns.forEach(column => {
                        const cell = row.insertCell();
                        if (column === 'numero_pedido') {
                            cell.classList.add('nowrap-cell');
                            cell.textContent = formatInlineText(order[column] || '');
                        } else if (column === 'data_pedido') {
                            cell.classList.add('nowrap-cell');
                            cell.textContent = formatDateDisplay(order[column] || '');
                        } else {
                            cell.textContent = order[column] || '';
                        }
                    });
                    
                    // Add delete button
                    const actionsCell = row.insertCell();
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Excluir';
                    deleteBtn.className = 'btn btn-danger';
                    deleteBtn.style.padding = '5px 10px';
                    deleteBtn.style.fontSize = '14px';
                    deleteBtn.addEventListener('click', function() {
                        if (confirm('Tem certeza que deseja excluir este pedido?')) {
                            deleteOrder(order.id);
                        }
                    });
                    actionsCell.appendChild(deleteBtn);
                });
                const all = document.getElementById('delete-select-all');
                if (all) {
                    all.checked = false;
                    all.onchange = function() {
                        document.querySelectorAll('#delete-table tbody input.delete-select').forEach(c => { c.checked = all.checked; });
                    };
                }
                
            } catch (error) {
                console.error('Erro ao carregar pedidos para exclus√£o:', error);
            }
        }

        async function loadOrdersForDeleteRequest() {
            try {
                const revenda = document.getElementById('reqdel-revenda-filter')?.value || '';
                let data = [];
                if (supabase && supabase.from) {
                    let query = supabase.from('controle_pedidos').select('*');
                    if (revenda) query = query.eq('revenda', revenda);
                    const res = await query;
                    if (!res.error) data = res.data || [];
                }
                const merged = [...(data || []), ...getLocalOrders()];
                const filters = {
                    year: document.getElementById('reqdel-year-filter')?.value || '',
                    month: document.getElementById('reqdel-month-filter')?.value || '',
                    numero_pedido: document.getElementById('reqdel-order-number-filter')?.value || '',
                    part_number: document.getElementById('reqdel-part-number-filter')?.value || '',
                    nf: document.getElementById('reqdel-nf-filter')?.value || '',
                    data_pedido: document.getElementById('reqdel-date-filter')?.value || '',
                    revenda: revenda,
                    status: document.getElementById('reqdel-status-filter')?.value || ''
                };
                const matchText = (a, b) => (a||'').toString().toLowerCase().includes((b||'').toString().toLowerCase());
                const matchEq = (a, b) => !b || (a||'') === b;
                const matchDateEq = (a, b) => !b || (normalizeDateToISO?.(a) || a || '') === b;
                const matchYearMonth = (a, year, month) => {
                    const iso = normalizeDateToISO?.(a) || a || '';
                    if (!iso) return !(year || month);
                    const [Y,M] = iso.split('T')[0].split('-');
                    const okY = !year || year === Y;
                    const okM = !month || Number(M) === Number(month);
                    return okY && okM;
                };
                const filtered = merged.filter(order => {
                    const okRev = matchEq(order.revenda, filters.revenda);
                    const okYM = matchYearMonth(order.data_pedido, filters.year, filters.month);
                    const okNum = matchText(order.numero_pedido, filters.numero_pedido);
                    const okPn = matchText(order.part_number, filters.part_number);
                    const okNf = matchText(order.nf, filters.nf);
                    const okDate = matchDateEq(order.data_pedido, filters.data_pedido);
                    const okStatus = matchEq(order.status, filters.status);
                    return okRev && okYM && okNum && okPn && okNf && okDate && okStatus;
                });
                const table = document.getElementById('request-delete-table').getElementsByTagName('tbody')[0];
                table.innerHTML = '';
                filtered.forEach(order => {
                    const row = table.insertRow();
                    const cbCell = row.insertCell();
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.className = 'request-select';
                    cb.setAttribute('data-id', order.id);
                    cbCell.appendChild(cb);
                    ['revenda','numero_pedido','cliente','nf','fornecedor','data_pedido','part_number','descricao'].forEach(col => {
                        const cell = row.insertCell();
                        if (col === 'data_pedido') { cell.classList.add('nowrap-cell'); cell.textContent = formatDateDisplay(order[col] || ''); }
                        else if (col === 'numero_pedido') { cell.classList.add('nowrap-cell'); cell.textContent = formatInlineText(order[col] || ''); }
                        else { cell.textContent = formatInlineText(order[col] || ''); }
                    });
                });
                const all = document.getElementById('reqdel-select-all');
                if (all) { all.checked = false; all.onchange = function() { document.querySelectorAll('#request-delete-table tbody input.request-select').forEach(c => { c.checked = all.checked; }); }; }
            } catch(e) {}
        }

        function buildDeleteRequestMessage(selected) {
            const count = selected.length;
            const intro = '<p>Prezados,</p>';
            const header = count === 1
                ? '<p>Solicito a exclus√£o do pedido abaixo.</p>'
                : `<p>Solicito a exclus√£o dos ${count} pedidos abaixo.</p>`;
            const blocks = selected.map(o => {
                const num = formatInlineText(o.numero_pedido || '');
                const cli = formatInlineText(o.cliente || '');
                const rev = formatInlineText(o.revenda || '');
                const nf  = formatInlineText(o.nf || '');
                const pn  = formatInlineText(o.part_number || '');
                return `<p><strong>N√∫mero do Pedido:</strong> ${num}<br><strong>Cliente:</strong> ${cli}<br><strong>Revenda:</strong> ${rev}<br><strong>NF:</strong> ${nf}<br><strong>Part Number:</strong> ${pn}</p>`;
            }).join('<br>');
            const closing = '<p>Aguardo confirma√ß√£o.</p><p>Atenciosamente,<br>Sistema de Controle de Pedidos de Emerg√™ncia</p>';
            return `${intro}${header}${blocks}${closing}`;
        }

        async function sendDeleteRequestEmail() {
            try {
                const cbs = Array.from(document.querySelectorAll('#request-delete-table tbody input.request-select:checked'));
                if (cbs.length === 0) { alert('Selecione ao menos um pedido'); return; }
                const ids = cbs.map(cb => cb.getAttribute('data-id'));
                const allRows = Array.from(document.querySelectorAll('#request-delete-table tbody tr'));
                const selectedOrders = allRows.filter(tr => ids.includes(tr.querySelector('input.request-select').getAttribute('data-id'))).map(tr => {
                    const tds = tr.querySelectorAll('td');
                    return {
                        revenda: tds[1]?.textContent || '',
                        numero_pedido: tds[2]?.textContent || '',
                        cliente: tds[3]?.textContent || '',
                        nf: tds[4]?.textContent || '',
                        fornecedor: tds[5]?.textContent || '',
                        data_pedido: tds[6]?.textContent || '',
                        part_number: tds[7]?.textContent || '',
                        descricao: tds[8]?.textContent || ''
                    };
                });
                const message = buildDeleteRequestMessage(selectedOrders);
                const sel = document.getElementById('reqdel-email-select');
                const chosen = String(sel?.value||'').toLowerCase();
                const uniq = Array.from(new Set([chosen].filter(Boolean)));
                if (!uniq.includes('carlos.vinicius@normaq.com.br')) uniq.push('carlos.vinicius@normaq.com.br');
                if (!uniq.length) { alert('Selecione ao menos um destinat√°rio'); return; }
                if (window.emailjs && emailjs.init) { try { emailjs.init({ publicKey: (localStorage.getItem('emailjs_public_key') || 'TEMODpZYq_yR5526T') }); } catch {} }
                let ok = true;
                for (const to of uniq) {
                    const params = { to_email: to, message_html: message };
                    try { const res = await emailjs.send((localStorage.getItem('emailjs_service_id') || 'service_25zhgag'), (localStorage.getItem('emailjs_template_id') || 'template_84afe3f'), params); if (!(res && res.status === 200)) ok = false; } catch { ok = false; }
                }
                if (ok) {
                    alert('Solicita√ß√£o enviada com sucesso!');
                    // marca pedidos como solicitados para exclus√£o no banco (para notifica√ß√£o confi√°vel)
                    if (supabase && supabase.from) {
                        for (const id of ids) {
                            try { await supabase.from('controle_pedidos').update({ status: 'Solicita√ß√£o de Exclus√£o' }).eq('id', id); } catch {}
                        }
                    }
                    await addDeleteRequestNotifications(selectedOrders);
                    await addRequesterPendingNotifications(selectedOrders);
                    await refreshRequesterPendingToast();
                    await refreshRequesterPendingBadge();
                    await refreshDeleteNotificationsIfCarlos();
                }
                else { alert('Falha ao enviar solicita√ß√£o'); }
            } catch(e) { alert('Erro ao enviar solicita√ß√£o'); }
        }

        async function addDeleteRequestNotifications(orders) {
            try {
                const { data: carlos } = await supabase.from('profiles').select('*').eq('username','carlos.vinicius').single();
                if (!carlos || !carlos.id) return;
                let pJson = carlos.permissions ?? carlos.permissoes ?? {};
                if (typeof pJson === 'string') { try { pJson = JSON.parse(pJson); } catch { pJson = {}; } }
                const existing = Array.isArray(pJson.delete_requests) ? pJson.delete_requests : [];
                const map = new Map(existing.map(o => [buildNotifKey(o.numero_pedido||'', o.part_number||''), { ...o, numero_pedido: normalizeOrderNum(o.numero_pedido||''), part_number: normalizePartNumber(o.part_number||'') }]));
                orders.forEach(o => { const k = buildNotifKey(o.numero_pedido||'', o.part_number||''); map.set(k, { ...o, numero_pedido: normalizeOrderNum(o.numero_pedido||''), part_number: normalizePartNumber(o.part_number||''), status: 'pending', created_at: new Date().toISOString() }); });
                const next = Array.from(map.values());
                const newPerm = { ...(pJson||{}), delete_requests: next };
                try { await saveProfilePerms(carlos.id, newPerm); } catch {}
                try { setLocalPerm(carlos.id, newPerm); } catch {}
                setLocalNotifs(carlos.id, next);

                // tamb√©m notificar Thiago
                try {
                    const { data: thiago } = await supabase.from('profiles').select('*').eq('username','thiago.carmo').single();
                    if (thiago && thiago.id) {
                        let tPerm = thiago.permissions ?? thiago.permissoes ?? {};
                        if (typeof tPerm === 'string') { try { tPerm = JSON.parse(tPerm); } catch { tPerm = {}; } }
                        const tExisting = Array.isArray(tPerm.delete_requests) ? tPerm.delete_requests : [];
                        const tMap = new Map(tExisting.map(o => [buildNotifKey(o.numero_pedido||'', o.part_number||''), { ...o, numero_pedido: normalizeOrderNum(o.numero_pedido||''), part_number: normalizePartNumber(o.part_number||'') }]));
                        orders.forEach(o => { const k = buildNotifKey(o.numero_pedido||'', o.part_number||''); tMap.set(k, { ...o, numero_pedido: normalizeOrderNum(o.numero_pedido||''), part_number: normalizePartNumber(o.part_number||''), status: 'pending', created_at: new Date().toISOString() }); });
                        const tNext = Array.from(tMap.values());
                        const tNewPerm = { ...(tPerm||{}), delete_requests: tNext };
                        try { await saveProfilePerms(thiago.id, tNewPerm); } catch {}
                        try { setLocalPerm(thiago.id, tNewPerm); } catch {}
                        setLocalNotifs(thiago.id, tNext);
                    }
                } catch {}
            } catch {}
        }

        async function addRequesterPendingNotifications(orders) {
            try {
                if (!currentUser || !currentUser.id) return;
                const { data: prof } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
                if (!prof || !prof.id) return;
                let pJson = prof.permissions ?? prof.permissoes ?? {};
                if (typeof pJson === 'string') { try { pJson = JSON.parse(pJson); } catch { pJson = {}; } }
                const existing = Array.isArray(pJson.delete_requested) ? pJson.delete_requested : [];
                const map = new Map(existing.map(o => [buildNotifKey(o.numero_pedido||'', o.part_number||''), { ...o, numero_pedido: normalizeOrderNum(o.numero_pedido||''), part_number: normalizePartNumber(o.part_number||''), status: 'pending' }]));
                orders.forEach(o => {
                    const num = normalizeOrderNum(o.numero_pedido||'');
                    const pn  = normalizePartNumber(o.part_number||'');
                    const k   = buildNotifKey(num, pn);
                    map.set(k, { numero_pedido: num, part_number: pn, status: 'pending', created_at: new Date().toISOString() });
                });
                const next = Array.from(map.values());
                const newPerm = { ...(pJson||{}), delete_requested: next };
                try { await saveProfilePerms(prof.id, newPerm); } catch {}
                setLocalNotifs(currentUser.id, next);
            } catch {}
        }

        async function refreshDeleteNotificationsIfCarlos() {
            try {
                const el = document.getElementById('delete-notify');
                if (!el) return;
                let perms = currentUser && (currentUser.permissions ?? currentUser.permissoes ?? getLocalPerm(getUserKey(currentUser))) || {};
                if (typeof perms === 'string') { try { perms = JSON.parse(perms); } catch { perms = {}; } }
                const isAdmin = !!(currentUser && (currentUser.is_admin === true || (currentUser.role||'').toLowerCase() === 'admin'));
                const uname = (currentUser && (currentUser.username||'')).toLowerCase();
                const canDelete = isAdmin || !!perms.delete_order || uname === 'carlos.vinicius' || uname === 'thiago.carmo';
                if (!canDelete) { el.style.display = 'none'; el.classList.remove('bell-blink'); return; }
                // contabiliza pedidos com status espec√≠fico
                let pedidos = [];
                if (supabase && supabase.from) {
                    try {
                        const { data } = await supabase.from('controle_pedidos').select('numero_pedido,part_number,status').eq('status','Solicita√ß√£o de Exclus√£o');
                        pedidos = (data||[]).map(r => ({ numero_pedido: normalizeOrderNum(r.numero_pedido), part_number: normalizePartNumber(r.part_number), status: r.status }));
                    } catch {}
                }
                const supaSet = new Set(pedidos.map(x => buildNotifKey(x.numero_pedido||'', x.part_number||'')));
                const localList = getLocalNotifs(currentUser.id)
                    .filter(x => (x.status||'pending') === 'pending')
                    .map(x => ({ ...x, numero_pedido: normalizeOrderNum(x.numero_pedido||''), part_number: normalizePartNumber(x.part_number||'') }))
                    .filter(x => supaSet.has(buildNotifKey(x.numero_pedido, x.part_number)));
                const map = new Map();
                pedidos.forEach(x => { map.set(buildNotifKey(x.numero_pedido||'', x.part_number||''), x); });
                localList.forEach(x => { map.set(buildNotifKey(x.numero_pedido||'', x.part_number||''), x); });
                const list = Array.from(map.values());
                if (list.length === 0) { el.style.display = 'none'; el.classList.remove('bell-blink'); return; }
                const nums = list.map(x => `${x.numero_pedido}${x.part_number ? ' ('+x.part_number+')' : ''}`).filter(Boolean).join(', ');
                window.deleteNotifList = list;
                el.classList.add('bell-blink');
                el.innerHTML = `<i class="fas fa-bell"></i> ${list.length}`;
                el.title = `Pedidos pendentes: ${nums}`;
                el.style.display = '';
                el.onclick = function(){ const modal = document.getElementById('deleteNotifModal'); const body = document.getElementById('deleteNotifBody'); if (!modal || !body) return; body.innerHTML = list.map(x => `<div style='border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:8px;'><strong>Pedido:</strong> ${formatInlineText(x.numero_pedido||'')}<br><strong>Part Number:</strong> ${formatInlineText(x.part_number||'')}<br><strong>Status:</strong> <span class='status-pendente'>Pendente</span></div>`).join('') || '<p>Sem solicita√ß√µes pendentes.</p>'; modal.style.display = 'flex'; };
                if (!window.hasShownDeleteToast) { showDeleteToast(list.length); window.hasShownDeleteToast = true; }
            } catch {}
        }

        function showDeleteToast(count) {
            const toast = document.getElementById('deleteToast');
            const msg = document.getElementById('deleteToastMsg');
            const container = document.querySelector('.header-right');
            if (!toast || !msg || !container) return;
            msg.textContent = `Voc√™ tem ${count} pedido(s) pendente(s) para exclus√£o.`;
            try { container.appendChild(toast); } catch {}
            toast.style.display = '';
        }
        document.getElementById('closeDeleteToast')?.addEventListener('click', function(){ const t = document.getElementById('deleteToast'); if (t) t.style.display='none'; });
        document.getElementById('toastGoDelete')?.addEventListener('click', function(){ const t = document.getElementById('deleteToast'); if (t) t.style.display='none'; const item = document.querySelector('.menu-item[data-tab="delete-order-tab"]'); if (item) item.click(); });

        async function refreshRequesterDoneToast() {
            try {
                if (!currentUser || !currentUser.id) return;
                const { data } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
                let pJson = data?.permissions ?? data?.permissoes ?? null;
                if (typeof pJson === 'string') { try { pJson = JSON.parse(pJson); } catch { pJson = null; } }
                const done = (pJson && Array.isArray(pJson.delete_done)) ? pJson.delete_done : [];
                if (!done.length) { const t = document.getElementById('deleteDoneToast'); if (t) t.style.display='none'; return; }
                window.latestDoneList = done;
                try {
                    const keysFull = done.map(x => buildNotifKey(x.numero_pedido||'', x.part_number||''));
                    const keysBare = done.map(x => buildNotifKey(x.numero_pedido||'', ''));
                    const keysSet = new Set([...keysFull, ...keysBare]);
                    const req = Array.isArray(pJson.delete_requested) ? pJson.delete_requested : [];
                    const nextReq = req.filter(r => !(keysSet.has(buildNotifKey(r.numero_pedido||'', r.part_number||'')) || keysSet.has(buildNotifKey(r.numero_pedido||'', ''))));
                    if (nextReq.length !== req.length) {
                        const nextObj = { ...(pJson||{}), delete_requested: nextReq };
                        try { await saveProfilePerms(currentUser.id, nextObj); } catch {}
                    }
                    const local = getLocalNotifs(currentUser.id) || [];
                    const localFiltered = local.filter(o => !(keysSet.has(buildNotifKey(o.numero_pedido||'', o.part_number||'')) || keysSet.has(buildNotifKey(o.numero_pedido||'', ''))));
                    setLocalNotifs(currentUser.id, localFiltered);
                } catch {}
                showDeleteDoneToast(done);
            } catch {}
        }
        function showDeleteDoneToast(items) {
            const toast = document.getElementById('deleteDoneToast');
            const msg = document.getElementById('deleteDoneToastMsg');
            const title = document.getElementById('deleteDoneToastTitle');
            const container = document.querySelector('.header-right');
            if (!toast || !msg || !container) return;
            const list = (items||[]).map(x => `${x.numero_pedido}${(x.part_number||'') ? ' ('+x.part_number+')' : ''}`).filter(Boolean);
            const n = list.length;
            if (title) title.textContent = n === 1 ? 'Pedido Atendido' : 'Pedidos Atendidos';
            msg.textContent = n === 1
                ? `Pedido Atendido, foi exclu√≠do com sucesso: ${list.join(', ')}.`
                : `Pedidos Atendidos, foram exclu√≠dos com sucesso: ${list.join(', ')}.`;
            try { container.appendChild(toast); } catch {}
            toast.style.display = '';
        }
        async function clearRequesterDoneNotifications() {
            try {
                if (!currentUser || !currentUser.id) return;
                const { data } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
                let pJson = data?.permissions ?? data?.permissoes ?? {};
                if (typeof pJson === 'string') { try { pJson = JSON.parse(pJson); } catch { pJson = {}; } }
                const next = { ...(pJson||{}), delete_done: [] };
                try { await saveProfilePerms(currentUser.id, next); } catch {}
                try {
                    const latest = window.latestDoneList || [];
                    const keysFull = latest.map(x => buildNotifKey(x.numero_pedido||'', x.part_number||''));
                    const keysBare = latest.map(x => buildNotifKey(x.numero_pedido||'', ''));
                    const keys = new Set([...(keysFull||[]), ...(keysBare||[])]);
                    const local = (getLocalNotifs(currentUser.id) || []);
                    const filtered = local.filter(o => !keys.has(buildNotifKey(o.numero_pedido||'', o.part_number||'')) && !keys.has(buildNotifKey(o.numero_pedido||'', '')));
                    setLocalNotifs(currentUser.id, filtered);
                } catch {}
            } catch {}
        }
        document.getElementById('closeDeleteDoneToast')?.addEventListener('click', async function(){ const t = document.getElementById('deleteDoneToast'); if (t) t.style.display='none'; await clearRequesterDoneNotifications(); });
        document.getElementById('toastDoneOk')?.addEventListener('click', async function(){ const t = document.getElementById('deleteDoneToast'); if (t) t.style.display='none'; await clearRequesterDoneNotifications(); });

        async function refreshRequesterPendingToast() {
            try {
                if (!currentUser || !currentUser.id) return;
                let perms = currentUser && (currentUser.permissions ?? currentUser.permissoes ?? getLocalPerm(getUserKey(currentUser))) || {};
                if (typeof perms === 'string') { try { perms = JSON.parse(perms); } catch { perms = {}; } }
                const isAdmin = !!(currentUser && (currentUser.is_admin === true || (currentUser.role||'').toLowerCase() === 'admin'));
                const uname = (currentUser && (currentUser.username||'')).toLowerCase();
                const hideToast = isAdmin || uname === 'carlos.vinicius';
                if (hideToast) { const t = document.getElementById('requesterPendingToast'); if (t) t.style.display='none'; return; }
                const { data } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
                let pJson = data?.permissions ?? data?.permissoes ?? null;
                if (typeof pJson === 'string') { try { pJson = JSON.parse(pJson); } catch { pJson = null; } }
                try { await reconcileRequesterPendingWithDB(); } catch {}
                try {
                    const { data: d2 } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
                    pJson = d2?.permissions ?? d2?.permissoes ?? pJson;
                    if (typeof pJson === 'string') { try { pJson = JSON.parse(pJson); } catch {} }
                } catch {}
                let req = (pJson && Array.isArray(pJson.delete_requested)) ? pJson.delete_requested : [];
                const done = (pJson && Array.isArray(pJson.delete_done)) ? pJson.delete_done : [];
                if (done.length && req.length) {
                    const keysFull = done.map(x => buildNotifKey(x.numero_pedido||'', x.part_number||''));
                    const keysBare = done.map(x => buildNotifKey(x.numero_pedido||'', ''));
                    const keysSet = new Set([...keysFull, ...keysBare]);
                    const filteredReq = req.filter(r => !(keysSet.has(buildNotifKey(r.numero_pedido||'', r.part_number||'')) || keysSet.has(buildNotifKey(r.numero_pedido||'', ''))));
                    if (filteredReq.length !== req.length) {
                        req = filteredReq;
                        const nextObj = { ...(pJson||{}), delete_requested: filteredReq };
                        try { await saveProfilePerms(currentUser.id, nextObj); } catch {}
                        try {
                            const local = getLocalNotifs(currentUser.id) || [];
                            const localFiltered = local.filter(o => !(keysSet.has(buildNotifKey(o.numero_pedido||'', o.part_number||'')) || keysSet.has(buildNotifKey(o.numero_pedido||'', ''))));
                            setLocalNotifs(currentUser.id, localFiltered);
                        } catch {}
                    }
                }
                if (req.length) {
                    try {
                        const removed = [];
                        const kept = [];
                        for (const r of req) {
                            const num = normalizeOrderNum(r.numero_pedido||'');
                            const pn  = normalizePartNumber(r.part_number||'');
                            const pnExists = await existsPartNumberExactStrict(pn);
                            const pairExists = (await existsOrderPair(num, pn)) || (await existsOrderPairExact(num, pn));
                            if (!pnExists || !pairExists) { removed.push({ ...r, numero_pedido: num, part_number: pn }); } else { kept.push({ ...r, numero_pedido: num, part_number: pn }); }
                        }
                        if (removed.length) {
                            req = kept;
                            const nextObj = { ...(pJson||{}), delete_requested: kept, delete_done: [ ...(done||[]), ...removed ] };
                            try { await saveProfilePerms(currentUser.id, nextObj); pJson = nextObj; } catch {}
                            const keysRemoved = new Set([
                                ...removed.map(x => buildNotifKey(x.numero_pedido||'', x.part_number||'')),
                                ...removed.map(x => buildNotifKey(x.numero_pedido||'', ''))
                            ]);
                            try {
                                const local = getLocalNotifs(currentUser.id) || [];
                                const localFiltered = local.filter(o => !(keysRemoved.has(buildNotifKey(normalizeOrderNum(o.numero_pedido||''), normalizePartNumber(o.part_number||''))) || keysRemoved.has(buildNotifKey(normalizeOrderNum(o.numero_pedido||''), ''))));
                                setLocalNotifs(currentUser.id, localFiltered);
                            } catch {}
                            showDeleteDoneToast(removed);
                            try { await refreshRequesterPendingBadge(); } catch {}
                        }
                    } catch {}
                }
                if (!req.length) {
                    try {
                        const local = (getLocalNotifs(currentUser.id) || []).filter(x => (x.status||'pending') === 'pending');
                        const kept = [];
                        for (const r of local) {
                            const num = normalizeOrderNum(r.numero_pedido||'');
                            const pn  = normalizePartNumber(r.part_number||'');
                            const pairExists = (await existsOrderPair(num, pn)) || (await existsOrderPairExact(num, pn));
                            if (pairExists) kept.push({ ...r, numero_pedido: num, part_number: pn });
                        }
                        req = kept;
                    } catch { req = []; }
                }
                const toast = document.getElementById('requesterPendingToast');
                const msg = document.getElementById('requesterPendingToastMsg');
                if (!toast || !msg) return;
                if (!req.length) { toast.style.display='none'; return; }
                const nums = req.map(x => `${x.numero_pedido}${(x.part_number||'') ? ' ('+x.part_number+')' : ''}`).filter(Boolean).join(', ');
                msg.textContent = `Voc√™ possui ${req.length} solicita√ß√£o(√µes) pendente(s): ${nums}.`;
                const container = document.querySelector('.header-right');
                try { container.appendChild(toast); } catch {}
                toast.style.display = '';
            } catch {}
        }
        document.getElementById('closeRequesterPendingToast')?.addEventListener('click', function(){ const t = document.getElementById('requesterPendingToast'); if (t) t.style.display='none'; });
        document.getElementById('toastPendingOk')?.addEventListener('click', function(){ const t = document.getElementById('requesterPendingToast'); if (t) t.style.display='none'; });

        async function refreshRequesterPendingBadge() {
            try {
                if (!currentUser || !currentUser.id) return;
                const el = document.getElementById('requester-notify');
                if (!el) return;
                let perms = currentUser && (currentUser.permissions ?? currentUser.permissoes ?? getLocalPerm(getUserKey(currentUser))) || {};
                if (typeof perms === 'string') { try { perms = JSON.parse(perms); } catch { perms = {}; } }
                const isAdmin = !!(currentUser && (currentUser.is_admin === true || (currentUser.role||'').toLowerCase() === 'admin'));
                if (isAdmin) { el.style.display='none'; el.classList.remove('bell-blink'); return; }
                const { data } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
                let pJson = data?.permissions ?? data?.permissoes ?? null;
                if (typeof pJson === 'string') { try { pJson = JSON.parse(pJson); } catch { pJson = null; } }
                try { await reconcileRequesterPendingWithDB(); } catch {}
                try {
                    const { data: d2 } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
                    pJson = d2?.permissions ?? d2?.permissoes ?? pJson;
                    if (typeof pJson === 'string') { try { pJson = JSON.parse(pJson); } catch {} }
                } catch {}
                let req = (pJson && Array.isArray(pJson.delete_requested)) ? pJson.delete_requested : [];
                const done = (pJson && Array.isArray(pJson.delete_done)) ? pJson.delete_done : [];
                if (done.length && req.length) {
                    const keysFull = done.map(x => buildNotifKey(x.numero_pedido||'', x.part_number||''));
                    const keysBare = done.map(x => buildNotifKey(x.numero_pedido||'', ''));
                    const keysSet = new Set([...keysFull, ...keysBare]);
                    req = req.filter(r => !(keysSet.has(buildNotifKey(r.numero_pedido||'', r.part_number||'')) || keysSet.has(buildNotifKey(r.numero_pedido||'', ''))));
                }
                if (req.length) {
                    try {
                        const kept = [];
                        for (const r of req) {
                            const num = normalizeOrderNum(r.numero_pedido||'');
                            const pn  = normalizePartNumber(r.part_number||'');
                            const pairExists = (await existsOrderPair(num, pn)) || (await existsOrderPairExact(num, pn));
                            if (pairExists) kept.push({ ...r, numero_pedido: num, part_number: pn });
                        }
                        req = kept;
                    } catch {}
                }
                if (!req.length) {
                    try {
                        const local = (getLocalNotifs(currentUser.id) || []).filter(x => (x.status||'pending') === 'pending');
                        const kept = [];
                        for (const r of local) {
                            const num = normalizeOrderNum(r.numero_pedido||'');
                            const pn  = normalizePartNumber(r.part_number||'');
                            const pairExists = (await existsOrderPair(num, pn)) || (await existsOrderPairExact(num, pn));
                            if (pairExists) kept.push({ ...r, numero_pedido: num, part_number: pn });
                        }
                        req = kept;
                    } catch { req = []; }
                }
                if (!req.length) { el.style.display='none'; el.classList.remove('bell-blink'); return; }
                const nums = req.map(x => `${x.numero_pedido}${(x.part_number||'') ? ' ('+x.part_number+')' : ''}`).filter(Boolean).join(', ');
                el.innerHTML = `<i class="fas fa-bell"></i> ${req.length}`;
                el.title = `Minhas solicita√ß√µes pendentes: ${nums}`;
                el.style.display = '';
                el.classList.add('bell-blink');
                el.onclick = async function(){ await refreshRequesterPendingToast(); const t = document.getElementById('requesterPendingToast'); if (t) t.style.display=''; };
            } catch {}
        }

        async function reconcileRequesterPendingWithDB() {
            try {
                if (!currentUser || !currentUser.id) return;
                const { data } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
                let pJson = data?.permissions ?? data?.permissoes ?? null;
                if (typeof pJson === 'string') { try { pJson = JSON.parse(pJson); } catch { pJson = null; } }
                let req = (pJson && Array.isArray(pJson.delete_requested)) ? pJson.delete_requested : [];
                if (!req.length) return;
                const localOrders = getLocalOrders() || [];
                const toDone = [];
                for (const r of req) {
                    const rawNum = (r?.numero_pedido || '').toString().trim();
                    const rawPn  = (r?.part_number || '').toString().trim();
                    const num    = normalizeOrderNum(rawNum);
                    const pn     = normalizePartNumber(rawPn);
                    const existsLocal = localOrders.some(o => normalizeOrderNum(o?.numero_pedido||'') === num && (!pn || normalizePartNumber(o?.part_number||'') === pn));
                    const pnExists = await existsPartNumberExactStrict(pn);
                    const pairExists = (await existsOrderPair(num, pn)) || (await existsOrderPairExact(num, pn));
                    if (!pnExists || !pairExists) toDone.push({ numero_pedido: num, part_number: pn });
                }
                if (!toDone.length) return;
                const done = (pJson && Array.isArray(pJson.delete_done)) ? pJson.delete_done : [];
                const keys = new Set([...
                    done.map(x => buildNotifKey(x.numero_pedido||'', x.part_number||'')),
                    ...done.map(x => buildNotifKey(x.numero_pedido||'', ''))
                ]);
                const mergedDone = [...done];
                for (const r of toDone) {
                    const k1 = buildNotifKey(r.numero_pedido||'', r.part_number||'');
                    const k2 = buildNotifKey(r.numero_pedido||'', '');
                    if (!keys.has(k1) && !keys.has(k2)) { mergedDone.push(r); keys.add(k1); keys.add(k2); }
                }
                const toDoneKeys = new Set([...
                    toDone.map(x => buildNotifKey(x.numero_pedido||'', x.part_number||'')),
                    ...toDone.map(x => buildNotifKey(x.numero_pedido||'', ''))
                ]);
                const nextReq = req.filter(r => !(toDoneKeys.has(buildNotifKey(r.numero_pedido||'', r.part_number||'')) || toDoneKeys.has(buildNotifKey(r.numero_pedido||'', ''))));
                const nextObj = { ...(pJson||{}), delete_done: mergedDone, delete_requested: nextReq };
                try { await saveProfilePerms(currentUser.id, nextObj); } catch {}
                const localNotifs = getLocalNotifs(currentUser.id) || [];
                const filteredLocal = localNotifs.filter(o => !(toDoneKeys.has(buildNotifKey(o.numero_pedido||'', o.part_number||'')) || toDoneKeys.has(buildNotifKey(o.numero_pedido||'', ''))));
                setLocalNotifs(currentUser.id, filteredLocal);
                if (toDone.length) showDeleteDoneToast(toDone);
            } catch {}
        }

        async function loadDashboard() {
            try {
                const revenda = document.getElementById('dash-revenda-filter')?.value || '';
                let data = [];
                if (supabase && supabase.from) {
                    let query = supabase.from('controle_pedidos').select('*');
                    if (revenda) query = query.eq('revenda', revenda);
                    const res = await query;
                    if (res.error) { } else { data = res.data || []; }
                }
                const merged = [...(data || []), ...getLocalOrders()];
                const filters = {
                    year: document.getElementById('dash-year-filter')?.value || '',
                    month: document.getElementById('dash-month-filter')?.value || '',
                    cliente: document.getElementById('dash-client-filter')?.value || '',
                    status: document.getElementById('dash-status-filter')?.value || '',
                    transportadora: document.getElementById('dash-shipping-filter')?.value || '',
                    revenda: revenda
                };
                const matchText = (a, b) => (a||'').toString().toLowerCase().includes((b||'').toString().toLowerCase());
                const matchEq = (a, b) => !b || (a||'') === b;
                const matchYearMonth = (a, year, month) => {
                    const iso = normalizeDateToISO?.(a) || a || '';
                    if (!iso) return !(year || month);
                    const [Y,M] = iso.split('T')[0].split('-');
                    const okY = !year || year === Y;
                    const okM = !month || Number(M) === Number(month);
                    return okY && okM;
                };
                const filtered = merged.filter(order => {
                    const okRev = matchEq(order.revenda, filters.revenda);
                    const okYM = matchYearMonth(order.data_pedido, filters.year, filters.month);
                    const okCli = matchText(order.cliente, filters.cliente);
                    const okShip = matchEq(order.transportadora, filters.transportadora);
                    const okStatus = matchEq(order.status, filters.status);
                    return okRev && okYM && okCli && okShip && okStatus;
                });
                const totalPedidos = filtered.length;
                document.getElementById('dash-total-pedidos').textContent = totalPedidos.toString();
                const sum = (arr, sel) => arr.reduce((acc, o) => acc + (toFloat(o[sel]) || 0), 0);
                const valorTotal = sum(filtered, 'custo_total');
                const custoUndTotal = sum(filtered, 'custo_und');
                const fmtMoney = (n) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(n || 0);
                document.getElementById('dash-valor-total').textContent = fmtMoney(valorTotal);
                document.getElementById('dash-custo-und-total').textContent = fmtMoney(custoUndTotal);
                const withDates = filtered.filter(o => o.previsao && o.chegada);
                const atendidos = withDates.filter(o => {
                    const p = normalizeDateToISO(o.previsao);
                    const c = normalizeDateToISO(o.chegada);
                    return p && c && new Date(c) <= new Date(p);
                }).length;
                const percAtendimento = withDates.length === 0 ? 0 : Math.round((atendidos / withDates.length) * 100);
                document.getElementById('dash-percent-atendimento').textContent = percAtendimento + '%';
                const emg = filtered.filter(o => (o.status || '') === 'Emerg√™ncia').length;
                const est = filtered.filter(o => (o.status || '') === 'Estoque').length;
                const baseLines = emg + est;
                const percEmergencia = baseLines === 0 ? 0 : Math.round((emg / baseLines) * 100);
                document.getElementById('dash-percent-emergencia').textContent = percEmergencia + '%';
                const filterSet = (arr, f) => arr.filter(order => {
                    const okRev = (!f.revenda || (order.revenda||'') === f.revenda);
                    const iso = normalizeDateToISO?.(order.data_pedido) || order.data_pedido || '';
                    let okYM = true;
                    if (f.year || f.month) {
                        if (!iso) okYM = false; else {
                            const [Y,M] = iso.split('T')[0].split('-');
                            okYM = (!f.year || f.year === Y) && (!f.month || Number(M) === Number(f.month));
                        }
                    }
                    const okCli = !(f.cliente) || (order.cliente||'').toString().toLowerCase().includes((f.cliente||'').toString().toLowerCase());
                    const okShip = !(f.transportadora) || (order.transportadora||'') === f.transportadora;
                    const okStatus = !(f.status) || (order.status||'') === f.status;
                    return okRev && okYM && okCli && okShip && okStatus;
                });
                const detectActiveYear = (arr) => {
                    const ys = arr.map(o => (normalizeDateToISO?.(o.data_pedido) || o.data_pedido || '').split('T')[0].split('-')[0]).filter(Boolean);
                    if (!ys.length) return '';
                    const maxY = String(Math.max(...ys.map(n => Number(n))));
                    return maxY;
                };
                let activeYear = filters.year || detectActiveYear(filtered) || '';
                
                // Garantir que temos um ano v√°lido para compara√ß√£o entre meses
                if (!activeYear && filters.month) {
                    // Se temos filtro de m√™s mas n√£o de ano, usar estrat√©gia mais inteligente
                    const yearsInData = [...new Set(filtered.map(o => {
                        const dateStr = normalizeDateToISO?.(o.data_pedido) || o.data_pedido || '';
                        return dateStr.split('T')[0].split('-')[0];
                    }).filter(y => y && y.length === 4))];
                    
                    if (yearsInData.length === 1) {
                        activeYear = yearsInData[0]; // Usar o √∫nico ano presente
                    } else {
                        // Se m√∫ltiplos anos, usar o ano mais recente com dados
                        const currentYear = new Date().getFullYear().toString();
                        const recentYear = yearsInData.includes(currentYear) ? currentYear : 
                                          Math.max(...yearsInData.map(y => Number(y))).toString();
                        activeYear = recentYear;
                    }
                    console.log('Forcing active year for month comparison:', activeYear, 'available years:', yearsInData);
                }
                console.log('Active Year detected:', activeYear, 'Filter year:', filters.year);
                const prevParamsMonth = (() => {
                    const m = filters.month;
                    if (!m) return null;
                    let py = '';
                    if (filters.year && filters.year !== '') {
                        py = String(filters.year);
                    } else {
                        py = '';
                    }
                    let pm = Number(m) - 1;
                    if (pm === 0) { pm = 12; }
                    return { ...filters, year: py, month: String(pm) };
                })();
                const prevParamsYear = (() => {
                    const y = activeYear; if (!y) return null;
                    return { ...filters, year: String(Number(y)-1) };
                })();
                const filteredPrevMonth = prevParamsMonth ? filterSet(merged, prevParamsMonth) : null;
                const filteredPrevYear = prevParamsYear ? filterSet(merged, prevParamsYear) : null;
                console.log('PREVIOUS MONTH DEBUG - Params:', prevParamsMonth, 'Data count:', filteredPrevMonth?.length || 0);
                console.log('PREVIOUS YEAR DEBUG - Params:', prevParamsYear, 'Data count:', filteredPrevYear?.length || 0);
                if (filteredPrevMonth && filteredPrevMonth.length > 0) {
                    console.log('PREVIOUS MONTH SAMPLE DATA:', filteredPrevMonth.slice(0, 3).map(o => ({
                        data_pedido: o.data_pedido,
                        custo_total: o.custo_total,
                        month: (normalizeDateToISO?.(o.data_pedido) || o.data_pedido || '').split('T')[0].split('-')[1]
                    })));
                }
                ['dash-total-pedidos-delta','dash-valor-total-delta','dash-custo-und-total-delta','dash-percent-atendimento-delta','dash-percent-emergencia-delta']
                    .forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML=''; });
                const metrics = (arr) => {
                    const countRows = arr.length;
                    const vt = sum(arr,'custo_total');
                    const cu = sum(arr,'custo_und');
                    const wd = arr.filter(o=>o.previsao && o.chegada);
                    const at = wd.filter(o => { const p=normalizeDateToISO(o.previsao), c=normalizeDateToISO(o.chegada); return p && c && new Date(c) <= new Date(p); }).length;
                    const percA = wd.length===0?0:Math.round((at/wd.length)*100);
                    const e = arr.filter(o => (o.status||'')==='Emerg√™ncia').length;
                    const s = arr.filter(o => (o.status||'')==='Estoque').length;
                    const base = e+s; const percE = base===0?0:Math.round((e/base)*100);
                    return { pedidos: countRows, valorTotal: vt, custoUnd: cu, atendidos: at, totalDatas: wd.length, percAtend: percA, emerg: e, baseLines: base, percEmerg: percE };
                };
                const prevM = filteredPrevMonth ? metrics(filteredPrevMonth) : null;
                const prevY = filteredPrevYear ? metrics(filteredPrevYear) : null;
                const renderDelta = (elId, curCount, prevCount, curValue, prevValue, isMoney=false, label='M√™s') => {
    if (prevCount == null && prevValue == null) return;
    const num = (v) => {
        if (v == null) return 0;
        if (typeof v === 'number' && Number.isFinite(v)) return v;
        const s = String(v).trim();
        const cleaned = s.replace(/R\$\s*/i,'').replace(/\./g,'').replace(/,/,'.');
        const n = parseFloat(cleaned);
        return Number.isFinite(n) ? n : 0;
    };
    const baseN = num(prevValue==null ? (prevCount==null? 0 : prevCount) : prevValue);
    const curN = num(curValue==null ? curCount : curValue);
    const diff = curN - baseN;
    const isUp = curN >= baseN;
    const diffAbs = Math.abs(diff);
    
    // CORRE√á√ÉO: C√°lculo correto da varia√ß√£o percentual
    const pctRaw = baseN === 0 ? (curN > 0 ? 100 : 0) : ((diff / baseN) * 100);
    
    const pctText = (pctRaw >= 0 ? '+' : '') + pctRaw.toFixed(1) + '%';
    const cls = diff >= 0 ? 'delta-positive' : 'delta-negative';
    const qtyText = isMoney ? fmtMoney(diffAbs) : diffAbs;
    const sign = diff >= 0 ? '+' : '-';
    const el = document.getElementById(elId); 
    if (el) el.innerHTML += (el.innerHTML ? '<br>' : '') + `<span class="${cls}">${label}: ${sign}${qtyText} (${pctText})</span>`;
};
                renderDelta('dash-total-pedidos-delta', totalPedidos, prevM?.pedidos, null, prevM?.pedidos, false, 'M√™s');
                renderDelta('dash-total-pedidos-delta', totalPedidos, prevY?.pedidos, null, prevY?.pedidos, false, 'Ano');
                console.log('VALOR TOTAL COMPARISON - Current:', valorTotal, 'Previous month:', prevM?.valorTotal);
                renderDelta('dash-valor-total-delta', null, null, valorTotal, prevM?.valorTotal, true, 'M√™s');
                renderDelta('dash-valor-total-delta', null, null, valorTotal, prevY?.valorTotal, true, 'Ano');
                renderDelta('dash-custo-und-total-delta', null, null, custoUndTotal, prevM?.custoUnd, true, 'M√™s');
                renderDelta('dash-custo-und-total-delta', null, null, custoUndTotal, prevY?.custoUnd, true, 'Ano');
                const renderPercDelta = (elId, curPerc, prev, curCount, label) => {
                    if (!prev) return;
                    const diffPP = curPerc - prev.percAtend;
                    const diffCnt = curCount - prev.atendidos;
                    const cls = diffPP >= 0 ? 'delta-positive' : 'delta-negative';
                    const qtyText = diffCnt>=0? '+'+diffCnt: ''+diffCnt;
                    const ppText = (diffPP>=0? '+'+diffPP: ''+diffPP) + ' pp';
                    const el = document.getElementById(elId); if (el) el.innerHTML += (el.innerHTML ? '<br>' : '') + `<span class="${cls}">${label}: ${qtyText} (${ppText})</span>`;
                };
                renderPercDelta('dash-percent-atendimento-delta', percAtendimento, prevM, atendidos, 'M√™s');
                renderPercDelta('dash-percent-atendimento-delta', percAtendimento, prevY, atendidos, 'Ano');
                const renderPercEmergDelta = (elId, curPerc, prev, curEmerg, label) => {
                    if (!prev) return;
                    const diffPP = curPerc - prev.percEmerg;
                    const diffCnt = curEmerg - prev.emerg;
                    const cls = diffPP >= 0 ? 'delta-positive' : 'delta-negative';
                    const qtyText = diffCnt>=0? '+'+diffCnt: ''+diffCnt;
                    const ppText = (diffPP>=0? '+'+diffPP: ''+diffPP) + ' pp';
                    const el = document.getElementById(elId); if (el) el.innerHTML += (el.innerHTML ? '<br>' : '') + `<span class="${cls}">${label}: ${qtyText} (${ppText})</span>`;
                };
                renderPercEmergDelta('dash-percent-emergencia-delta', percEmergencia, prevM, emg, 'M√™s');
                renderPercEmergDelta('dash-percent-emergencia-delta', percEmergencia, prevY, emg, 'Ano');
                const topMap = new Map();
                filtered.forEach(o => {
                    const key = (o.descricao || '').trim();
                    if (!key) return;
                    const cur = topMap.get(key) || { count: 0, custo_total: 0, qtde: 0, revendas: {}, clientes: {} };
                    cur.count += 1;
                    cur.custo_total += toFloat(o.custo_total) || 0;
                    cur.qtde += toInt(o.qtde) || 0;
                    const r = o.revenda || '';
                    const c = o.cliente || '';
                    cur.revendas[r] = (cur.revendas[r] || 0) + 1;
                    cur.clientes[c] = (cur.clientes[c] || 0) + 1;
                    topMap.set(key, cur);
                });
                const topArr = Array.from(topMap.entries()).map(([descricao, v]) => {
                    const topRev = Object.entries(v.revendas).sort((a,b)=>b[1]-a[1])[0]?.[0] || '';
                    const topCli = Object.entries(v.clientes).sort((a,b)=>b[1]-a[1])[0]?.[0] || '';
                    return { descricao, custo_total: v.custo_total, qtde: v.qtde, revenda: topRev, cliente: topCli, count: v.count };
                }).sort((a,b)=> b.count - a.count).slice(0,20);
                const tbody = document.querySelector('#dashboard-top20-table tbody');
                if (tbody) {
                    tbody.innerHTML = '';
                    topArr.forEach((row, idx) => {
                        const tr = document.createElement('tr');
                        [idx+1, row.descricao, fmtMoney(row.custo_total), row.qtde, row.revenda, row.cliente].forEach(val => {
                            const td = document.createElement('td'); td.textContent = (val==null?'':val).toString(); tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                }
                const groupBy = (arr, keySel, valSel) => {
                    const m = new Map();
                    const c = new Map();
                    arr.forEach(o => {
                        const k = keySel(o);
                        const v = valSel(o);
                        m.set(k, (m.get(k)||0) + v);
                        const n = o.numero_pedido || '';
                        if (!c.has(k)) c.set(k, new Set());
                        if (n) c.get(k).add(n);
                    });
                    return Array.from(m.entries()).map(([label,value]) => ({ label, value, count: (c.get(label)?.size || 0) }));
                };
                const only = (arr, fn) => arr.filter(fn);
                const byRevendaTotal = groupBy(filtered, o=>o.revenda||'', o=>toFloat(o.custo_total)||0).sort((a,b)=>b.value-a.value);
                const byRevendaEstoque = groupBy(only(filtered, o=> (o.status||'')==='Estoque'), o=>o.revenda||'', o=>toFloat(o.custo_total)||0).sort((a,b)=>b.value-a.value);
                const byRevendaEmerg = groupBy(only(filtered, o=> (o.status||'')==='Emerg√™ncia'), o=>o.revenda||'', o=>toFloat(o.custo_total)||0).sort((a,b)=>b.value-a.value);
                const renderBars = (id, data) => {
                    const el = document.getElementById(id); if (!el) return; el.innerHTML = '';
                    const max = Math.max(1, ...data.map(d=>d.value||0));
                    data.forEach(d => {
                        const row = document.createElement('div'); row.className='bar-row';
                        const lab = document.createElement('div'); lab.className='bar-label'; lab.textContent = d.label || '';
                        const bar = document.createElement('div'); bar.className='bar'; bar.style.width = ((d.value||0)/max*100)+'%';
                        const cnt = document.createElement('small'); cnt.textContent = (d.count||0).toString(); bar.appendChild(cnt);
                        const val = document.createElement('div'); val.className='bar-value'; val.textContent = fmtMoney(d.value||0);
                        row.appendChild(lab); row.appendChild(bar); row.appendChild(val); el.appendChild(row);
                    });
                };
                renderBars('dash-chart-revenda', byRevendaTotal);
                renderBars('dash-chart-estoque', byRevendaEstoque);
                renderBars('dash-chart-emergencia', byRevendaEmerg);
            } catch(e) {}
        }

        async function loadArrivalParts() {
            try {
                const revenda = document.getElementById('arrival-revenda-filter')?.value || '';
                let data = [];
                if (supabase && supabase.from) {
                    let query = supabase.from('controle_pedidos').select('*');
                    if (revenda) query = query.eq('revenda', revenda);
                    const res = await query;
                    if (res.error) { } else { data = res.data || []; }
                }
                const tbody = document.getElementById('arrival-table')?.getElementsByTagName('tbody')[0];
                if (!tbody) return;
                tbody.innerHTML = '';
                const merged = [...(data || []), ...getLocalOrders()];
                const filters = {
                    year: document.getElementById('arrival-year-filter')?.value || '',
                    month: document.getElementById('arrival-month-filter')?.value || '',
                    numero_pedido: document.getElementById('arrival-order-number-filter')?.value || '',
                    part_number: document.getElementById('arrival-part-number-filter')?.value || '',
                    nf: document.getElementById('arrival-nf-filter')?.value || '',
                    data_pedido: document.getElementById('arrival-date-filter')?.value || '',
                    consultant: document.getElementById('arrival-consultant-filter')?.value || '',
                    cliente: document.getElementById('arrival-client-filter')?.value || '',
                    fornecedor: document.getElementById('arrival-supplier-filter')?.value || '',
                    revenda: revenda,
                    status: document.getElementById('arrival-status-filter')?.value || 'Estoque'
                };
                const matchText = (a, b) => (a||'').toString().toLowerCase().includes((b||'').toString().toLowerCase());
                const matchEq = (a, b) => !b || (a||'') === b;
                const matchDateEq = (a, b) => !b || (normalizeDateToISO?.(a) || a || '') === b;
                const matchYearMonth = (a, year, month) => {
                    const iso = normalizeDateToISO?.(a) || a || '';
                    if (!iso) return !(year || month);
                    const [Y,M] = iso.split('T')[0].split('-');
                    const okY = !year || year === Y;
                    const okM = !month || Number(M) === Number(month);
                    return okY && okM;
                };
                const filtered = merged.filter(order => {
                    const okRev = matchEq(order.revenda, filters.revenda);
                    const okYM = matchYearMonth(order.data_pedido, filters.year, filters.month);
                    const okNum = matchText(order.numero_pedido, filters.numero_pedido);
                    const okPn = matchText(order.part_number, filters.part_number);
                    const okNf = matchText(order.nf, filters.nf);
                    const okDate = matchDateEq(order.data_pedido, filters.data_pedido);
                    const okCons = matchText(order.consultor, filters.consultant);
                    const okCli = matchText(order.cliente, filters.cliente);
                    const okFor = matchText(order.fornecedor, filters.fornecedor);
                    const okStatus = matchEq(order.status, filters.status);
                    return okRev && okYM && okNum && okPn && okNf && okDate && okCons && okCli && okFor && okStatus;
                });
                const fmt = (v) => (v==null? '' : String(v));
                const fmtDate = (v) => formatDateDisplay(v||'');
                const calcAtraso = (o) => {
                    const p = normalizeDateToISO(o.previsao);
                    const c = normalizeDateToISO(o.chegada);
                    if (!p || !c) return '';
                    const ms = new Date(c).getTime() - new Date(p).getTime();
                    const d = Math.round(ms / (1000*60*60*24));
                    return String(d);
                };
                filtered.forEach(order => {
                    const row = tbody.insertRow();
                    const sel = row.insertCell();
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.className = 'arrival-select';
                    cb.setAttribute('data-id', order.id || '');
                    cb.setAttribute('data-num', order.numero_pedido || '');
                    cb.setAttribute('data-pn', order.part_number || '');
                    sel.appendChild(cb);
                    const cols = [
                        fmt(order.numero_pedido), fmt(order.fornecedor), fmtDate(order.data_pedido), fmt(order.cliente), fmt(order.ctt_orc),
                        fmt(order.part_number), fmt(order.descricao), fmt(order.qtde), fmt(order.nf), fmt(order.custo_und),
                        fmtDate(order.previsao), fmtDate(order.chegada), calcAtraso(order), fmt(order.consultor)
                    ];
                    cols.forEach((val, idx) => { const cell = row.insertCell(); cell.textContent = val; if ([2,10,11].includes(idx)) cell.classList.add('nowrap-cell'); });
                });
            } catch {}
        }

        function buildArrivalEmailMessage(items) {
            const rows = items.map(it => `<tr>
                <td align="center">${it.numero_pedido||''}</td>
                <td align="center">${it.fornecedor||''}</td>
                <td align="center">${formatDateDisplay(it.data_pedido||'')}</td>
                <td align="center">${it.cliente||''}</td>
                <td align="center">${it.ctt_orc||''}</td>
                <td align="center">${it.part_number||''}</td>
                <td align="center">${it.descricao||''}</td>
                <td align="center">${it.qtde||''}</td>
                <td align="center">${it.nf||''}</td>
                <td align="center">${it.custo_und||''}</td>
                <td align="center">${formatDateDisplay(it.previsao||'')}</td>
                <td align="center">${formatDateDisplay(it.chegada||'')}</td>
                <td align="center">${(function(o){ const p=normalizeDateToISO(o.previsao), c=normalizeDateToISO(o.chegada); if(!p||!c) return ''; const d=Math.round((new Date(c)-new Date(p))/(1000*60*60*24)); return d; })(it)}</td>
                <td align="center">${it.consultor||''}</td>
            </tr>`).join('');
            const table = `<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; font-family:Arial, sans-serif; font-size:13px; text-align:center;">
                <thead><tr>
                    <th align="center">Pedido</th><th align="center">Fornecedor</th><th align="center">Data</th><th align="center">Cliente</th><th align="center">CTT/ORC</th>
                    <th align="center">Part Number</th><th align="center">Descri√ß√£o</th><th align="center">Qtde</th><th align="center">NF</th><th align="center">Custo UND</th>
                    <th align="center">Previs√£o</th><th align="center">Chegada</th><th align="center">Atraso</th><th align="center">Consultor</th>
                </tr></thead>
                <tbody>${rows}</tbody>
            </table>`;
            const greet = (function(){ const h = new Date().getHours(); return h < 12 ? 'Bom dia' : (h < 18 ? 'Boa tarde' : 'Boa noite'); })();
            const head = `<p>${greet},</p><p>Itens dispon√≠veis no <strong>Estoque</strong> para requisi√ß√£o.</p>`;
            const foot = `<p>Atenciosamente,<br><strong>Sistema de Controle de Pedidos</strong></p>`;
            return `${head}${table}${foot}`;
        }

        async function sendArrivalEmail() {
            try {
                const tbody = document.getElementById('arrival-table')?.getElementsByTagName('tbody')[0];
                if (!tbody) return;
                const selectedIds = Array.from(tbody.querySelectorAll('input.arrival-select'))
                    .filter(cb => cb.checked)
                    .map(cb => ({ id: cb.getAttribute('data-id')||'', numero_pedido: cb.getAttribute('data-num')||'', part_number: cb.getAttribute('data-pn')||'' }));
                if (!selectedIds.length) { alert('Selecione ao menos uma linha para enviar.'); return; }
                let selectedRows = [];
                try {
                    const ids = selectedIds.map(x => x.id).filter(Boolean);
                    if (ids.length) {
                        const { data } = await supabase.from('controle_pedidos').select('*').in('id', ids);
                        selectedRows = data || [];
                    } else {
                        const merged = [...getLocalOrders()];
                        selectedIds.forEach(x => { const r = merged.find(o => (o.numero_pedido||'') === x.numero_pedido && (o.part_number||'') === x.part_number); if (r) selectedRows.push(r); });
                    }
                } catch {}
                if (!selectedRows.length) { alert('N√£o foi poss√≠vel recuperar os itens selecionados.'); return; }
                const msg = buildArrivalEmailMessage(selectedRows);
                const input = document.getElementById('arrival-email-input');
                const raw = String(input?.value||'');
                const uniq = Array.from(new Set(raw.split(/[;,\s]+/).map(function(s){ return String(s||'').trim().toLowerCase(); }).filter(Boolean)));
                if (!uniq.length) { alert('Informe ao menos um e-mail'); return; }
                if (window.emailjs && emailjs.init) { try { emailjs.init({ publicKey: (localStorage.getItem('emailjs_public_key') || 'TEMODpZYq_yR5526T') }); } catch {} }
                const service = (localStorage.getItem('emailjs_service_id') || 'service_25zhgag');
                const template = (localStorage.getItem('emailjs_template_id') || 'template_84afe3f');
                for (const to of uniq) {
                    const params = { to_email: to, message_html: msg };
                    try { await emailjs.send(service, template, params); } catch {}
                }
                alert('E-mail enviado.');
            } catch (e) { alert('Falha ao enviar e-mail.'); }
        }
        
        // Delete order
        async function deleteOrder(orderId) {
            try {
                if ((orderId || '').startsWith('local-')) {
                    const arr = getLocalOrders();
                    const rec = arr.find(o => o.id === orderId) || {};
                    const num = rec.numero_pedido || '';
                    removeLocalOrder(orderId);
                    await clearDeleteRequestNotifications([num]);
                    alert('Pedido local exclu√≠do.');
                    loadOrdersForDeletion();
                    loadOrders();
                    loadConsultantData();
                    await refreshDeleteNotificationsIfCarlos();
                    return;
                }
                let num = '';
                let pn = '';
                try {
                    const { data: rec } = await supabase.from('controle_pedidos').select('id,numero_pedido,part_number').eq('id', orderId).single();
                    num = rec?.numero_pedido || '';
                    pn = rec?.part_number || '';
                } catch {}
                const { error } = await supabase
                    .from('controle_pedidos')
                    .delete()
                    .eq('id', orderId);
                
                if (error) {
                    console.error('Erro ao excluir pedido:', error);
                    alert('Erro ao excluir pedido.');
                    return;
                }
                
                await clearDeleteRequestNotifications([{ numero_pedido: num, part_number: pn }]);
                await notifyRequestersOfDeletion([{ numero_pedido: num, part_number: pn }]);
                alert('Pedido exclu√≠do com sucesso.');
                loadOrdersForDeletion();
                loadOrders();
                loadConsultantData();
                await refreshDeleteNotificationsIfCarlos();
                
            } catch (error) {
                console.error('Erro ao excluir pedido:', error);
                alert('Erro ao excluir pedido.');
            }
        }

        async function deleteSelectedOrders() {
            try {
                const cbs = Array.from(document.querySelectorAll('#delete-table tbody input.delete-select'));
                const ids = cbs.filter(cb => cb.checked).map(cb => cb.getAttribute('data-id'));
                if (ids.length === 0) { alert('Selecione ao menos um pedido.'); return; }
                if (!confirm(`Excluir ${ids.length} pedido(s)?`)) return;
                const localIds = ids.filter(id => (id||'').startsWith('local-'));
                const serverIds = ids.filter(id => !(id||'').startsWith('local-'));
                const localNums = [];
                if (localIds.length > 0) {
                    const arr = getLocalOrders();
                    localIds.forEach(id => {
                        const rec = arr.find(o => o.id === id);
                        if (rec && rec.numero_pedido) localNums.push(rec.numero_pedido);
                        removeLocalOrder(id);
                    });
                }
                if (serverIds.length > 0) {
                    let items = [];
                    try {
                        const { data: recs } = await supabase.from('controle_pedidos').select('id,numero_pedido,part_number').in('id', serverIds);
                        items = (recs||[]).map(r => ({ numero_pedido: r.numero_pedido, part_number: r.part_number })).filter(x => x.numero_pedido);
                    } catch {}
                    const { error } = await supabase.from('controle_pedidos').delete().in('id', serverIds);
                    if (error) { console.error('Erro ao excluir pedidos:', error); alert('Erro ao excluir no servidor.'); }
                    await clearDeleteRequestNotifications(items);
                    await notifyRequestersOfDeletion(items);
                }
                if (localNums.length > 0) await clearDeleteRequestNotifications(localNums.map(n => ({ numero_pedido: n })));
                if (localNums.length > 0) await notifyRequestersOfDeletion(localNums.map(n => ({ numero_pedido: n })));
                alert('Pedidos exclu√≠dos.');
                loadOrdersForDeletion();
                loadOrders();
                loadConsultantData();
                await refreshDeleteNotificationsIfCarlos();
            } catch (err) {
                console.error('Erro na exclus√£o em lote:', err);
            }
        }

        async function clearDeleteRequestNotifications(items) {
            try {
                const arr = (items||[]);
                const keys = arr.map(n => typeof n === 'object' ? buildNotifKey(n.numero_pedido||'', n.part_number||'') : buildNotifKey(n||'', '')).filter(Boolean);
                if (keys.length === 0) return;
                // atualizar perfil do carlos
                let carlos = null;
                try { const { data } = await supabase.from('profiles').select('*').eq('username','carlos.vinicius').single(); carlos = data; } catch {}
                if (carlos && carlos.id) {
                    let pJson = carlos.permissions ?? carlos.permissoes ?? {};
                    if (typeof pJson === 'string') { try { pJson = JSON.parse(pJson); } catch { pJson = {}; } }
                    const existing = Array.isArray(pJson.delete_requests) ? pJson.delete_requests : [];
                    const filtered = existing.filter(o => !keys.includes(buildNotifKey(o.numero_pedido||'', o.part_number||'')));
                    const next = { ...(pJson||{}), delete_requests: filtered };
                    try { await saveProfilePerms(carlos.id, next); } catch {}
                    try { setLocalPerm(carlos.id, next); } catch {}
                    const local = getLocalNotifs(carlos.id);
                    const localFiltered = local.filter(o => !keys.includes(buildNotifKey(o.numero_pedido||'', o.part_number||'')));
                    setLocalNotifs(carlos.id, localFiltered);
                }
                // atualizar perfil do thiago
                let thiago = null;
                try { const { data } = await supabase.from('profiles').select('*').eq('username','thiago.carmo').single(); thiago = data; } catch {}
                if (thiago && thiago.id) {
                    let pJsonT = thiago.permissions ?? thiago.permissoes ?? {};
                    if (typeof pJsonT === 'string') { try { pJsonT = JSON.parse(pJsonT); } catch { pJsonT = {}; } }
                    const existingT = Array.isArray(pJsonT.delete_requests) ? pJsonT.delete_requests : [];
                    const filteredT = existingT.filter(o => !keys.includes(buildNotifKey(o.numero_pedido||'', o.part_number||'')));
                    const nextT = { ...(pJsonT||{}), delete_requests: filteredT };
                    try { await saveProfilePerms(thiago.id, nextT); } catch {}
                    try { setLocalPerm(thiago.id, nextT); } catch {}
                    const localT = getLocalNotifs(thiago.id);
                    const localFilteredT = localT.filter(o => !keys.includes(buildNotifKey(o.numero_pedido||'', o.part_number||'')));
                    setLocalNotifs(thiago.id, localFilteredT);
                }
            } catch {}
        }

        async function notifyRequestersOfDeletion(items) {
            try {
                const arr = (items||[]);
                const keysFull = arr.map(n => typeof n === 'object' ? buildNotifKey(n.numero_pedido||'', n.part_number||'') : buildNotifKey(n||'', '')).filter(Boolean);
                const keysBare = arr.map(n => typeof n === 'object' ? buildNotifKey(n.numero_pedido||'', '') : buildNotifKey(n||'', '')).filter(Boolean);
                const keysSet = new Set([...keysFull, ...keysBare]);
                if (keysSet.size === 0) return;
                const { data: profiles } = await supabase.from('profiles').select('*');
                const updates = [];
                const emails = [];
                (profiles||[]).forEach(p => {
                    let obj = p.permissions ?? p.permissoes ?? {};
                    if (typeof obj === 'string') { try { obj = JSON.parse(obj); } catch { obj = {}; } }
                    const req = Array.isArray(obj.delete_requested) ? obj.delete_requested : [];
                    const affected = req.filter(r => keysSet.has(buildNotifKey(r.numero_pedido||'', r.part_number||'')) || keysSet.has(buildNotifKey(r.numero_pedido||'', '')));
                    if (!affected.length) return;
                    const nextReq = req.filter(r => !(keysSet.has(buildNotifKey(r.numero_pedido||'', r.part_number||'')) || keysSet.has(buildNotifKey(r.numero_pedido||'', ''))));
                    const done = Array.isArray(obj.delete_done) ? obj.delete_done : [];
                    const added = arr.map(n => ({ numero_pedido: (typeof n==='object'? normalizeOrderNum(n.numero_pedido||'') : normalizeOrderNum(n||'')), part_number: (typeof n==='object'? normalizePartNumber(n.part_number||'') : ''), done_at: new Date().toISOString() }));
                    const nextDone = [...done, ...added];
                    const nextObj = { ...(obj||{}), delete_requested: nextReq, delete_done: nextDone };
                    updates.push({ id: p.id, nextObj, affected });
                    const recEmail = (p && p.email) || '';
                    const list = affected.map(x => `${normalizeOrderNum(x.numero_pedido||'')}${(x.part_number||'') ? ' ('+normalizePartNumber(x.part_number||'')+')' : ''}`).filter(Boolean).join(', ');
                    if (recEmail && list) emails.push({ to: recEmail, list });
                });
                for (const u of updates) {
                    try { await saveProfilePerms(u.id, u.nextObj); } catch {}
                    try {
                        const local = getLocalNotifs(u.id) || [];
                        const affectedKeys = new Set([
                            ...u.affected.map(x => buildNotifKey(x.numero_pedido||'', x.part_number||'')),
                            ...u.affected.map(x => buildNotifKey(x.numero_pedido||'', ''))
                        ]);
                        const filtered = local.filter(o => !affectedKeys.has(buildNotifKey(o.numero_pedido||'', o.part_number||'')) && !affectedKeys.has(buildNotifKey(o.numero_pedido||'', '')));
                        setLocalNotifs(u.id, filtered);
                    } catch {}
                }
                if (emails.length > 0 && window.emailjs && emailjs.init) {
                    try { emailjs.init({ publicKey: (localStorage.getItem('emailjs_public_key') || 'TEMODpZYq_yR5526T') }); } catch {}
                    for (const em of emails) {
                        const msg = `<p>Prezados,</p><p>Suas solicita√ß√µes de exclus√£o foram atendidas.</p><p><strong>Pedidos exclu√≠dos:</strong> ${em.list}</p><p>Atenciosamente,<br>Sistema de Controle de Pedidos de Emerg√™ncia</p>`;
                        const params = { to_email: em.to, message_html: msg };
                        try { await emailjs.send((localStorage.getItem('emailjs_service_id') || 'service_25zhgag'), (localStorage.getItem('emailjs_template_id') || 'template_84afe3f'), params); } catch {}
                    }
                }
            } catch {}
        }
        
        // Load users for admin panel
        async function loadUsersForAdmin() {
            try {
                const permContainer = document.getElementById('permissions-container');
                if (permContainer && permContainer.childElementCount === 0) {
                    const items = Array.from(document.querySelectorAll('.menu-item'));
                    const keys = items.map(el => ({ key: el.getAttribute('data-permission-key'), label: el.querySelector('span')?.textContent || '' }))
                        .filter(x => x.key && x.key !== 'dashboard');
                    permContainer.innerHTML = keys.map(x => `<div><input type="checkbox" id="perm-${x.key}" value="${x.key}"><label for="perm-${x.key}">Acesso √† aba ${x.label}</label></div>`).join('');
                }
                let permitted = [];
                try {
                    const res1 = await supabase
                        .from('profiles')
                        .select('*')
                        .or('is_admin.eq.true,permissions.not.is.null,permissoes.not.is.null');
                    if (!res1.error) permitted = res1.data || [];
                    else {
                        console.error('Aviso: consulta sem coluna role:', res1.error);
                    }
                } catch (e) {
                    console.error('Aviso: fallback em consulta de permiss√µes:', e);
                }
                const { data: allUsers, error: aerr } = await supabase
                    .from('profiles')
                    .select('*');
                
                if (aerr) {
                    console.error('Erro ao carregar usu√°rios:', aerr);
                    return;
                }
                
                // Populate user select
                const userSelect = document.getElementById('user-select');
                userSelect.innerHTML = '<option value="">Selecione um usu√°rio</option>';
                
                allUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.username || user.name || user.user || user.email || user.id;
                    userSelect.appendChild(option);
                });

                // Render users table
                const tbody = document.querySelector('#users-permissions-table tbody');
                if (tbody) {
                    tbody.innerHTML = '';
                    const localPermitted = (allUsers || []).filter(u => {
                        const lp = getLocalPerm(u.id);
                        return lp && Object.keys(lp).length > 0;
                    });
                    const mergedMap = new Map();
                    (permitted || []).forEach(u => mergedMap.set(u.id, u));
                    localPermitted.forEach(u => { if (!mergedMap.has(u.id)) mergedMap.set(u.id, u); });
                    Array.from(mergedMap.values()).forEach(user => {
                        const tr = document.createElement('tr');
                        const uname = user.username || user.name || user.user || user.email || '';
                        const pRaw = user.permissions ?? user.permissoes ?? getLocalPerm(user.id) ?? {};
                        let p = pRaw;
                        if (typeof pRaw === 'string') { try { p = JSON.parse(pRaw); } catch { p = {}; } }
                        const isAdmin = (user.is_admin === true) || ((user.role || '').toLowerCase() === 'admin') || (uname.toLowerCase() === 'thiago.carmo');
                        const permsText = Object.keys(p||{}).filter(k => p[k]).join(', ');
                        tr.innerHTML = `
                            <td>${uname}</td>
                            <td>${permsText || '-'}</td>
                            <td>${isAdmin ? 'Sim' : 'N√£o'}</td>
                            <td>
                                <button class="btn btn-info" data-revoke="${user.id}" style="padding:5px 10px; font-size:14px; margin-right:8px;">Revogar Permiss√µes</button>
                                <button class="btn btn-danger" data-del="${user.id}" style="padding:5px 10px; font-size:14px;">Excluir Usu√°rio</button>
                            </td>`;
                        tbody.appendChild(tr);
                    });
                    // bind delete
                    tbody.querySelectorAll('button[data-del]').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const uid = e.currentTarget.getAttribute('data-del');
                            if (confirm('Tem certeza que deseja excluir este usu√°rio?')) {
                                await deleteUser(uid);
                            }
                        });
                    });
                    // bind revoke
                    tbody.querySelectorAll('button[data-revoke]').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const uid = e.currentTarget.getAttribute('data-revoke');
                            if (confirm('Revogar todas as permiss√µes deste usu√°rio?')) {
                                await revokePermissions(uid);
                            }
                        });
                    });
                }

                userSelect.addEventListener('change', async function() {
                    const uid = this.value;
                    const container = document.getElementById('permissions-container');
                    container.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; });
                    if (!uid) return;
                    const { data: row } = await supabase.from('profiles').select('*').eq('id', uid).single();
                    const pRaw = (row && (row.permissions ?? row.permissoes)) ?? getLocalPerm(uid) ?? {};
                    let p = pRaw; if (typeof pRaw === 'string') { try { p = JSON.parse(pRaw); } catch { p = {}; } }
                    const isAdm = (row && (row.is_admin === true || (row.role || '').toLowerCase() === 'admin')) || !!p.admin;
                    container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        if (cb.value === 'admin') cb.checked = !!isAdm; else cb.checked = !!p[cb.value];
                    });
                });
                
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
            }
        }

        async function deleteUser(userId) {
            try {
                const { error } = await supabase
                    .from('profiles')
                    .delete()
                    .eq('id', userId);
                if (error) {
                    console.error('Erro ao excluir usu√°rio:', error);
                    alert('Erro ao excluir usu√°rio.');
                    return;
                }
                alert('Usu√°rio exclu√≠do com sucesso.');
                loadUsersForAdmin();
            } catch (err) {
                console.error('Erro ao excluir usu√°rio:', err);
                alert('Erro ao excluir usu√°rio.');
            }
        }

        async function revokePermissions(userId) {
            try {
                let cleared = false;
                let lastError = null;
                const tryUpdate = async (obj) => {
                    const { error } = await supabase.from('profiles').update(obj).eq('id', userId);
                    if (!error) { cleared = true; } else { lastError = error; }
                };
                await tryUpdate({ permissions: null });
                if (!cleared) await tryUpdate({ permissoes: null });
                if (!cleared) await tryUpdate({ is_admin: false, role: 'user' });
                if (!cleared) {
                    removeLocalPerm(userId);
                    alert('Permiss√µes revogadas localmente.');
                } else {
                    alert('Permiss√µes revogadas com sucesso.');
                }
                loadUsersForAdmin();
            } catch (err) {
                console.error('Erro ao revogar permiss√µes:', err);
                alert('Erro ao revogar permiss√µes.');
            }
        }
        
        // Save new order
        newOrderForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            updateBoPrevFatFromForm();
            
            // Collect form data
            const formData = {
                revenda: toStr(document.getElementById('revenda').value),
                numero_pedido: toStr(document.getElementById('numero_pedido').value),
                fornecedor: toStr(document.getElementById('fornecedor').value),
                data_pedido: toStr(document.getElementById('data_pedido').value),
                cliente: toStr(document.getElementById('cliente').value),
                ctt_orc: toInt(document.getElementById('ctt_orc').value),
                part_number: toStr(document.getElementById('part_number').value),
                descricao: toStr(document.getElementById('descricao').value),
                qtde: toInt(document.getElementById('qtde').value),
                atd: toInt(document.getElementById('atd').value),
                bo: toInt(document.getElementById('bo').value),
                faturado: toStr(document.getElementById('faturado').value),
                prev_fat: toInt(document.getElementById('prev_fat').value),
                nf: toInt(document.getElementById('nf').value),
                custo_und: toFloat(document.getElementById('custo_und').value),
                custo_total: toFloat(document.getElementById('custo_total').value),
                transportadora: toStr(document.getElementById('transportadora').value),
                previsao: toStr(document.getElementById('previsao').value),
                chegada: toStr(document.getElementById('chegada').value),
                atraso: toInt(document.getElementById('atraso').value),
                lead_time: toInt(document.getElementById('lead_time').value),
                consultor: toStr(document.getElementById('consultor').value),
                obs: toStr(document.getElementById('obs').value),
                status: toStr(document.getElementById('status').value),
                tw_inicial: toInt(document.getElementById('tw_inicial').value),
                prev_atd: toStr(document.getElementById('prev_atd').value),
                tw_nova: toInt(document.getElementById('tw_nova').value),
                nova_prev_atd: toStr(document.getElementById('nova_prev_atd').value)
            };
            
            try {
                const payload = prepareForServerRow(formData);
                console.log('NEW ORDER PAYLOAD', payload);
                let { error } = await supabase
                    .from('controle_pedidos')
                    .insert([payload]);
                if (error) {
                    const bad = extractBigintErrorValue(error);
                    if (bad) {
                        const rows2 = sanitizeRowsForBigintError([payload], bad);
                        console.log('RETRY PAYLOAD AFTER BIGINT SANITIZE', rows2[0]);
                        const res2 = await supabase.from('controle_pedidos').insert(rows2);
                        error = res2.error;
                    }
                }
                if (error) {
                    const id = addLocalOrder(formData);
                    alert('Erro ao salvar no servidor: ' + (error.message || error.code || '')); 
                } else {
                    alert('Pedido salvo com sucesso!');
                    newOrderForm.reset();
                }
                
                // Reload data
                loadOrders();
                loadConsultantData();
                
            } catch (error) {
                addLocalOrder(formData);
                alert('Sem conex√£o com servidor. Pedido salvo localmente.');
                loadOrders();
                loadConsultantData();
            }
        });

        // Edit Order
        let currentEditId = null;
        function openEditModal(order) {
            currentEditId = order.id;
            document.getElementById('edit_revenda').value = order.revenda || '';
            document.getElementById('edit_numero_pedido').value = order.numero_pedido || '';
            document.getElementById('edit_fornecedor').value = order.fornecedor || '';
            document.getElementById('edit_data_pedido').value = order.data_pedido || '';
            document.getElementById('edit_cliente').value = order.cliente || '';
            document.getElementById('edit_ctt_orc').value = order.ctt_orc ?? '';
            document.getElementById('edit_part_number').value = order.part_number || '';
            document.getElementById('edit_descricao').value = order.descricao || '';
            document.getElementById('edit_qtde').value = order.qtde ?? '';
            document.getElementById('edit_atd').value = order.atd ?? '';
            document.getElementById('edit_bo').value = order.bo ?? '';
            document.getElementById('edit_faturado').value = order.faturado || '';
            document.getElementById('edit_prev_fat').value = order.prev_fat ?? '';
            document.getElementById('edit_nf').value = order.nf ?? '';
            document.getElementById('edit_custo_und').value = order.custo_und ?? '';
            document.getElementById('edit_custo_total').value = order.custo_total ?? '';
            document.getElementById('edit_transportadora').value = order.transportadora || '';
            document.getElementById('edit_previsao').value = order.previsao || '';
            document.getElementById('edit_chegada').value = order.chegada || '';
            document.getElementById('edit_atraso').value = order.atraso ?? '';
            document.getElementById('edit_lead_time').value = order.lead_time ?? '';
            document.getElementById('edit_consultor').value = order.consultor || '';
            document.getElementById('edit_obs').value = order.obs || '';
            document.getElementById('edit_tw_inicial').value = order.tw_inicial ?? '';
            document.getElementById('edit_prev_atd').value = order.prev_atd || '';
            document.getElementById('edit_tw_nova').value = order.tw_nova ?? '';
            document.getElementById('edit_nova_prev_atd').value = order.nova_prev_atd || '';
            document.getElementById('edit_status').value = order.status || '';
            updateBoPrevFatFromEdit();
            updateEditCustoTotal();
            editModal.style.display = 'flex';
        }

        function updateBoPrevFatFromEdit() {
            const qtdeEl = document.getElementById('edit_qtde');
            const atdEl = document.getElementById('edit_atd');
            const boEl = document.getElementById('edit_bo');
            const dataEl = document.getElementById('edit_data_pedido');
            const fatEl = document.getElementById('edit_faturado');
            const prevFatEl = document.getElementById('edit_prev_fat');
            const order = {
                qtde: qtdeEl?.value,
                atd: atdEl?.value,
                data_pedido: dataEl?.value,
                faturado: fatEl?.value
            };
            const boVal = computeBO(order);
            setSignValue(boEl, boVal);
            const pfVal = computePrevFat(order);
            setSignValue(prevFatEl, pfVal);
        }

        function updateEditCustoTotal() {
            const qtdeEl = document.getElementById('edit_qtde');
            const undEl = document.getElementById('edit_custo_und');
            const totalEl = document.getElementById('edit_custo_total');
            const q = toInt(qtdeEl?.value);
            const u = toFloat(undEl?.value);
            if (q != null && u != null) {
                totalEl.value = Number((q * u).toFixed(2));
            } else {
                totalEl.value = '';
            }
        }

        closeEditModal?.addEventListener('click', function(){ editModal.style.display = 'none'; currentEditId = null; });
        ['qtde','atd','data_pedido','faturado'].forEach(id => document.getElementById(id)?.addEventListener('input', updateBoPrevFatFromForm));
        ['edit_qtde','edit_atd','edit_data_pedido','edit_faturado'].forEach(id => document.getElementById(id)?.addEventListener('input', updateBoPrevFatFromEdit));
        ['edit_qtde','edit_custo_und'].forEach(id => document.getElementById(id)?.addEventListener('input', updateEditCustoTotal));
        saveEditBtn?.addEventListener('click', async function(){
            if (!currentEditId) { alert('Pedido inv√°lido.'); return; }
            const payload = {
                revenda: toStr(document.getElementById('edit_revenda').value),
                numero_pedido: toStr(document.getElementById('edit_numero_pedido').value),
                fornecedor: toStr(document.getElementById('edit_fornecedor').value),
                data_pedido: normalizeDateToISO(toStr(document.getElementById('edit_data_pedido').value)),
                cliente: toStr(document.getElementById('edit_cliente').value),
                ctt_orc: toInt(document.getElementById('edit_ctt_orc').value),
                part_number: toStr(document.getElementById('edit_part_number').value),
                descricao: toStr(document.getElementById('edit_descricao').value),
                qtde: toInt(document.getElementById('edit_qtde').value),
                atd: toInt(document.getElementById('edit_atd').value),
                bo: toInt(document.getElementById('edit_bo').value),
                faturado: normalizeDateToISO(toStr(document.getElementById('edit_faturado').value)),
                prev_fat: toInt(document.getElementById('edit_prev_fat').value),
                nf: toInt(document.getElementById('edit_nf').value),
                custo_und: toFloat(document.getElementById('edit_custo_und').value),
                custo_total: toFloat(document.getElementById('edit_custo_total').value),
                transportadora: toStr(document.getElementById('edit_transportadora').value),
                previsao: normalizeDateToISO(toStr(document.getElementById('edit_previsao').value)),
                chegada: normalizeDateToISO(toStr(document.getElementById('edit_chegada').value)),
                atraso: toInt(document.getElementById('edit_atraso').value),
                lead_time: toInt(document.getElementById('edit_lead_time').value),
                consultor: toStr(document.getElementById('edit_consultor').value),
                obs: toStr(document.getElementById('edit_obs').value),
                status: toStr(document.getElementById('edit_status').value),
                tw_inicial: toInt(document.getElementById('edit_tw_inicial').value),
                prev_atd: normalizeDateToISO(toStr(document.getElementById('edit_prev_atd').value)),
                tw_nova: toInt(document.getElementById('edit_tw_nova').value),
                nova_prev_atd: normalizeDateToISO(toStr(document.getElementById('edit_nova_prev_atd').value))
            };
            try {
                if ((currentEditId || '').startsWith('local-')) {
                    updateLocalOrder(currentEditId, payload);
                    alert('Pedido local atualizado.');
                } else {
                    const serverPayload = prepareForServerRow(payload);
                    let { error } = await supabase.from('controle_pedidos').update(serverPayload).eq('id', currentEditId);
                    if (error) {
                        const bad = extractBigintErrorValue(error);
                        if (bad) {
                            const rows2 = sanitizeRowsForBigintError([serverPayload], bad);
                            const res2 = await supabase.from('controle_pedidos').update(rows2[0]).eq('id', currentEditId);
                            error = res2.error;
                        }
                    }
                    if (error) { console.error('Erro ao atualizar pedido:', error); alert('Erro ao atualizar pedido.'); return; }
                    alert('Pedido atualizado com sucesso!');
                }
                editModal.style.display = 'none';
                currentEditId = null;
                loadOrders();
                loadConsultantData();
            } catch (err) { console.error('Erro ao atualizar pedido:', err); alert('Erro ao atualizar pedido.'); }
        });

        // Change Password Modal
        function openChangePasswordModal() {
            let modal = document.getElementById('changePasswordModal');
            if (!modal) {
                const wrap = document.createElement('div');
                wrap.id = 'changePasswordModal';
                wrap.className = 'support-modal';
                wrap.innerHTML = `
                    <div class="support-content" style="max-width:520px;">
                        <h2 class="support-title">Alterar Senha</h2>
                        <div class="form-container">
                            <div class="form-row">
                                <div class="form-field"><label for="new_password">Nova Senha</label><input id="new_password" class="form-control" type="password"></div>
                                <div class="form-field"><label for="confirm_password">Confirmar</label><input id="confirm_password" class="form-control" type="password"></div>
                            </div>
                            <div class="form-actions" style="text-align:right; margin-top:12px;">
                                <button class="btn btn-primary" id="change_password_save">Salvar</button>
                                <button class="btn btn-danger" id="change_password_close">Fechar</button>
                            </div>
                        </div>
                    </div>`;
                document.body.appendChild(wrap);
                document.getElementById('change_password_close').addEventListener('click', () => { wrap.style.display = 'none'; });
                document.getElementById('change_password_save').addEventListener('click', async () => {
                    const np = document.getElementById('new_password').value || '';
                    const cp = document.getElementById('confirm_password').value || '';
                    if (!np || np !== cp) { alert('Senhas n√£o conferem'); return; }
                    try {
                        if (supabase && currentUser?.id) {
                            const { error: aerr } = await supabase.auth.updateUser({ password: np });
                            if (aerr) { alert('Erro ao atualizar senha: '+(aerr.message||'')); return; }
                            const { data: row } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
                            let pJson = row?.permissions ?? row?.permissoes ?? {};
                            if (typeof pJson === 'string') { try { pJson = JSON.parse(pJson); } catch { pJson = {}; } }
                            const newPerm = { ...(pJson||{}), must_change_password: false };
                            let ok = false;
                            const { error: e1 } = await supabase.from('profiles').update({ permissions: newPerm }).eq('id', currentUser.id);
                            if (!e1) ok = true; else {
                                const { error: e2 } = await supabase.from('profiles').update({ permissoes: JSON.stringify(newPerm) }).eq('id', currentUser.id);
                                if (!e2) ok = true;
                            }
                            if (ok) { alert('Senha atualizada'); wrap.style.display = 'none'; }
                            else { alert('Erro ao salvar senha'); }
                        } else { wrap.style.display = 'none'; }
                    } catch { alert('Erro ao salvar senha'); }
                });
            }
            modal = document.getElementById('changePasswordModal');
            modal.style.display = 'flex';
        }
        
        // Save permissions
        document.getElementById('save-permissions').addEventListener('click', async function() {
            const userId = document.getElementById('user-select').value;
            
            if (!userId) {
                alert('Por favor, selecione um usu√°rio.');
                return;
            }
            
            const permissions = {};
            document.querySelectorAll('#permissions-container input[type="checkbox"]').forEach(cb => { permissions[cb.value] = cb.checked; });
            
            try {
                const { data: userRow, error: fetchErr } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                if (fetchErr) {
                    console.error('Erro ao buscar usu√°rio:', fetchErr);
                    alert('Erro ao buscar usu√°rio.');
                    return;
                }
                let updated = false;
                let lastError = null;
                const tryUpdate = async (obj) => {
                    const { error } = await supabase.from('profiles').update(obj).eq('id', userId);
                    if (!error) { updated = true; }
                    else { lastError = error; }
                };
                await tryUpdate({ permissions });
                if (!updated) await tryUpdate({ permissoes: JSON.stringify(permissions) });
                if (!updated) await tryUpdate({ is_admin: !!permissions.admin, role: permissions.admin ? 'admin' : 'user' });
                if (!updated) {
                    setLocalPerm(userId, permissions);
                    alert('Permiss√µes salvas localmente.');
                    loadUsersForAdmin();
                    return;
                }
                
                if (error) {
                    console.error('Erro ao salvar permiss√µes:', error);
                    alert('Erro ao salvar permiss√µes.');
                    return;
                }
                
                alert('Permiss√µes salvas com sucesso!');
                loadUsersForAdmin();
                
            } catch (error) {
                console.error('Erro ao salvar permiss√µes:', error);
                alert('Erro ao salvar permiss√µes.');
            }
        });
        
        // Apply filters for orders
        // Clear filters for orders
        document.getElementById('clear-filters').addEventListener('click', function() {
            // Reset all filter inputs
            document.getElementById('year-filter').value = '';
            document.getElementById('month-filter').value = '';
            document.getElementById('order-number-filter').value = '';
            document.getElementById('part-number-filter').value = '';
            document.getElementById('date-filter').value = '';
            document.getElementById('tw-filter').value = '';
            document.getElementById('consultant-filter').value = '';
            document.getElementById('client-filter').value = '';
            document.getElementById('supplier-filter').value = '';
            document.getElementById('nf-filter').value = '';
            document.getElementById('shipping-filter').value = '';
            document.getElementById('revenda-filter').value = '';
            document.getElementById('status-filter').value = '';
            loadOrders();
        });

        // Apply/Clear filters for consultant
        document.getElementById('consultant-clear-filters').addEventListener('click', function() {
            document.getElementById('consultant-year-filter').value = '';
            document.getElementById('consultant-month-filter').value = '';
            document.getElementById('consultant-order-number-filter').value = '';
            document.getElementById('consultant-part-number-filter').value = '';
            document.getElementById('consultant-date-filter').value = '';
            document.getElementById('consultant-tw-filter').value = '';
            document.getElementById('consultant-consultant-filter').value = '';
            document.getElementById('consultant-client-filter').value = '';
            document.getElementById('consultant-supplier-filter').value = '';
            document.getElementById('consultant-nf-filter').value = '';
            document.getElementById('consultant-revenda-filter').value = '';
            document.getElementById('consultant-status-filter').value = '';
            loadConsultantData();
        });

        // Apply/Clear filters for delete
        document.getElementById('delete-clear-filters').addEventListener('click', function() {
            document.getElementById('delete-year-filter').value = '';
            document.getElementById('delete-month-filter').value = '';
            document.getElementById('delete-order-number-filter').value = '';
            document.getElementById('delete-part-number-filter').value = '';
            document.getElementById('delete-date-filter').value = '';
            document.getElementById('delete-revenda-filter').value = '';
            document.getElementById('delete-nf-filter').value = '';
            document.getElementById('delete-status-filter').value = '';
            loadOrdersForDeletion();
        });
        document.getElementById('delete-bulk-btn')?.addEventListener('click', function() {
            deleteSelectedOrders();
        });

        document.getElementById('reqdel-clear-filters')?.addEventListener('click', function() {
            const ids = ['reqdel-year-filter','reqdel-month-filter','reqdel-order-number-filter','reqdel-part-number-filter','reqdel-date-filter','reqdel-revenda-filter','reqdel-nf-filter','reqdel-status-filter'];
            ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
            loadOrdersForDeleteRequest();
        });
        document.getElementById('request-delete-send-btn')?.addEventListener('click', sendDeleteRequestEmail);

        (function(){
            const on = (id, evt, fn) => { const el = document.getElementById(id); if (el) el.addEventListener(evt, fn); };
            ['year-filter','month-filter','date-filter','shipping-filter','revenda-filter','status-filter']
                .forEach(id => on(id, 'change', () => loadOrders()));
            ['order-number-filter','part-number-filter','nf-filter','tw-filter','consultant-filter','client-filter','supplier-filter']
                .forEach(id => on(id, 'input', () => loadOrders()));
            ['consultant-year-filter','consultant-month-filter','consultant-date-filter','consultant-revenda-filter','consultant-status-filter']
                .forEach(id => on(id, 'change', () => loadConsultantData()));
            ['consultant-order-number-filter','consultant-part-number-filter','consultant-nf-filter','consultant-tw-filter','consultant-consultant-filter','consultant-client-filter','consultant-supplier-filter']
                .forEach(id => on(id, 'input', () => loadConsultantData()));
            ['delete-year-filter','delete-month-filter','delete-date-filter','delete-revenda-filter','delete-status-filter']
                .forEach(id => on(id, 'change', () => loadOrdersForDeletion()));
            ['delete-order-number-filter','delete-part-number-filter','delete-nf-filter']
                .forEach(id => on(id, 'input', () => loadOrdersForDeletion()));

            ['reqdel-year-filter','reqdel-month-filter','reqdel-date-filter','reqdel-revenda-filter','reqdel-status-filter']
                .forEach(id => on(id, 'change', () => loadOrdersForDeleteRequest()));
            ['reqdel-order-number-filter','reqdel-part-number-filter','reqdel-nf-filter']
                .forEach(id => on(id, 'input', () => loadOrdersForDeleteRequest()));

            ['dash-year-filter','dash-month-filter','dash-revenda-filter','dash-status-filter','dash-shipping-filter']
                .forEach(id => on(id, 'change', () => loadDashboard()));
            ['dash-client-filter']
                .forEach(id => on(id, 'input', () => loadDashboard()));
            ['arrival-year-filter','arrival-month-filter','arrival-date-filter','arrival-revenda-filter','arrival-status-filter']
                .forEach(id => on(id, 'change', () => loadArrivalParts()));
            ['arrival-order-number-filter','arrival-part-number-filter','arrival-nf-filter','arrival-consultant-filter','arrival-client-filter','arrival-supplier-filter']
                .forEach(id => on(id, 'input', () => loadArrivalParts()));
            on('arrival-clear-filters', 'click', () => { ['arrival-year-filter','arrival-month-filter','arrival-order-number-filter','arrival-part-number-filter','arrival-date-filter','arrival-consultant-filter','arrival-client-filter','arrival-supplier-filter','arrival-nf-filter','arrival-revenda-filter','arrival-status-filter'].forEach(id => { const el = document.getElementById(id); if (!el) return; if (el.tagName === 'SELECT') el.value = ''; else el.value=''; }); loadArrivalParts(); });
            on('arrival-select-all', 'click', () => { Array.from(document.querySelectorAll('#arrival-table tbody input.arrival-select')).forEach(cb => { cb.checked = true; }); });
            on('arrival-send-email', 'click', () => { sendArrivalEmail(); });
        })();

        // Permissions
        function applyPermissions() {
            const pRawAny = currentUser && (currentUser.permissions ?? currentUser.permissoes ?? getLocalPerm(getUserKey(currentUser)));
            let p = pRawAny || {};
            if (typeof p === 'string') { try { p = JSON.parse(p); } catch { p = {}; } }
            const unameRaw = (currentUser && (currentUser.username || currentUser.user || currentUser.name) || '');
            const uname = unameRaw.trim().toLowerCase();
            const emailLocal = ((currentUser && currentUser.email) || '').split('@')[0].trim().toLowerCase();
            const isAdminUser = currentUser && (currentUser.is_admin === true || (currentUser.role || '').toLowerCase() === 'admin' || uname === 'thiago.carmo' || emailLocal === 'thiago.carmo');
            // fallback: se n√£o houver permiss√µes salvas, libera todas as abas exceto admin
            const isEmptyPerms = !p || (typeof p === 'object' && Object.keys(p).length === 0);
            const defaultPerms = { orders: true, consultant: true, arrival: true, new_order: true, delete_order: true, request_delete: true, admin: false };
            if (!isAdminUser && isEmptyPerms) p = defaultPerms;
            const items = Array.from(document.querySelectorAll('.menu-item'));
            items.forEach(el => {
                const tab = el.getAttribute('data-tab');
                const key = el.getAttribute('data-permission-key');
                const always = tab === 'dashboard-tab';
                const isAdminTab = tab === 'admin-tab';
                const byPerm = key ? (p.hasOwnProperty(key) ? !!p[key] : true) : true;
                const carlosOverride = (uname === 'carlos.vinicius');
                const allowed = isAdminTab ? isAdminUser : (isAdminUser || always || byPerm || carlosOverride);
                el.style.display = allowed ? '' : 'none';
            });
            refreshDeleteNotificationsIfCarlos();
        }
    </script>
</body>
</html>
